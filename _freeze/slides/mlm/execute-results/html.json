{
  "hash": "8b85b0b50ae99d066d02993611c3b102",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Multilevel Models\"\ndate-modified: last-modified\nformat: metropolis-revealjs\n---\n\n\n\n::: {.cell}\n\n:::\n\n\n\n## Guiding Questions\n\n- What is *hierarchical/multilevel models (MLMs)*?\n- How to fit Bayesian multilevel models?\n- What are the advantages of MLM?\n- How to allow *separate regression lines* for many groups/clusters?\n    * Varying intercepts and slopes (and variances)\n    * Interpretations\n\n## Multilevel Models\n\n- Discovered in different disciplines separately\n    * Mixed/mixed-effect models\n    * Hierarchical linear models\n    * Variance component models\n\n. . .\n\n- A flexible class of models to handle clustered (dependent) data\n    * Extremely common in the behavioral and social sciences\n\n## MLM\n\n::: {.callout-tip appearance=\"simple\"}\n\n## MLM subsumes\n\n- Dependent-sample $t$-test\n- Random-effect ANOVA\n- Repeated-measure ANOVA\n- Variance components models\n- Growth curve models\n- Generalizability theory\n- Random-effect meta-analysis\n\n:::\n\n. . .\n\n- Build cluster-specific regression/other types of models \n- Borrow information across clusters\n- Include higher-level predictors\n\n## Multilevel Data Structures\n\n- Hierarchical/Nested\n    * Students in schools\n    * Clients nested within therapists within clinics\n    * Employees nested within organizations\n    * Citizens nested within employees\n    * Repeated measures nested within persons\n\n![](../usc-psyc573-notes/images/nested.png){width='100%' fig-align=\"center\"}\n\n## Multilevel Data Structures (Cont'd)\n\n- Crossed\n    * Students cross-classified by high schools and middle schools\n    * Responses cross-classified by items and persons\n\n![](../usc-psyc573-notes/images/crossed.png){width='80%' fig-align=\"center\"}\n\n## Quantifying Dependence\n\n- Intraclass correlation (ICC): $\\rho = \\dfrac{\\tau^2}{\\tau^2 + \\sigma^2}$\n    * Analogous to $\\eta^2$/$R^2$ effect size\n\n::: {.callout-important appearance=\"simple\"}\n\n## ICC\n\nThe proportion of variance of the outcome that are due to between-level (e.g., between-group, between-person) differences\n\n:::\n\n\n\n::: {.cell layout-ncol=\"3\" layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-3-1.png){fig-align='center' width=240}\n:::\n\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-3-2.png){fig-align='center' width=240}\n:::\n\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-3-3.png){fig-align='center' width=240}\n:::\n:::\n\n\n\n## Data\n\n:::: {.columns}\n\n::: {.column width=\"50%\"}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(sleepstudy, package = \"lme4\")\nhead(sleepstudy)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Reaction Days Subject\n1      250    0     308\n2      259    1     308\n3      251    2     308\n4      321    3     308\n5      357    4     308\n6      415    5     308\n```\n\n\n:::\n:::\n\n\n\n:::\n\n::: {.column width=\"50%\"}\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n?lme4::sleepstudy\nhist(sleepstudy$Reaction)\n```\n\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n\n:::\n\n::::\n\n## Trajectories\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-6-1.png){width=960}\n:::\n:::\n\n\n\n## ICC of `Reaction`\n\n- Varying/Random intercept model\n\n$$\n\\begin{aligned}\n  \\text{Reaction}_{ij} & \\sim N(\\mu_j, \\sigma)  \\\\\n  \\mu_j & \\sim N(\\gamma, \\tau)\n\\end{aligned}\n$$\n\n- $\\mu_j$: mean reaction for the $j$th person\n- $i$ indexes measurement occasions\n\n---\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|variable              | median|   mad|    q5|   q95|\n|:---------------------|------:|-----:|-----:|-----:|\n|b_Intercept           |  29.80| 0.953| 28.14| 31.44|\n|sd_Subject__Intercept |   3.81| 0.761|  2.77|  5.58|\n|sigma                 |   4.44| 0.250|  4.05|  4.87|\n\n\n:::\n:::\n\n\n\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-10-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n\n::: {.callout-note}\n\n## Interpretations\n\n\n\n\n\n\n\n\n\nThe model suggested that the average reaction time across individuals and measurement occasions was 298ms, 90% CI [281ms, 314ms]. It was estimated that 43.22%, 90% CI [27.12%, 61.31%] of the variations in reaction time was attributed to between-person differences.\n\n:::\n\n## Regression for One Person (308)\n\n$$\n\\begin{aligned}\n  \\text{Reaction10}_i & \\sim N(\\mu_i, \\sigma)  \\\\\n  \\mu_i & = \\beta_0 + \\beta_1 \\texttt{Days}_i\n\\end{aligned}\n$$\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-13-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n## Varying Coefficients\n\nIn MLM, parameters ($\\beta_0$, $\\beta_1$, $\\sigma$) can be\n\n- different across clusters (persons)\n- be estimated by partial pooling\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-15-1.png){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Varying Intercepts\n\nRepeated-measure level:\n\n$$\n\\begin{aligned}\n  \\text{Reaction10}_{ij} & \\sim N(\\mu_{ij}, \\sigma)  \\\\\n  \\mu_{ij} & = \\beta_{0j} + \\beta_{1} \\text{Days}_{ij}  \\\\\n\\end{aligned}\n$$\n\nPerson level:\n\n$$\n\\begin{aligned}\n  \\beta_{0j} & \\sim N(\\mu^{[\\beta_0]}, \\tau^{[\\beta_0]})  \\\\\n\\end{aligned}\n$$\n\nPriors:\n\n$$\n\\begin{aligned}\n  \\mu^{[\\beta_0]} & \\sim N(0, 50) \\\\\n  \\tau^{[\\beta_0]} & \\sim \\mathrm{Gamma}(2, 0.2) \\\\\n  \\beta_1 & \\sim N(0, 10) \\\\\n  \\sigma & \\sim t^+(4, 0, 5)\n\\end{aligned}\n$$\n\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm3 <- brm(Reaction10 ~ Days + (1 | Subject),\n    data = sleepstudy,\n    prior = c( # for intercept\n        prior(normal(0, 50), class = \"Intercept\"),\n        # for slope\n        prior(normal(0, 10), class = \"b\"),\n        # for tau\n        prior(gamma(2, 0.2), class = \"sd\"),\n        # for sigma\n        prior(student_t(4, 0, 5), class = \"sigma\")\n    ),\n    control = list(adapt_delta = .95),\n    seed = 2107,\n    file = \"11_m3\"\n)\n```\n:::\n\n\n\n---\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|variable              | median|   mad|     q5|   q95|\n|:---------------------|------:|-----:|------:|-----:|\n|b_Intercept           |  25.23| 1.054| 23.552| 26.93|\n|b_Days                |   1.05| 0.081|  0.915|  1.18|\n|sd_Subject__Intercept |   3.98| 0.745|  2.972|  5.64|\n|sigma                 |   3.11| 0.166|  2.855|  3.42|\n\n\n:::\n:::\n\n\n\n## Overall Fit\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-18-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n## Fit to Individuals\n\nRemember: The model assumes equal slopes for each person\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-19-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n## Varying Slopes\n\nRepeated-measure level:\n\n$$\n\\begin{aligned}\n  \\text{Reaction10}_{ij} & \\sim N(\\mu_{ij}, \\sigma)  \\\\\n  \\mu_{ij} & = \\beta_{0j} + \\beta_{1j} \\text{Days}_{ij}  \\\\\n\\end{aligned}\n$$\n\nPerson level:\n\n$$\n\\begin{aligned}\n  \\begin{bmatrix}\n    \\beta_{0j} \\\\\n    \\beta_{1j} \\\\\n  \\end{bmatrix} & \\sim N_2\\left(\n    \\begin{bmatrix}\n      \\mu^{[\\beta_0]} \\\\\n      \\mu^{[\\beta_1]} \\\\\n    \\end{bmatrix}, \\mathbf T\n    \\right) \\\\\n    \\mathbf T & = \\begin{bmatrix}\n      {\\tau^{[\\beta_0]}}^2 & \\\\\n      \\tau^{\\beta{10}} & {\\tau^{[\\beta_1]}}^2 \\\\\n    \\end{bmatrix}\n\\end{aligned}\n$$\n\n## LKJ Prior\n\n::: {.callout-note}\n\n## Decomposing Covariance Matrix\n\n- Covariance = *SD* $\\times$ Correlation $\\times$ *SD*\n\n$$\n\\mathbf T = \\mathrm{diag}(\\boldsymbol{\\tau}) \\boldsymbol{\\Omega} \\mathrm{diag}(\\boldsymbol{\\tau})\n$$\n\n:::\n\nShape parameter $\\eta$\n\n$$\nP(\\boldsymbol{\\Omega} | \\eta) \\propto \\det(\\boldsymbol{\\Omega})^{\\eta - 1}\n$$\n\n---\n\n- $\\eta = 1$: Uniform\n- $\\eta \\geq 1$: increasingly concentrated to zero correlations\n- $\\eta \\leq 1$: more correlations closer to 1\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-20-1.png){width=960}\n:::\n:::\n\n\n\n## Priors\n\n$$\n\\begin{aligned}\n  \\mu^{[\\beta_0]} & \\sim N(0, 50) \\\\\n  \\mu^{[\\beta_1]} & \\sim N(0, 10) \\\\\n  \\tau^{[\\beta_m]} & \\sim \\mathrm{Gamma}(2, 0.2), \\; m = 0, 1 \\\\\n  \\boldsymbol{\\Omega} & \\sim \\mathrm{LKJ}(1) \\\\\n  \\sigma & \\sim t^+(4, 0, 5)\n\\end{aligned}\n$$\n\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm4 <- brm(Reaction10 ~ Days + (Days | Subject),\n    data = sleepstudy,\n    prior = c( # for intercept\n        prior(normal(0, 50), class = \"Intercept\"),\n        # for slope\n        prior(normal(0, 10), class = \"b\"),\n        # for tau_beta0 and tau_beta1\n        prior(gamma(2, 0.2), class = \"sd\", group = \"Subject\"),\n        # for correlation\n        prior(lkj(1), class = \"cor\"),\n        # for sigma\n        prior(student_t(4, 0, 5), class = \"sigma\")\n    ),\n    control = list(adapt_delta = .95),\n    seed = 2107,\n    file = \"11_m4\"\n)\n```\n:::\n\n\n\n---\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|variable                     | median|   mad|     q5|   q95|\n|:----------------------------|------:|-----:|------:|-----:|\n|b_Intercept                  | 25.122| 0.731| 23.835| 26.39|\n|b_Days                       |  1.036| 0.167|  0.765|  1.34|\n|sd_Subject__Intercept        |  2.755| 0.671|  1.806|  4.09|\n|sd_Subject__Days             |  0.666| 0.146|  0.468|  1.00|\n|cor_Subject__Intercept__Days |  0.058| 0.327| -0.450|  0.58|\n|sigma                        |  2.582| 0.157|  2.339|  2.87|\n\n\n:::\n:::\n\n\n\n## Fit to Individuals\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-23-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n## Varying Regression Lines\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-24-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n## Interpretations\n\n\n\n\n\n\n\n::: {.callout-important appearance=\"minimal\"}\n\n## $\\beta_0$\n\nBased on the model, at Day 0, the average reaction time across individuals was 251ms, 90% CI [238ms, 264ms], and the *SD* at Day 0 was 28.318ms, 95% CI [18.061ms, 40.863ms].\n\n:::\n\n::: {.callout-important appearance=\"minimal\"}\n\n## $\\beta_1$\n\nThe average rate of change per day in reaction time across individuals was 10ms, 90% CI [7.6ms, 13ms], and the *SD* of the rates of change at Day 0 was 6.901ms, 95% CI [4.681ms, 10.049ms].\n\n:::\n\n## Random $\\sigma$\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](mlm_files/figure-revealjs/unnamed-chunk-27-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n## Comparing Models {.smaller}\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> effect </th>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\">  Var Int </th>\n   <th style=\"text-align:center;\">  Var Slp </th>\n   <th style=\"text-align:center;\">  Var \\(\\sigma\\) </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> fixed </td>\n   <td style=\"text-align:left;\"> \\(\\mu^{[\\beta_0]}\\) </td>\n   <td style=\"text-align:center;\"> 25.23 [23.16, 27.27] </td>\n   <td style=\"text-align:center;\"> 25.12 [23.55, 26.66] </td>\n   <td style=\"text-align:center;\"> 25.11 [23.52, 26.77] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> \\(\\mu^{[\\beta_1]}\\) </td>\n   <td style=\"text-align:center;\"> 1.05 [0.89, 1.21] </td>\n   <td style=\"text-align:center;\"> 1.04 [0.70, 1.41] </td>\n   <td style=\"text-align:center;\"> 1.04 [0.70, 1.40] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> \\(\\sigma\\) </td>\n   <td style=\"text-align:center;\"> 3.11 [2.81, 3.49] </td>\n   <td style=\"text-align:center;\"> 2.58 [2.29, 2.92] </td>\n   <td style=\"text-align:center;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> \\(\\mu^{[\\sigma]}\\) </td>\n   <td style=\"text-align:center;\">  </td>\n   <td style=\"text-align:center;\">  </td>\n   <td style=\"text-align:center;\"> 0.73 [0.44, 1.02] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> random </td>\n   <td style=\"text-align:left;\"> \\(\\tau^{[\\beta_0]}\\) </td>\n   <td style=\"text-align:center;\"> 3.98 [2.85, 6.04] </td>\n   <td style=\"text-align:center;\"> 2.75 [1.68, 4.41] </td>\n   <td style=\"text-align:center;\"> 3.06 [2.06, 4.87] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> \\(\\tau^{[\\beta_1]}\\) </td>\n   <td style=\"text-align:center;\">  </td>\n   <td style=\"text-align:center;\"> 0.67 [0.44, 1.09] </td>\n   <td style=\"text-align:center;\"> 0.68 [0.46, 1.07] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;box-shadow: 0px 1.5px\">  </td>\n   <td style=\"text-align:left;box-shadow: 0px 1.5px\"> \\(\\tau^{[\\sigma]}\\) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\">  </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\">  </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> 0.49 [0.31, 0.79] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> Num.Obs. </td>\n   <td style=\"text-align:center;\"> 180 </td>\n   <td style=\"text-align:center;\"> 180 </td>\n   <td style=\"text-align:center;\"> 180 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> ELPD </td>\n   <td style=\"text-align:center;\"> −470.0 </td>\n   <td style=\"text-align:center;\"> −447.0 </td>\n   <td style=\"text-align:center;\"> −418.5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> ELPD s.e. </td>\n   <td style=\"text-align:center;\"> 14.3 </td>\n   <td style=\"text-align:center;\"> 22.7 </td>\n   <td style=\"text-align:center;\"> 13.4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> LOOIC </td>\n   <td style=\"text-align:center;\"> 940.0 </td>\n   <td style=\"text-align:center;\"> 894.0 </td>\n   <td style=\"text-align:center;\"> 837.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> LOOIC s.e. </td>\n   <td style=\"text-align:center;\"> 28.6 </td>\n   <td style=\"text-align:center;\"> 45.5 </td>\n   <td style=\"text-align:center;\"> 26.8 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> WAIC </td>\n   <td style=\"text-align:center;\"> 939.5 </td>\n   <td style=\"text-align:center;\"> 891.0 </td>\n   <td style=\"text-align:center;\"> 827.6 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## Many More Topics in MLM\n\n- Adding higher-level predictors\n- Cross-level interactions\n- Decomposing effects and the ecological fallacy\n- Categorical outcomes (i.e., generalized linear mixed model, GLMM)\n- Complex data structures (e.g., 3-level, crossed)\n- And more . . . Check out MLM classes on campus\n",
    "supporting": [
      "mlm_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}