<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.33">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>16&nbsp; Gibbs Sampling – PSYC 573 Bayesian Data Analysis (2024 Fall): Course Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./09c-hmc.html" rel="next">
<link href="./09-mcmc.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-07ba0ad10f5680c660e360ac31d2f3b6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6d9163938730c4bb45bb2ddd9242afb9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-225295148', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">PSYC 573 Bayesian Data Analysis (2024 Fall): Course Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="./../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../modules.html"> 
<span class="menu-text">Modules</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../docs/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../exercises/index.html"> 
<span class="menu-text">Exercises</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../syllabus/index.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/marklhc/usc-psyc573-notes" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./PSYC-573-Bayesian-Data-Analysis--2024-Fall---Course-Notes.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./09-mcmc.html">Week 10–11</a></li><li class="breadcrumb-item"><a href="./09b-gibbs.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Gibbs Sampling</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-probability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Probability</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-bayes-theorem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayes’s Theorem</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 3</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-beta-bernoulli-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Beta-Bernoulli Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04b-beta-bernoulli-stan.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Beta-Bernoulli Model With Stan</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04c-poisson-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Poisson Model</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 4</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-hierarchical-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Hierarchical Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 5–6</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-linear-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Linear Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06b-multiple-predictors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Multiple Predictors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06c-regression-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model Diagnostics</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 7</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-model-comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Model Comparison</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07b-stacking-and-regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Stacking, Regularization, and Variable Selection</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 9</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-causal-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Causal Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08b-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Mediation</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 10–11</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09b-gibbs.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Gibbs Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09c-hmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Hamiltonian Monte Carlo</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 12</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-glm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Generalized Linear Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10b-glm2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Generalized Linear Model (II)</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data"><span class="header-section-number">16.1</span> Data</a></li>
  <li><a href="#the-normal-model" id="toc-the-normal-model" class="nav-link" data-scroll-target="#the-normal-model"><span class="header-section-number">16.2</span> The Normal Model</a></li>
  <li>
<a href="#conjugate-actually-semiconjugate-priors" id="toc-conjugate-actually-semiconjugate-priors" class="nav-link" data-scroll-target="#conjugate-actually-semiconjugate-priors"><span class="header-section-number">16.3</span> Conjugate (Actually “Semiconjugate”) Priors</a>
  <ul class="collapse">
<li><a href="#for-mu-mid-sigma2" id="toc-for-mu-mid-sigma2" class="nav-link" data-scroll-target="#for-mu-mid-sigma2"><span class="header-section-number">16.3.1</span> For <span class="math inline">\(\mu \mid \sigma^2\)</span></a></li>
  <li><a href="#for-sigma2-mid-mu" id="toc-for-sigma2-mid-mu" class="nav-link" data-scroll-target="#for-sigma2-mid-mu"><span class="header-section-number">16.3.2</span> For <span class="math inline">\(\sigma^2 \mid \mu\)</span></a></li>
  </ul>
</li>
  <li><a href="#prior-model-and-posterior" id="toc-prior-model-and-posterior" class="nav-link" data-scroll-target="#prior-model-and-posterior"><span class="header-section-number">16.4</span> Prior, Model, and Posterior</a></li>
  <li><a href="#the-gibbs-sampler" id="toc-the-gibbs-sampler" class="nav-link" data-scroll-target="#the-gibbs-sampler"><span class="header-section-number">16.5</span> The Gibbs Sampler</a></li>
  <li>
<a href="#visualizing-the-jumps" id="toc-visualizing-the-jumps" class="nav-link" data-scroll-target="#visualizing-the-jumps"><span class="header-section-number">16.6</span> Visualizing the Jumps</a>
  <ul class="collapse">
<li><a href="#convergence-check" id="toc-convergence-check" class="nav-link" data-scroll-target="#convergence-check"><span class="header-section-number">16.6.1</span> Convergence Check</a></li>
  <li><a href="#visualizing-the-marginal-and-joint-posterior" id="toc-visualizing-the-marginal-and-joint-posterior" class="nav-link" data-scroll-target="#visualizing-the-marginal-and-joint-posterior"><span class="header-section-number">16.6.2</span> Visualizing the Marginal and Joint Posterior</a></li>
  <li><a href="#posterior-predictive-check" id="toc-posterior-predictive-check" class="nav-link" data-scroll-target="#posterior-predictive-check"><span class="header-section-number">16.6.3</span> Posterior Predictive Check</a></li>
  <li><a href="#limitations-of-gibbs-sampler" id="toc-limitations-of-gibbs-sampler" class="nav-link" data-scroll-target="#limitations-of-gibbs-sampler"><span class="header-section-number">16.6.4</span> Limitations of Gibbs Sampler</a></li>
  </ul>
</li>
  <li>
<a href="#the-metropolis-hastings-algorithm" id="toc-the-metropolis-hastings-algorithm" class="nav-link" data-scroll-target="#the-metropolis-hastings-algorithm"><span class="header-section-number">16.7</span> The Metropolis-Hastings Algorithm</a>
  <ul class="collapse">
<li><a href="#convergence" id="toc-convergence" class="nav-link" data-scroll-target="#convergence"><span class="header-section-number">16.7.1</span> Convergence</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./09-mcmc.html">Week 10–11</a></li><li class="breadcrumb-item"><a href="./09b-gibbs.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Gibbs Sampling</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Gibbs Sampling</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>In the previous note, we learn about the Metropolis algorithm. While the algorithm is very general and easy to implement, it is inefficient because the effective sample size is only about 1/4 of the actual number of draws for a one-parameter model. The Metropolis algorithm usually gets stuck when there are multiple parameters. Therefore, until about 2010, many Bayesian analyses relied on a more efficient algorithm—the Gibbs sampler. The Gibbs sampler uses conjugate priors on the <em>conditional posterior</em> distributions to get proposal values with high acceptance probability (it’s 100%). We’ll also see the <em>normal</em> model with two parameters: mean and variance.</p>
<section id="data" class="level2" data-number="16.1"><h2 data-number="16.1" class="anchored" data-anchor-id="data">
<span class="header-section-number">16.1</span> Data</h2>
<p>The data set was from one of the studies reported in <a href="https://journals.sagepub.com/doi/abs/10.1177/0956797614524581">a paper published in <em>Psychological Science</em> in 2014</a>. The authors compared participants’ performance on conceptual questions after taking notes either using laptops or notebooks (“longhand”). Let’s import the data directly from the Open Science Framework (https://osf.io/qrs5y/):</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Use haven::read_sav() to import SPSS data</span></span>
<span><span class="va">nt_dat</span> <span class="op">&lt;-</span> <span class="fu">read_sav</span><span class="op">(</span><span class="st">"https://osf.io/qrs5y/download"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One outcome variable the authors studied is the number of words in participants’ notes. Here are the distributions of the variable <code>wordcount</code> for the two conditions (0 = laptop, 1 = longhand).</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">nt_dat</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">wordcount</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">condition</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-wordcount" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wordcount-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-wordcount-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wordcount-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16.1: Number of words by experimental conditions.
</figcaption></figure>
</div>
</div>
</div>
<p>The variable is somewhat skewed. We’ll focus on the control group (<code>laptop</code>) first, so let’s create a variable for that data. We’ll also divide the count by 100.</p>
<div class="callout callout-style-simple callout-tip">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Often, in Bayesian analyses (and in frequentist ones as well), computer algorithms work best when the variables do not contain too many digits. In my experience, scaling variables to a range of -10 to 10 usually helps the computation.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">wc_laptop</span> <span class="op">&lt;-</span> <span class="va">nt_dat</span><span class="op">$</span><span class="va">wordcount</span><span class="op">[</span><span class="va">nt_dat</span><span class="op">$</span><span class="va">condition</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 4.20 4.61 5.72 4.47 3.34 1.27 2.65 3.40 2.43 2.55 2.73 2.26 3.16 2.47 3.25
[16] 1.67 4.49 4.77 1.67 5.19 3.00 2.98 1.59 2.23 4.39 2.29 1.52 2.13 3.11 3.82
[31] 2.62</code></pre>
</div>
</div>
</section><section id="the-normal-model" class="level2" data-number="16.2"><h2 data-number="16.2" class="anchored" data-anchor-id="the-normal-model">
<span class="header-section-number">16.2</span> The Normal Model</h2>
<p>While only an approximation, the normal distribution is a popular choice for modeling variables that are relatively symmetric and have more than a few discrete values. The normal distribution has two parameters; in some situations, there are advantages to choosing a specific parameterization. With the Gibbs sampler, we will parameterize it using the mean parameter, <span class="math inline">\(\mu\)</span>, and the variance parameter, <span class="math inline">\(\sigma^2\)</span>. The model is <span class="math display">\[
\text{wc\_laptop}_i \sim N(\mu, \sigma^2)
\]</span> Note again that there are no subscripts to <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma^2\)</span>, indicating exchangeability assumption.</p>
</section><section id="conjugate-actually-semiconjugate-priors" class="level2" data-number="16.3"><h2 data-number="16.3" class="anchored" data-anchor-id="conjugate-actually-semiconjugate-priors">
<span class="header-section-number">16.3</span> Conjugate (Actually “Semiconjugate”) Priors</h2>
<p>It can be shown that when <span class="math inline">\(\sigma^2\)</span> is known, a conjugate prior to <span class="math inline">\(\mu\)</span> is a normal prior, meaning that the posterior is also normal. However, when <span class="math inline">\(\sigma^2\)</span> is unknown, the prior distribution needs to be a joint distribution of two parameters.</p>
<p>What we can do is consider the conditional distribution of a parameter. So instead of drawing a posterior sample from the joint posterior, <span class="math inline">\(P(\mu, \sigma^2 \mid y)\)</span>, we consider each parameter separately, by drawing from the conditional of <span class="math inline">\(P(\sigma^2 \mid \mu^{(s - 1)}, y)\)</span> first, and then from <span class="math inline">\(P(\mu \mid \sigma^2 = {\sigma^2}^{(s)}, y)\)</span> with <span class="math inline">\({\sigma^2}^{(s)}\)</span> being the previous draw, and then continuing with <span class="math inline">\(P(\sigma^2 \mid \mu^{(s)}, y)\)</span>. The advantage of doing so is that we can use a conjugate normal prior for <span class="math inline">\(\mu\)</span> when conditioning on <span class="math inline">\(\sigma^2\)</span>. We also have a conjugate prior for <span class="math inline">\(\sigma^2\)</span> when conditioning on <span class="math inline">\(\mu\)</span>, which will be discussed later. Here is how the algorithm works:</p>
<ol type="1">
<li>Set an initial value for <span class="math inline">\({\sigma^2}{(1)}\)</span>
</li>
<li>At iteration <span class="math inline">\(s\)</span>, given sample <span class="math inline">\({\sigma^2}^{(s - 1)}\)</span>, sample <span class="math inline">\(\mu^{(s)}\)</span> from the conditional posterior, <span class="math inline">\(P(\mu \mid {\sigma^2}^{(s)}, y)\)</span>
</li>
<li>Given <span class="math inline">\(\mu^{(s)}\)</span>, sample <span class="math inline">\({\sigma^2}^{(s)}\)</span> from the conditional posterior, <span class="math inline">\(P(\sigma^2 \mid \mu^{(s - 1)}, y)\)</span>
</li>
<li>Repeat steps 2 and 3</li>
</ol>
<p>It can be shown that with this <em>Gibbs</em> algorithm, the posterior draws will be from the joint posterior of <span class="math inline">\(P(\mu, \sigma^2 \mid y)\)</span>.</p>
<p>Below I provide more details on conjugacy. The actual detail is not the most important for this class because, in practice, the software will likely handle the computation. You may want to, however, pay attention to the suggested meanings of the hyperparameters:</p>
<ul>
<li>
<span class="math inline">\(\mu_0\)</span>: Prior mean</li>
<li>
<span class="math inline">\(\tau_0^2\)</span>: Prior variance (i.e., uncertainty) of the mean</li>
<li>
<span class="math inline">\(\nu_0\)</span>: Prior sample size for the variance</li>
<li>
<span class="math inline">\(\sigma^2_0\)</span>: Prior expectation of the variance</li>
</ul>
<section id="for-mu-mid-sigma2" class="level3" data-number="16.3.1"><h3 data-number="16.3.1" class="anchored" data-anchor-id="for-mu-mid-sigma2">
<span class="header-section-number">16.3.1</span> For <span class="math inline">\(\mu \mid \sigma^2\)</span>
</h3>
<p>A conjugate prior for <span class="math inline">\(\mu \mid \sigma^2\)</span> is <span class="math inline">\(\mu \sim N(\mu_0, \tau_0^2)\)</span>, which gives the posterior conditional <span class="math display">\[\mu \mid \sigma^2, y \sim N(\mu_n, \tau_n^2),\]</span> where <span class="math display">\[
  \begin{aligned}
    \tau_n^2 &amp; = \left(\frac{1}{\tau_0^2} + \frac{n}{\sigma^2}\right)^{-1} \\
    \mu_n &amp; = \tau_n^2 \left(\frac{\mu_0}{\tau_0^2} + \frac{n \bar y}{\sigma^2}\right)
  \end{aligned},
\]</span> with <span class="math inline">\(n\)</span> being the number of observations in the data and <span class="math inline">\(\bar y\)</span> being the sample mean of the data. The hyperparameters, <span class="math inline">\(\mu_0\)</span> and <span class="math inline">\(\tau_0^2\)</span>, can be considered the prior mean and the prior variance of the mean, with a smaller prior variance indicating a stronger prior.</p>
<div class="callout callout-style-simple callout-tip">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Note that <span class="math inline">\(n\)</span> (instead of <span class="math inline">\(N\)</span>) is used here for the sample size to avoid confusion with the normal distribution.</p>
</div>
</div>
</div>
</section><section id="for-sigma2-mid-mu" class="level3" data-number="16.3.2"><h3 data-number="16.3.2" class="anchored" data-anchor-id="for-sigma2-mid-mu">
<span class="header-section-number">16.3.2</span> For <span class="math inline">\(\sigma^2 \mid \mu\)</span>
</h3>
<p>A conjugate prior for <span class="math inline">\(\mu \mid \sigma^2\)</span> is from the Inverse-Gamma family: <span class="math inline">\(\sigma^2 \sim \text{Inv-Gamma}(\nu_0 / 2, \nu_0 \sigma^2_0 / 2)\)</span>. You usually only hear about the Inverse-Gamma distribution in Gibbs sampling, mainly because of conjugacy. As the name suggested, the Inverse-Gamma distribution is the distribution of the <em>inverse</em> of a variable that follows a Gamma distribution. So we also write <span class="math inline">\(1 / \sigma^2 \sim \mathrm{Gamma}(\nu_0 / 2, \nu_0 \sigma^2_0 / 2)\)</span>.</p>
<div class="callout callout-style-simple callout-tip">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>The Gamma distribution used here is also called a scaled <span class="math inline">\(\chi^2\)</span> distribution by some authors, with <span class="math inline">\(\mathrm{Gamma}(\nu_0 / 2, \nu_0 \sigma^2_0 / 2)\)</span> being the same as <span class="math inline">\(\chi^2(\nu_0, \sigma^2_0)\)</span>.</p>
</div>
</div>
</div>
<p>The posterior is also Inverse-Gamma, with <span class="math display">\[
1 / \sigma^2 \mid \mu^2, y \sim \mathrm{Gamma}(\nu_n / 2, \nu_n \sigma^2_n [\mu] / 2),
\]</span> where <span class="math display">\[
\begin{aligned}
  \nu_n &amp; = \nu_0 + n \\
  \sigma^2_n (\mu) &amp; = \frac{1}{\nu_n} \left[\nu_0 \sigma^2_0 + (n - 1) s^2_y + \sum (\bar y - \mu)^2\right]
\end{aligned},
\]</span> with <span class="math inline">\(s^2_y = \sum (y_i - \bar y)^2 / (n - 1)\)</span> being the sample variance of <span class="math inline">\(y\)</span>. The hyperparameters, <span class="math inline">\(\nu_0\)</span> and <span class="math inline">\(\sigma^2_0\)</span>, can be considered the prior degrees of freedom and prior expected value of variance; <span class="math inline">\(\nu_0\)</span> can be roughly considered as the prior sample size.</p>
</section></section><section id="prior-model-and-posterior" class="level2" data-number="16.4"><h2 data-number="16.4" class="anchored" data-anchor-id="prior-model-and-posterior">
<span class="header-section-number">16.4</span> Prior, Model, and Posterior</h2>
<p>We will use some weakly informative priors, written in the following equations:</p>
<p>Model: <span class="math display">\[\text{wc\_laptop}_i \sim N(\mu, \sigma^2)\]</span> Prior: <span class="math display">\[
  \begin{aligned}
    \mu &amp; \sim N(5, 10^2) \\
    1 / \sigma^2 &amp; \sim \mathrm{Gamma}(1 / 2, [1] [1] / 2)
  \end{aligned}
\]</span></p>
<p>The priors are very weak. We also assume that the priors are independent, which is commonly the case. Here are some simulated data from these priors:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2259</span><span class="op">)</span></span>
<span><span class="va">num_draws</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">num_draws</span>, mean <span class="op">=</span> <span class="fl">5</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">inv_sigma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="va">num_draws</span>,</span>
<span>                     shape <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span>, rate <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">num_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">wc_laptop</span><span class="op">)</span></span>
<span><span class="co"># Initialize an S by N matrix to store the simulated data</span></span>
<span><span class="va">y_tilde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,</span>
<span>                  nrow <span class="op">=</span> <span class="va">num_draws</span>,</span>
<span>                  ncol <span class="op">=</span> <span class="va">num_obs</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">num_draws</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mu_s</span> <span class="op">&lt;-</span> <span class="va">mu</span><span class="op">[</span><span class="va">s</span><span class="op">]</span></span>
<span>    <span class="va">sigma2_s</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">inv_sigma2</span><span class="op">[</span><span class="va">s</span><span class="op">]</span></span>
<span>    <span class="va">y_tilde</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">num_obs</span>, mean <span class="op">=</span> <span class="va">mu_s</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sigma2_s</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Plot the simulated data based on priors</span></span>
<span><span class="fu">ppd_dens_overlay</span><span class="op">(</span><span class="va">y_tilde</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ppd-gibbs" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ppd-gibbs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-ppd-gibbs-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ppd-gibbs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16.2: Prior predictive distributions.
</figcaption></figure>
</div>
</div>
</div>
<p>The plot shows the types of data one can get. One can do better by avoiding the negative values if desired.</p>
</section><section id="the-gibbs-sampler" class="level2" data-number="16.5"><h2 data-number="16.5" class="anchored" data-anchor-id="the-gibbs-sampler">
<span class="header-section-number">16.5</span> The Gibbs Sampler</h2>
<p>The following is the full Gibbs sampler for the above normal model.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sufficient statistics from data</span></span>
<span><span class="va">ybar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">wc_laptop</span><span class="op">)</span>  <span class="co"># sample mean</span></span>
<span><span class="va">s2y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">wc_laptop</span><span class="op">)</span>  <span class="co"># sample variance</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">wc_laptop</span><span class="op">)</span>  <span class="co"># sample size</span></span>
<span><span class="co"># Hyperparameters</span></span>
<span><span class="va">mu_0</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">sigma2_0</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">tau2_0</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">nu_0</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># Initialize the Gibbs sampler</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2120</span><span class="op">)</span></span>
<span><span class="va">num_draws</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span><span class="va">num_warmup</span> <span class="op">&lt;-</span> <span class="va">num_draws</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="va">num_chains</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="co"># Initialize a 3-D array (S x # chains x 2 parameters)</span></span>
<span><span class="va">post_all_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span></span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">num_draws</span>, <span class="va">num_chains</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"sigma2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Step 1: starting values for sigma2</span></span>
<span><span class="va">post_all_draws</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="st">"sigma2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>  <span class="co"># for chain 1</span></span>
<span><span class="va">post_all_draws</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="st">"sigma2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">3</span>  <span class="co"># for chain 2</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">num_draws</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">num_chains</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">sigma2_s</span> <span class="op">&lt;-</span> <span class="va">post_all_draws</span><span class="op">[</span><span class="va">s</span>, <span class="va">j</span>, <span class="st">"sigma2"</span><span class="op">]</span></span>
<span>        <span class="co"># Step 2: Sample mu from the conditional posterior</span></span>
<span>        <span class="va">tau2_n</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">tau2_0</span> <span class="op">+</span> <span class="va">n</span> <span class="op">/</span> <span class="va">sigma2_s</span><span class="op">)</span></span>
<span>        <span class="va">mu_n</span> <span class="op">&lt;-</span> <span class="va">tau2_n</span> <span class="op">*</span> <span class="op">(</span><span class="va">mu_0</span> <span class="op">/</span> <span class="va">tau2_0</span> <span class="op">+</span> <span class="va">n</span> <span class="op">*</span> <span class="va">ybar</span> <span class="op">/</span> <span class="va">sigma2_s</span><span class="op">)</span></span>
<span>        <span class="va">mu_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, mean <span class="op">=</span> <span class="va">mu_n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">tau2_n</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">post_all_draws</span><span class="op">[</span><span class="va">s</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">j</span>, <span class="st">"mu"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mu_new</span></span>
<span>        <span class="co"># Step 3: Sample sigma2 from the conditional posterior</span></span>
<span>        <span class="va">nu_n</span> <span class="op">&lt;-</span> <span class="va">nu_0</span> <span class="op">+</span> <span class="va">n</span>  <span class="co"># you could put this line outside the loop</span></span>
<span>        <span class="va">sigma2_n</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">nu_n</span> <span class="op">*</span></span>
<span>            <span class="op">(</span><span class="va">nu_0</span> <span class="op">*</span> <span class="va">sigma2_0</span> <span class="op">+</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">s2y</span> <span class="op">+</span> <span class="op">(</span><span class="va">ybar</span> <span class="op">-</span> <span class="va">mu_new</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="va">sigma2_new</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1</span>,</span>
<span>            shape <span class="op">=</span> <span class="va">nu_n</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>            rate <span class="op">=</span> <span class="va">nu_n</span> <span class="op">*</span> <span class="va">sigma2_n</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="va">post_all_draws</span><span class="op">[</span><span class="va">s</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">j</span>, <span class="st">"sigma2"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sigma2_new</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Draws after warm-up</span></span>
<span><span class="va">post_draws</span> <span class="op">&lt;-</span> <span class="va">post_all_draws</span><span class="op">[</span><span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">num_warmup</span><span class="op">)</span>, , <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="visualizing-the-jumps" class="level2" data-number="16.6"><h2 data-number="16.6" class="anchored" data-anchor-id="visualizing-the-jumps">
<span class="header-section-number">16.6</span> Visualizing the Jumps</h2>
<p>The plot below shows the jumps for 20 iterations in one chain, with the intermediate steps.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    mu <span class="op">=</span> <span class="va">post_draws</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span>, <span class="st">"mu"</span><span class="op">]</span>,</span>
<span>    sigma2 <span class="op">=</span> <span class="va">post_draws</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">19</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fl">20</span><span class="op">)</span>, <span class="fl">1</span>, <span class="st">"sigma2"</span><span class="op">]</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">sigma2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_path</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-jumps-gibbs" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-jumps-gibbs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-jumps-gibbs-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-jumps-gibbs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16.3: Jumps in the Gibbs sampler across iterations.
</figcaption></figure>
</div>
</div>
</div>
<section id="convergence-check" class="level3" data-number="16.6.1"><h3 data-number="16.6.1" class="anchored" data-anchor-id="convergence-check">
<span class="header-section-number">16.6.1</span> Convergence Check</h3>
<div class="cell" data-layout-nrow="2">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert to `draws_array` object to use the following functions</span></span>
<span><span class="va">post_draws_array</span> <span class="op">&lt;-</span> <span class="fu">as_draws_array</span><span class="op">(</span><span class="va">post_draws</span><span class="op">)</span></span>
<span><span class="co"># Trace plots</span></span>
<span><span class="fu">mcmc_trace</span><span class="op">(</span><span class="va">post_draws_array</span><span class="op">)</span>  <span class="co"># good mixing</span></span>
<span><span class="co"># Rank histograms</span></span>
<span><span class="fu">mcmc_rank_hist</span><span class="op">(</span><span class="va">post_draws_array</span><span class="op">)</span>  <span class="co"># good mixing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-gibbs-trace" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-gibbs-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-gibbs-trace" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-gibbs-trace-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-gibbs-trace-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-gibbs-trace-1.png" class="img-fluid figure-img" data-ref-parent="fig-gibbs-trace" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-gibbs-trace-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Trace plots.
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-gibbs-trace" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-gibbs-trace-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-gibbs-trace-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-gibbs-trace-2.png" class="img-fluid figure-img" data-ref-parent="fig-gibbs-trace" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-gibbs-trace-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Rank histograms.
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gibbs-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16.4: Diagnostic plots for the Gibbs sampler.
</figcaption></figure>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Summary (with rhat and ESS)</span></span>
<span><span class="fu">summarize_draws</span><span class="op">(</span><span class="va">post_draws_array</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mu</td>
<td style="text-align: right;">3.1</td>
<td style="text-align: right;">3.10</td>
<td style="text-align: right;">0.21</td>
<td style="text-align: right;">0.21</td>
<td style="text-align: right;">2.75</td>
<td style="text-align: right;">3.45</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">9928.49</td>
<td style="text-align: right;">9935.87</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma2</td>
<td style="text-align: right;">1.4</td>
<td style="text-align: right;">1.33</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">0.90</td>
<td style="text-align: right;">2.11</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10188.76</td>
<td style="text-align: right;">10135.62</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As can be seen, the ESS is very high, indeed much higher than that obtained with the Metropolis algorithm.</p>
</section><section id="visualizing-the-marginal-and-joint-posterior" class="level3" data-number="16.6.2"><h3 data-number="16.6.2" class="anchored" data-anchor-id="visualizing-the-marginal-and-joint-posterior">
<span class="header-section-number">16.6.2</span> Visualizing the Marginal and Joint Posterior</h3>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">mcmc_areas</span><span class="op">(</span><span class="va">post_draws_array</span><span class="op">)</span>  <span class="co"># marginal</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-gibbs-areas" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-gibbs-areas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-gibbs-areas-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gibbs-areas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16.5: Marginal posterior distributions of model parameters.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">mcmc_scatter</span><span class="op">(</span><span class="va">post_draws_array</span>,  <span class="co"># joint</span></span>
<span>             size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>  <span class="co"># make points smaller</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-gibbs-scatter" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-gibbs-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-gibbs-scatter-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gibbs-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16.6: Joint posterior distributions of model parameters.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="posterior-predictive-check" class="level3" data-number="16.6.3"><h3 data-number="16.6.3" class="anchored" data-anchor-id="posterior-predictive-check">
<span class="header-section-number">16.6.3</span> Posterior Predictive Check</h3>
<p>We can check whether the simulated data based on the posterior look like the observed data.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">num_draws</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">wc_laptop</span><span class="op">)</span></span>
<span><span class="co"># Initialize an S by N matrix to store the simulated data</span></span>
<span><span class="va">y_tilde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,</span>
<span>                  nrow <span class="op">=</span> <span class="va">num_draws</span>,</span>
<span>                  ncol <span class="op">=</span> <span class="va">num_obs</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">num_draws</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mu_s</span> <span class="op">&lt;-</span> <span class="va">post_draws</span><span class="op">[</span><span class="va">s</span>, <span class="fl">1</span>, <span class="st">"mu"</span><span class="op">]</span></span>
<span>    <span class="va">sigma2_s</span> <span class="op">&lt;-</span> <span class="va">post_draws</span><span class="op">[</span><span class="va">s</span>, <span class="fl">1</span>, <span class="st">"sigma2"</span><span class="op">]</span></span>
<span>    <span class="va">y_tilde</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">num_obs</span>, mean <span class="op">=</span> <span class="va">mu_s</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sigma2_s</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Plot the simulated data (in lighter lines)</span></span>
<span><span class="co"># and the current data (in the darker line)</span></span>
<span><span class="fu">ppc_dens_overlay</span><span class="op">(</span><span class="va">wc_laptop</span>, yrep <span class="op">=</span> <span class="va">y_tilde</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-gibbs-ppc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-gibbs-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-gibbs-ppc-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gibbs-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16.7: Posterior predictive check.
</figcaption></figure>
</div>
</div>
</div>
<p>The simulated data are not too far off from the observed data. Just that the simulated data can also get negative values.</p>
</section><section id="limitations-of-gibbs-sampler" class="level3" data-number="16.6.4"><h3 data-number="16.6.4" class="anchored" data-anchor-id="limitations-of-gibbs-sampler">
<span class="header-section-number">16.6.4</span> Limitations of Gibbs Sampler</h3>
<p>The Gibbs sampler has been popular due to its computational efficiency for many problems. However, there are situations in which it works less well, such as when some parameters are highly correlated in the posterior, in which case a Gibbs sampler may get stuck. Another limitation is that Gibbs samplers require the use of conjugate priors. On the one hand, sometimes researcher beliefs may be better expressed in distributions other than the conjugate family. On the other hand, some conjugate families, such as the inverse Gamma distribution, are hard to work with and may yield suboptimal results in small sample situations.</p>
</section></section><section id="the-metropolis-hastings-algorithm" class="level2" data-number="16.7"><h2 data-number="16.7" class="anchored" data-anchor-id="the-metropolis-hastings-algorithm">
<span class="header-section-number">16.7</span> The Metropolis-Hastings Algorithm</h2>
<p>The Metropolis-Hastings (MH) algorithm is a generalization of the Metropolis algorithm, where it allows for more than one parameter and can use a proposal distribution that is not symmetric. It is less efficient than the Gibbs sampler but can accommodate non-conjugate prior distributions. Note that the proposal distribution needs to have the same dimension as the posterior so that the proposal is a vector in the parameter space. For example, we need a bivariate proposal density with <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>.</p>
<p>Below is an example using a bivariate normal distribution for the proposal. While we can choose how correlated the variables are in the proposal, for simplicity, I just consider zero correlation and equal <em>SD</em> for both dimensions. I also parameterize the normal distribution by the mean, <span class="math inline">\(\mu\)</span>, and the standard deviation (instead of the variance), <span class="math inline">\(\sigma\)</span>. The priors are: <span class="math display">\[
  \begin{aligned}
    \mu &amp; \sim N(5, 10^2) \\
    \sigma &amp; \sim N^+(0, 3)
  \end{aligned},
\]</span> where <span class="math inline">\(N^+\)</span> is a half-normal distribution because <span class="math inline">\(\sigma\)</span> is non-negative. We’ll revisit this for some later models.</p>
<p>Here is the code for the MH algorithm:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Define a function to compute values proportional to p(y | th) * p(th)</span></span>
<span><span class="va">prior_times_lik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mu_sigma</span>, <span class="va">y</span> <span class="op">=</span> <span class="va">wc_laptop</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">mu_sigma</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">mu_sigma</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="co"># Return 0 if sigma is out of range</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">sigma</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="co"># Joint prior = product of marginal priors</span></span>
<span>    <span class="va">pth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span>, mean <span class="op">=</span> <span class="fl">5</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">*</span></span>
<span>        <span class="co"># half-normal is proportional to normal in [0, infinity)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">sigma</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="co"># Likelihood</span></span>
<span>    <span class="va">py_given_th</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">y</span>, mean <span class="op">=</span> <span class="va">mu</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">pth</span> <span class="op">*</span> <span class="va">py_given_th</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Define a function for generating data from the proposal distribution</span></span>
<span><span class="va">generate_proposal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mu_sigma</span>, <span class="va">sd</span> <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">mu_sigma</span><span class="op">)</span>, mean <span class="op">=</span> <span class="va">mu_sigma</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Initialize the Metropolis algorithm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1051</span><span class="op">)</span>  <span class="co"># set the seed for reproducibility</span></span>
<span><span class="va">num_draws</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span><span class="va">num_warmup</span> <span class="op">&lt;-</span> <span class="va">num_draws</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="va">num_chains</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="co"># Initialize a 3-D array (S x # chains x 2 parameters)</span></span>
<span><span class="va">post_all_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span></span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">num_draws</span>, <span class="va">num_chains</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Step 1: starting value</span></span>
<span><span class="va">post_all_draws</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>  <span class="co"># for chain 1</span></span>
<span><span class="va">post_all_draws</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">3</span><span class="op">)</span>  <span class="co"># for chain 2</span></span>
<span><span class="co"># counter for tracking acceptance rate</span></span>
<span><span class="va">num_accepted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">num_chains</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">num_draws</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">num_chains</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">current_par</span> <span class="op">&lt;-</span> <span class="va">post_all_draws</span><span class="op">[</span><span class="va">s</span>, <span class="va">j</span>, <span class="op">]</span></span>
<span>        <span class="co"># Generate proposal vector</span></span>
<span>        <span class="va">proposed_par</span> <span class="op">&lt;-</span> <span class="fu">generate_proposal</span><span class="op">(</span><span class="va">current_par</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>        <span class="co"># Compute acceptance probability</span></span>
<span>        <span class="va">prob_accept</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span></span>
<span>            <span class="fl">1</span>,</span>
<span>            <span class="fu">prior_times_lik</span><span class="op">(</span><span class="va">proposed_par</span><span class="op">)</span> <span class="op">/</span></span>
<span>                <span class="fu">prior_times_lik</span><span class="op">(</span><span class="va">current_par</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="co"># Determine whether to make the jump</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">prob_accept</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">post_all_draws</span><span class="op">[</span><span class="va">s</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">j</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">proposed_par</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="va">s</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">&gt;=</span> <span class="va">num_warmup</span><span class="op">)</span> <span class="op">{</span></span>
<span>                <span class="va">num_accepted</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">num_accepted</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>            <span class="op">}</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="va">post_all_draws</span><span class="op">[</span><span class="va">s</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">j</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">current_par</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Draws after warm-up</span></span>
<span><span class="va">post_draws</span> <span class="op">&lt;-</span> <span class="va">post_all_draws</span><span class="op">[</span><span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">num_warmup</span><span class="op">)</span>, , <span class="op">]</span></span>
<span><span class="co"># Acceptance rate</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">num_accepted</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">post_draws</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3638</code></pre>
</div>
</div>
<section id="convergence" class="level3" data-number="16.7.1"><h3 data-number="16.7.1" class="anchored" data-anchor-id="convergence">
<span class="header-section-number">16.7.1</span> Convergence</h3>
<div class="cell" data-layout-nrow="2">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert to `draws_array` object to use the following functions</span></span>
<span><span class="va">post_draws_array</span> <span class="op">&lt;-</span> <span class="fu">as_draws_array</span><span class="op">(</span><span class="va">post_draws</span><span class="op">)</span></span>
<span><span class="co"># Trace plots</span></span>
<span><span class="fu">mcmc_trace</span><span class="op">(</span><span class="va">post_draws_array</span><span class="op">)</span>  <span class="co"># good mixing</span></span>
<span><span class="co"># Rank histograms</span></span>
<span><span class="fu">mcmc_rank_hist</span><span class="op">(</span><span class="va">post_draws_array</span><span class="op">)</span>  <span class="co"># good mixing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-mh-trace" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-mh-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-mh-trace" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-mh-trace-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-mh-trace-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-mh-trace-1.png" class="img-fluid figure-img" data-ref-parent="fig-mh-trace" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-mh-trace-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Trace plots.
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-mh-trace" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-mh-trace-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-mh-trace-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09b-gibbs_files/figure-html/fig-mh-trace-2.png" class="img-fluid figure-img" data-ref-parent="fig-mh-trace" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-mh-trace-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Rank histograms.
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mh-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16.8: Diagnostic plots for the MH sampler.
</figcaption></figure>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Summary (with rhat and ESS)</span></span>
<span><span class="fu">summarize_draws</span><span class="op">(</span><span class="va">post_draws_array</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mu</td>
<td style="text-align: right;">3.11</td>
<td style="text-align: right;">3.11</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">2.72</td>
<td style="text-align: right;">3.49</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">304.66</td>
<td style="text-align: right;">426.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">1.20</td>
<td style="text-align: right;">1.19</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">1.48</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">694.50</td>
<td style="text-align: right;">733.81</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As can be seen, ESS is much lower, so more iterations will be needed with MH.</p>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./09-mcmc.html" class="pagination-link" aria-label="Markov Chain Monte Carlo">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./09c-hmc.html" class="pagination-link" aria-label="Hamiltonian Monte Carlo">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Hamiltonian Monte Carlo</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb17" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Gibbs Sampling</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>comma <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">digits =</span> <span class="dv">2</span>L) <span class="fu">format</span>(x, <span class="at">digits =</span> digits, <span class="at">big.mark =</span> <span class="st">","</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"grey92"</span>)))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>In the previous note, we learn about the Metropolis algorithm. While the algorithm is very general and easy to implement, it is inefficient because the effective sample size is only about 1/4 of the actual number of draws for a one-parameter model. The Metropolis algorithm usually gets stuck when there are multiple parameters. Therefore, until about 2010, many Bayesian analyses relied on a more efficient algorithm---the Gibbs sampler. The Gibbs sampler uses conjugate priors on the *conditional posterior* distributions to get proposal values with high acceptance probability (it's 100%). We'll also see the *normal* model with two parameters: mean and variance.</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>The data set was from one of the studies reported in <span class="co">[</span><span class="ot">a paper published in *Psychological Science* in 2014</span><span class="co">](https://journals.sagepub.com/doi/abs/10.1177/0956797614524581)</span>. The authors compared participants' performance on conceptual questions after taking notes either using laptops or notebooks ("longhand"). Let's import the data directly from the Open Science Framework (https://osf.io/qrs5y/):</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Use haven::read_sav() to import SPSS data</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>nt_dat <span class="ot">&lt;-</span> <span class="fu">read_sav</span>(<span class="st">"https://osf.io/qrs5y/download"</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>One outcome variable the authors studied is the number of words in participants' notes. Here are the distributions of the variable <span class="in">`wordcount`</span> for the two conditions (0 = laptop, 1 = longhand).</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-wordcount</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Number of words by experimental conditions."</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(nt_dat, <span class="fu">aes</span>(<span class="at">x =</span> wordcount)) <span class="sc">+</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> condition)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>The variable is somewhat skewed. We'll focus on the control group (<span class="in">`laptop`</span>) first, so let's create a variable for that data. We'll also divide the count by 100.</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>Often, in Bayesian analyses (and in frequentist ones as well), computer algorithms work best when the variables do not contain too many digits. In my experience, scaling variables to a range of -10 to 10 usually helps the computation.</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>(wc_laptop <span class="ot">&lt;-</span> nt_dat<span class="sc">$</span>wordcount[nt_dat<span class="sc">$</span>condition <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">/</span> <span class="dv">100</span>)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Normal Model</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>While only an approximation, the normal distribution is a popular choice for modeling variables that are relatively symmetric and have more than a few discrete values. The normal distribution has two parameters; in some situations, there are advantages to choosing a specific parameterization. With the Gibbs sampler, we will parameterize it using the mean parameter, $\mu$, and the variance parameter, $\sigma^2$. The model is</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>\text{wc<span class="sc">\_</span>laptop}_i \sim N(\mu, \sigma^2)</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>Note again that there are no subscripts to $\mu$ and $\sigma^2$, indicating exchangeability assumption.</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conjugate (Actually "Semiconjugate") Priors</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>It can be shown that when $\sigma^2$ is known, a conjugate prior to $\mu$ is a normal prior, meaning that the posterior is also normal. However, when $\sigma^2$ is unknown, the prior distribution needs to be a joint distribution of two parameters.</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>What we can do is consider the conditional distribution of a parameter. So instead of drawing a posterior sample from the joint posterior, $P(\mu, \sigma^2 \mid y)$, we consider each parameter separately, by drawing from the conditional of $P(\sigma^2 \mid \mu^{(s - 1)}, y)$ first, and then from $P(\mu \mid \sigma^2 = {\sigma^2}^{(s)}, y)$ with ${\sigma^2}^{(s)}$ being the previous draw, and then continuing with $P(\sigma^2 \mid \mu^{(s)}, y)$. The advantage of doing so is that we can use a conjugate normal prior for $\mu$ when conditioning on $\sigma^2$. We also have a conjugate prior for $\sigma^2$ when conditioning on $\mu$, which will be discussed later. Here is how the algorithm works:</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Set an initial value for ${\sigma^2}{(1)}$</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>At iteration $s$, given sample ${\sigma^2}^{(s - 1)}$, sample $\mu^{(s)}$ from the conditional posterior, $P(\mu \mid {\sigma^2}^{(s)}, y)$</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Given $\mu^{(s)}$, sample ${\sigma^2}^{(s)}$ from the conditional posterior, $P(\sigma^2 \mid \mu^{(s - 1)}, y)$</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Repeat steps 2 and 3</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>It can be shown that with this *Gibbs* algorithm, the posterior draws will be from the joint posterior of $P(\mu, \sigma^2 \mid y)$.</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>Below I provide more details on conjugacy. The actual detail is not the most important for this class because, in practice, the software will likely handle the computation. You may want to, however, pay attention to the suggested meanings of the hyperparameters:</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\mu_0$: Prior mean</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\tau_0^2$: Prior variance (i.e., uncertainty) of the mean</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\nu_0$: Prior sample size for the variance</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\sigma^2_0$: Prior expectation of the variance</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a><span class="fu">### For $\mu \mid \sigma^2$</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>A conjugate prior for $\mu \mid \sigma^2$ is $\mu \sim N(\mu_0, \tau_0^2)$, which gives the posterior conditional</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>$$\mu \mid \sigma^2, y \sim N(\mu_n, \tau_n^2),$$</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>  \begin{aligned}</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>    \tau_n^2 &amp; = \left(\frac{1}{\tau_0^2} + \frac{n}{\sigma^2}\right)^{-1} <span class="sc">\\</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>    \mu_n &amp; = \tau_n^2 \left(\frac{\mu_0}{\tau_0^2} + \frac{n \bar y}{\sigma^2}\right)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>  \end{aligned},</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>with $n$ being the number of observations in the data and $\bar y$ being the sample mean of the data. The hyperparameters, $\mu_0$ and $\tau_0^2$, can be considered the prior mean and the prior variance of the mean, with a smaller prior variance indicating a stronger prior.</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>Note that $n$ (instead of $N$) is used here for the sample size to avoid confusion with the normal distribution.</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a><span class="fu">### For $\sigma^2 \mid \mu$</span></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>A conjugate prior for $\mu \mid \sigma^2$ is from the Inverse-Gamma family: $\sigma^2 \sim \text{Inv-Gamma}(\nu_0 / 2, \nu_0 \sigma^2_0 / 2)$. You usually only hear about the Inverse-Gamma distribution in Gibbs sampling, mainly because of conjugacy. As the name suggested, the Inverse-Gamma distribution is the distribution of the *inverse* of a variable that follows a Gamma distribution. So we also write</span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>$1 / \sigma^2 \sim \mathrm{Gamma}(\nu_0 / 2, \nu_0 \sigma^2_0 / 2)$.</span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>The Gamma distribution used here is also called a scaled $\chi^2$ distribution by some authors, with $\mathrm{Gamma}(\nu_0 / 2, \nu_0 \sigma^2_0 / 2)$ being the same as $\chi^2(\nu_0, \sigma^2_0)$.</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>The posterior is also Inverse-Gamma, with</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>1 / \sigma^2 \mid \mu^2, y \sim \mathrm{Gamma}(\nu_n / 2, \nu_n \sigma^2_n <span class="co">[</span><span class="ot">\mu</span><span class="co">]</span> / 2),</span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>  \nu_n &amp; = \nu_0 + n <span class="sc">\\</span></span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>  \sigma^2_n (\mu) &amp; = \frac{1}{\nu_n} \left<span class="co">[</span><span class="ot">\nu_0 \sigma^2_0 + (n - 1) s^2_y + \sum (\bar y - \mu)^2\right</span><span class="co">]</span></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a>\end{aligned},</span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a>with $s^2_y = \sum (y_i - \bar y)^2 / (n - 1)$ being the sample variance of $y$. The hyperparameters, $\nu_0$ and $\sigma^2_0$, can be considered the prior degrees of freedom and prior expected value of variance; $\nu_0$ can be roughly considered as the prior sample size.</span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prior, Model, and Posterior</span></span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>We will use some weakly informative priors, written in the following equations:</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>Model:</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>$$\text{wc<span class="sc">\_</span>laptop}_i \sim N(\mu, \sigma^2)$$</span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>Prior:</span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>  \begin{aligned}</span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>    \mu &amp; \sim N(5, 10^2) <span class="sc">\\</span></span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>    1 / \sigma^2 &amp; \sim \mathrm{Gamma}(1 / 2, <span class="co">[</span><span class="ot">1</span><span class="co">] [1]</span> / 2)</span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>  \end{aligned}</span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>The priors are very weak. We also assume that the priors are independent, which is commonly the case. Here are some simulated data from these priors:</span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ppd-gibbs</span></span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Prior predictive distributions."</span></span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2259</span>)</span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>num_draws <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(num_draws, <span class="at">mean =</span> <span class="dv">5</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a>inv_sigma2 <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(num_draws,</span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>                     <span class="at">shape =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>, <span class="at">rate =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>num_obs <span class="ot">&lt;-</span> <span class="fu">length</span>(wc_laptop)</span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an S by N matrix to store the simulated data</span></span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a>y_tilde <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,</span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> num_draws,</span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> num_obs)</span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">seq_len</span>(num_draws)) {</span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a>    mu_s <span class="ot">&lt;-</span> mu[s]</span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>    sigma2_s <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> inv_sigma2[s]</span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a>    y_tilde[s, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(num_obs, <span class="at">mean =</span> mu_s, <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma2_s))</span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the simulated data based on priors</span></span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a><span class="fu">ppd_dens_overlay</span>(y_tilde)</span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a>The plot shows the types of data one can get. One can do better by avoiding the negative values if desired.</span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Gibbs Sampler</span></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a>The following is the full Gibbs sampler for the above normal model.</span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Sufficient statistics from data</span></span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a>ybar <span class="ot">&lt;-</span> <span class="fu">mean</span>(wc_laptop)  <span class="co"># sample mean</span></span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a>s2y <span class="ot">&lt;-</span> <span class="fu">var</span>(wc_laptop)  <span class="co"># sample variance</span></span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(wc_laptop)  <span class="co"># sample size</span></span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Hyperparameters</span></span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a>mu_0 <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a>sigma2_0 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a>tau2_0 <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">2</span></span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>nu_0 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the Gibbs sampler</span></span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2120</span>)</span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a>num_draws <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a>num_warmup <span class="ot">&lt;-</span> num_draws <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a>num_chains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a 3-D array (S x # chains x 2 parameters)</span></span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a>post_all_draws <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">dim =</span> <span class="fu">c</span>(num_draws, num_chains, <span class="dv">2</span>),</span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, <span class="cn">NULL</span>, <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"sigma2"</span>))</span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: starting values for sigma2</span></span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a>post_all_draws[<span class="dv">1</span>, <span class="dv">1</span>, <span class="st">"sigma2"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># for chain 1</span></span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a>post_all_draws[<span class="dv">1</span>, <span class="dv">2</span>, <span class="st">"sigma2"</span>] <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># for chain 2</span></span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">seq_len</span>(num_draws <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(num_chains)) {</span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>        sigma2_s <span class="ot">&lt;-</span> post_all_draws[s, j, <span class="st">"sigma2"</span>]</span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 2: Sample mu from the conditional posterior</span></span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a>        tau2_n <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">/</span> tau2_0 <span class="sc">+</span> n <span class="sc">/</span> sigma2_s)</span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a>        mu_n <span class="ot">&lt;-</span> tau2_n <span class="sc">*</span> (mu_0 <span class="sc">/</span> tau2_0 <span class="sc">+</span> n <span class="sc">*</span> ybar <span class="sc">/</span> sigma2_s)</span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a>        mu_new <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> mu_n, <span class="at">sd =</span> <span class="fu">sqrt</span>(tau2_n))</span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a>        post_all_draws[s <span class="sc">+</span> <span class="dv">1</span>, j, <span class="st">"mu"</span>] <span class="ot">&lt;-</span> mu_new</span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 3: Sample sigma2 from the conditional posterior</span></span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a>        nu_n <span class="ot">&lt;-</span> nu_0 <span class="sc">+</span> n  <span class="co"># you could put this line outside the loop</span></span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a>        sigma2_n <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> nu_n <span class="sc">*</span></span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a>            (nu_0 <span class="sc">*</span> sigma2_0 <span class="sc">+</span> (n <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> s2y <span class="sc">+</span> (ybar <span class="sc">-</span> mu_new)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a>        sigma2_new <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">rgamma</span>(<span class="dv">1</span>,</span>
<span id="cb17-204"><a href="#cb17-204" aria-hidden="true" tabindex="-1"></a>            <span class="at">shape =</span> nu_n <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb17-205"><a href="#cb17-205" aria-hidden="true" tabindex="-1"></a>            <span class="at">rate =</span> nu_n <span class="sc">*</span> sigma2_n <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a>        post_all_draws[s <span class="sc">+</span> <span class="dv">1</span>, j, <span class="st">"sigma2"</span>] <span class="ot">&lt;-</span> sigma2_new</span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Draws after warm-up</span></span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a>post_draws <span class="ot">&lt;-</span> post_all_draws[<span class="sc">-</span> (<span class="dv">1</span><span class="sc">:</span>num_warmup), , ]</span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualizing the Jumps</span></span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a>The plot below shows the jumps for 20 iterations in one chain, with the intermediate steps.</span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-221"><a href="#cb17-221" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb17-222"><a href="#cb17-222" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-jumps-gibbs</span></span>
<span id="cb17-223"><a href="#cb17-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Jumps in the Gibbs sampler across iterations."</span></span>
<span id="cb17-224"><a href="#cb17-224" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb17-225"><a href="#cb17-225" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu =</span> post_draws[<span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">rep</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">each =</span> <span class="dv">2</span>)), <span class="dv">1</span>, <span class="st">"mu"</span>],</span>
<span id="cb17-226"><a href="#cb17-226" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma2 =</span> post_draws[<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">19</span>, <span class="at">each =</span> <span class="dv">2</span>), <span class="dv">20</span>), <span class="dv">1</span>, <span class="st">"sigma2"</span>]</span>
<span id="cb17-227"><a href="#cb17-227" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb17-228"><a href="#cb17-228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu, <span class="at">y =</span> sigma2)) <span class="sc">+</span></span>
<span id="cb17-229"><a href="#cb17-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_path</span>() <span class="sc">+</span></span>
<span id="cb17-230"><a href="#cb17-230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb17-231"><a href="#cb17-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu), <span class="at">y =</span> <span class="fu">expression</span>(sigma<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb17-232"><a href="#cb17-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-233"><a href="#cb17-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-234"><a href="#cb17-234" aria-hidden="true" tabindex="-1"></a><span class="fu">### Convergence Check</span></span>
<span id="cb17-235"><a href="#cb17-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-238"><a href="#cb17-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-239"><a href="#cb17-239" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-gibbs-trace</span></span>
<span id="cb17-240"><a href="#cb17-240" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-nrow: 2</span></span>
<span id="cb17-241"><a href="#cb17-241" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Diagnostic plots for the Gibbs sampler."</span></span>
<span id="cb17-242"><a href="#cb17-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap:</span></span>
<span id="cb17-243"><a href="#cb17-243" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Trace plots."</span></span>
<span id="cb17-244"><a href="#cb17-244" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Rank histograms."</span></span>
<span id="cb17-245"><a href="#cb17-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to `draws_array` object to use the following functions</span></span>
<span id="cb17-246"><a href="#cb17-246" aria-hidden="true" tabindex="-1"></a>post_draws_array <span class="ot">&lt;-</span> <span class="fu">as_draws_array</span>(post_draws)</span>
<span id="cb17-247"><a href="#cb17-247" aria-hidden="true" tabindex="-1"></a><span class="co"># Trace plots</span></span>
<span id="cb17-248"><a href="#cb17-248" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(post_draws_array)  <span class="co"># good mixing</span></span>
<span id="cb17-249"><a href="#cb17-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Rank histograms</span></span>
<span id="cb17-250"><a href="#cb17-250" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_rank_hist</span>(post_draws_array)  <span class="co"># good mixing</span></span>
<span id="cb17-251"><a href="#cb17-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-252"><a href="#cb17-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-255"><a href="#cb17-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-256"><a href="#cb17-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary (with rhat and ESS)</span></span>
<span id="cb17-257"><a href="#cb17-257" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize_draws</span>(post_draws_array) <span class="sc">|&gt;</span></span>
<span id="cb17-258"><a href="#cb17-258" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb17-259"><a href="#cb17-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-260"><a href="#cb17-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-261"><a href="#cb17-261" aria-hidden="true" tabindex="-1"></a>As can be seen, the ESS is very high, indeed much higher than that obtained with the Metropolis algorithm.</span>
<span id="cb17-262"><a href="#cb17-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-263"><a href="#cb17-263" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing the Marginal and Joint Posterior</span></span>
<span id="cb17-264"><a href="#cb17-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-267"><a href="#cb17-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-268"><a href="#cb17-268" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-gibbs-areas</span></span>
<span id="cb17-269"><a href="#cb17-269" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Marginal posterior distributions of model parameters."</span></span>
<span id="cb17-270"><a href="#cb17-270" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(post_draws_array)  <span class="co"># marginal</span></span>
<span id="cb17-271"><a href="#cb17-271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-272"><a href="#cb17-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-275"><a href="#cb17-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-276"><a href="#cb17-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-gibbs-scatter</span></span>
<span id="cb17-277"><a href="#cb17-277" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Joint posterior distributions of model parameters."</span></span>
<span id="cb17-278"><a href="#cb17-278" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_scatter</span>(post_draws_array,  <span class="co"># joint</span></span>
<span id="cb17-279"><a href="#cb17-279" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>)  <span class="co"># make points smaller</span></span>
<span id="cb17-280"><a href="#cb17-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-281"><a href="#cb17-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-282"><a href="#cb17-282" aria-hidden="true" tabindex="-1"></a><span class="fu">### Posterior Predictive Check</span></span>
<span id="cb17-283"><a href="#cb17-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-284"><a href="#cb17-284" aria-hidden="true" tabindex="-1"></a>We can check whether the simulated data based on the posterior look like the observed data.</span>
<span id="cb17-285"><a href="#cb17-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-288"><a href="#cb17-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-289"><a href="#cb17-289" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-gibbs-ppc</span></span>
<span id="cb17-290"><a href="#cb17-290" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Posterior predictive check."</span></span>
<span id="cb17-291"><a href="#cb17-291" aria-hidden="true" tabindex="-1"></a>num_draws <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb17-292"><a href="#cb17-292" aria-hidden="true" tabindex="-1"></a>num_obs <span class="ot">&lt;-</span> <span class="fu">length</span>(wc_laptop)</span>
<span id="cb17-293"><a href="#cb17-293" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an S by N matrix to store the simulated data</span></span>
<span id="cb17-294"><a href="#cb17-294" aria-hidden="true" tabindex="-1"></a>y_tilde <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,</span>
<span id="cb17-295"><a href="#cb17-295" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> num_draws,</span>
<span id="cb17-296"><a href="#cb17-296" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> num_obs)</span>
<span id="cb17-297"><a href="#cb17-297" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">seq_len</span>(num_draws)) {</span>
<span id="cb17-298"><a href="#cb17-298" aria-hidden="true" tabindex="-1"></a>    mu_s <span class="ot">&lt;-</span> post_draws[s, <span class="dv">1</span>, <span class="st">"mu"</span>]</span>
<span id="cb17-299"><a href="#cb17-299" aria-hidden="true" tabindex="-1"></a>    sigma2_s <span class="ot">&lt;-</span> post_draws[s, <span class="dv">1</span>, <span class="st">"sigma2"</span>]</span>
<span id="cb17-300"><a href="#cb17-300" aria-hidden="true" tabindex="-1"></a>    y_tilde[s, ] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(num_obs, <span class="at">mean =</span> mu_s, <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma2_s))</span>
<span id="cb17-301"><a href="#cb17-301" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-302"><a href="#cb17-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the simulated data (in lighter lines)</span></span>
<span id="cb17-303"><a href="#cb17-303" aria-hidden="true" tabindex="-1"></a><span class="co"># and the current data (in the darker line)</span></span>
<span id="cb17-304"><a href="#cb17-304" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(wc_laptop, <span class="at">yrep =</span> y_tilde)</span>
<span id="cb17-305"><a href="#cb17-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-306"><a href="#cb17-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-307"><a href="#cb17-307" aria-hidden="true" tabindex="-1"></a>The simulated data are not too far off from the observed data. Just that the simulated data can also get negative values.</span>
<span id="cb17-308"><a href="#cb17-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-309"><a href="#cb17-309" aria-hidden="true" tabindex="-1"></a><span class="fu">### Limitations of Gibbs Sampler</span></span>
<span id="cb17-310"><a href="#cb17-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-311"><a href="#cb17-311" aria-hidden="true" tabindex="-1"></a>The Gibbs sampler has been popular due to its computational efficiency for many problems. However, there are situations in which it works less well, such as when some parameters are highly correlated in the posterior, in which case a Gibbs sampler may get stuck. Another limitation is that Gibbs samplers require the use of conjugate priors. On the one hand, sometimes researcher beliefs may be better expressed in distributions other than the conjugate family. On the other hand, some conjugate families, such as the inverse Gamma distribution, are hard to work with and may yield suboptimal results in small sample situations.</span>
<span id="cb17-312"><a href="#cb17-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-313"><a href="#cb17-313" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Metropolis-Hastings Algorithm</span></span>
<span id="cb17-314"><a href="#cb17-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-315"><a href="#cb17-315" aria-hidden="true" tabindex="-1"></a>The Metropolis-Hastings (MH) algorithm is a generalization of the Metropolis algorithm, where it allows for more than one parameter and can use a proposal distribution that is not symmetric. It is less efficient than the Gibbs sampler but can accommodate non-conjugate prior distributions. Note that the proposal distribution needs to have the same dimension as the posterior so that the proposal is a vector in the parameter space. For example, we need a bivariate proposal density with $\mu$ and $\sigma$. </span>
<span id="cb17-316"><a href="#cb17-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-317"><a href="#cb17-317" aria-hidden="true" tabindex="-1"></a>Below is an example using a bivariate normal distribution for the proposal. While we can choose how correlated the variables are in the proposal, for simplicity, I just consider zero correlation and equal *SD* for both dimensions. I also parameterize the normal distribution by the mean, $\mu$, and the standard deviation (instead of the variance), $\sigma$. The priors are:</span>
<span id="cb17-318"><a href="#cb17-318" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-319"><a href="#cb17-319" aria-hidden="true" tabindex="-1"></a>  \begin{aligned}</span>
<span id="cb17-320"><a href="#cb17-320" aria-hidden="true" tabindex="-1"></a>    \mu &amp; \sim N(5, 10^2) <span class="sc">\\</span></span>
<span id="cb17-321"><a href="#cb17-321" aria-hidden="true" tabindex="-1"></a>    \sigma &amp; \sim N^+(0, 3)</span>
<span id="cb17-322"><a href="#cb17-322" aria-hidden="true" tabindex="-1"></a>  \end{aligned},</span>
<span id="cb17-323"><a href="#cb17-323" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb17-324"><a href="#cb17-324" aria-hidden="true" tabindex="-1"></a>where $N^+$ is a half-normal distribution because $\sigma$ is non-negative. We'll revisit this for some later models.</span>
<span id="cb17-325"><a href="#cb17-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-326"><a href="#cb17-326" aria-hidden="true" tabindex="-1"></a>Here is the code for the MH algorithm:</span>
<span id="cb17-327"><a href="#cb17-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-330"><a href="#cb17-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-331"><a href="#cb17-331" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to compute values proportional to p(y | th) * p(th)</span></span>
<span id="cb17-332"><a href="#cb17-332" aria-hidden="true" tabindex="-1"></a>prior_times_lik <span class="ot">&lt;-</span> <span class="cf">function</span>(mu_sigma, <span class="at">y =</span> wc_laptop) {</span>
<span id="cb17-333"><a href="#cb17-333" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> mu_sigma[<span class="dv">1</span>]</span>
<span id="cb17-334"><a href="#cb17-334" aria-hidden="true" tabindex="-1"></a>    sigma <span class="ot">&lt;-</span> mu_sigma[<span class="dv">2</span>]</span>
<span id="cb17-335"><a href="#cb17-335" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return 0 if sigma is out of range</span></span>
<span id="cb17-336"><a href="#cb17-336" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (sigma <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb17-337"><a href="#cb17-337" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Joint prior = product of marginal priors</span></span>
<span id="cb17-338"><a href="#cb17-338" aria-hidden="true" tabindex="-1"></a>    pth <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(mu, <span class="at">mean =</span> <span class="dv">5</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="sc">*</span></span>
<span id="cb17-339"><a href="#cb17-339" aria-hidden="true" tabindex="-1"></a>        <span class="co"># half-normal is proportional to normal in [0, infinity)</span></span>
<span id="cb17-340"><a href="#cb17-340" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dnorm</span>(sigma, <span class="at">sd =</span> <span class="dv">3</span>)</span>
<span id="cb17-341"><a href="#cb17-341" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Likelihood</span></span>
<span id="cb17-342"><a href="#cb17-342" aria-hidden="true" tabindex="-1"></a>    py_given_th <span class="ot">&lt;-</span> <span class="fu">prod</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma))</span>
<span id="cb17-343"><a href="#cb17-343" aria-hidden="true" tabindex="-1"></a>    pth <span class="sc">*</span> py_given_th</span>
<span id="cb17-344"><a href="#cb17-344" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-345"><a href="#cb17-345" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function for generating data from the proposal distribution</span></span>
<span id="cb17-346"><a href="#cb17-346" aria-hidden="true" tabindex="-1"></a>generate_proposal <span class="ot">&lt;-</span> <span class="cf">function</span>(mu_sigma, <span class="at">sd =</span> <span class="fl">0.1</span>) {</span>
<span id="cb17-347"><a href="#cb17-347" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="fu">length</span>(mu_sigma), <span class="at">mean =</span> mu_sigma, <span class="at">sd =</span> sd)</span>
<span id="cb17-348"><a href="#cb17-348" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-349"><a href="#cb17-349" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the Metropolis algorithm</span></span>
<span id="cb17-350"><a href="#cb17-350" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1051</span>)  <span class="co"># set the seed for reproducibility</span></span>
<span id="cb17-351"><a href="#cb17-351" aria-hidden="true" tabindex="-1"></a>num_draws <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb17-352"><a href="#cb17-352" aria-hidden="true" tabindex="-1"></a>num_warmup <span class="ot">&lt;-</span> num_draws <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb17-353"><a href="#cb17-353" aria-hidden="true" tabindex="-1"></a>num_chains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb17-354"><a href="#cb17-354" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a 3-D array (S x # chains x 2 parameters)</span></span>
<span id="cb17-355"><a href="#cb17-355" aria-hidden="true" tabindex="-1"></a>post_all_draws <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb17-356"><a href="#cb17-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">dim =</span> <span class="fu">c</span>(num_draws, num_chains, <span class="dv">2</span>),</span>
<span id="cb17-357"><a href="#cb17-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, <span class="cn">NULL</span>, <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"sigma"</span>))</span>
<span id="cb17-358"><a href="#cb17-358" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-359"><a href="#cb17-359" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: starting value</span></span>
<span id="cb17-360"><a href="#cb17-360" aria-hidden="true" tabindex="-1"></a>post_all_draws[<span class="dv">1</span>, <span class="dv">1</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)  <span class="co"># for chain 1</span></span>
<span id="cb17-361"><a href="#cb17-361" aria-hidden="true" tabindex="-1"></a>post_all_draws[<span class="dv">1</span>, <span class="dv">2</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">3</span>)  <span class="co"># for chain 2</span></span>
<span id="cb17-362"><a href="#cb17-362" aria-hidden="true" tabindex="-1"></a><span class="co"># counter for tracking acceptance rate</span></span>
<span id="cb17-363"><a href="#cb17-363" aria-hidden="true" tabindex="-1"></a>num_accepted <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, num_chains)</span>
<span id="cb17-364"><a href="#cb17-364" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">seq_len</span>(num_draws <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb17-365"><a href="#cb17-365" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(num_chains)) {</span>
<span id="cb17-366"><a href="#cb17-366" aria-hidden="true" tabindex="-1"></a>        current_par <span class="ot">&lt;-</span> post_all_draws[s, j, ]</span>
<span id="cb17-367"><a href="#cb17-367" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate proposal vector</span></span>
<span id="cb17-368"><a href="#cb17-368" aria-hidden="true" tabindex="-1"></a>        proposed_par <span class="ot">&lt;-</span> <span class="fu">generate_proposal</span>(current_par, <span class="at">sd =</span> <span class="fl">0.1</span>)</span>
<span id="cb17-369"><a href="#cb17-369" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute acceptance probability</span></span>
<span id="cb17-370"><a href="#cb17-370" aria-hidden="true" tabindex="-1"></a>        prob_accept <span class="ot">&lt;-</span> <span class="fu">min</span>(</span>
<span id="cb17-371"><a href="#cb17-371" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span>,</span>
<span id="cb17-372"><a href="#cb17-372" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior_times_lik</span>(proposed_par) <span class="sc">/</span></span>
<span id="cb17-373"><a href="#cb17-373" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior_times_lik</span>(current_par)</span>
<span id="cb17-374"><a href="#cb17-374" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-375"><a href="#cb17-375" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine whether to make the jump</span></span>
<span id="cb17-376"><a href="#cb17-376" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> prob_accept) {</span>
<span id="cb17-377"><a href="#cb17-377" aria-hidden="true" tabindex="-1"></a>            post_all_draws[s <span class="sc">+</span> <span class="dv">1</span>, j, ] <span class="ot">&lt;-</span> proposed_par</span>
<span id="cb17-378"><a href="#cb17-378" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (s <span class="sc">+</span> <span class="dv">1</span> <span class="sc">&gt;=</span> num_warmup) {</span>
<span id="cb17-379"><a href="#cb17-379" aria-hidden="true" tabindex="-1"></a>                num_accepted[j] <span class="ot">&lt;-</span> num_accepted[j] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb17-380"><a href="#cb17-380" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb17-381"><a href="#cb17-381" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb17-382"><a href="#cb17-382" aria-hidden="true" tabindex="-1"></a>            post_all_draws[s <span class="sc">+</span> <span class="dv">1</span>, j, ] <span class="ot">&lt;-</span> current_par</span>
<span id="cb17-383"><a href="#cb17-383" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb17-384"><a href="#cb17-384" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-385"><a href="#cb17-385" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-386"><a href="#cb17-386" aria-hidden="true" tabindex="-1"></a><span class="co"># Draws after warm-up</span></span>
<span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a>post_draws <span class="ot">&lt;-</span> post_all_draws[<span class="sc">-</span> (<span class="dv">1</span><span class="sc">:</span>num_warmup), , ]</span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a><span class="co"># Acceptance rate</span></span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(num_accepted) <span class="sc">/</span> <span class="fu">length</span>(post_draws)</span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a><span class="fu">### Convergence</span></span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-mh-trace</span></span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-nrow: 2</span></span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Diagnostic plots for the MH sampler."</span></span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap:</span></span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Trace plots."</span></span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Rank histograms."</span></span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to `draws_array` object to use the following functions</span></span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a>post_draws_array <span class="ot">&lt;-</span> <span class="fu">as_draws_array</span>(post_draws)</span>
<span id="cb17-405"><a href="#cb17-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Trace plots</span></span>
<span id="cb17-406"><a href="#cb17-406" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(post_draws_array)  <span class="co"># good mixing</span></span>
<span id="cb17-407"><a href="#cb17-407" aria-hidden="true" tabindex="-1"></a><span class="co"># Rank histograms</span></span>
<span id="cb17-408"><a href="#cb17-408" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_rank_hist</span>(post_draws_array)  <span class="co"># good mixing</span></span>
<span id="cb17-409"><a href="#cb17-409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-410"><a href="#cb17-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-413"><a href="#cb17-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb17-414"><a href="#cb17-414" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary (with rhat and ESS)</span></span>
<span id="cb17-415"><a href="#cb17-415" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize_draws</span>(post_draws_array) <span class="sc">|&gt;</span></span>
<span id="cb17-416"><a href="#cb17-416" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb17-417"><a href="#cb17-417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-418"><a href="#cb17-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-419"><a href="#cb17-419" aria-hidden="true" tabindex="-1"></a>As can be seen, ESS is much lower, so more iterations will be needed with MH.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2024, Hok Chio (Mark) Lai</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>