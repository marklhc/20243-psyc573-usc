<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.33">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>12&nbsp; Stacking, Regularization, and Variable Selection â€“ PSYC 573 Bayesian Data Analysis (2024 Fall): Course Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./08-causal-inference.html" rel="next">
<link href="./07-model-comparison.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-07ba0ad10f5680c660e360ac31d2f3b6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6d9163938730c4bb45bb2ddd9242afb9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-225295148', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">PSYC 573 Bayesian Data Analysis (2024 Fall): Course Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="./../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../modules.html"> 
<span class="menu-text">Modules</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../docs/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../exercises/index.html"> 
<span class="menu-text">Exercises</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../syllabus/index.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/marklhc/usc-psyc573-notes" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./PSYC-573-Bayesian-Data-Analysis--2024-Fall---Course-Notes.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./07-model-comparison.html">Week 7</a></li><li class="breadcrumb-item"><a href="./07b-stacking-and-regularization.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Stacking, Regularization, and Variable Selection</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-probability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Probability</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-bayes-theorem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayesâ€™s Theorem</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 3</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-beta-bernoulli-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Beta-Bernoulli Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04b-beta-bernoulli-stan.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Beta-Bernoulli Model With Stan</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04c-poisson-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Poisson Model</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 4</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-hierarchical-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Hierarchical Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 5â€“6</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-linear-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Linear Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06b-multiple-predictors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Multiple Predictors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06c-regression-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model Diagnostics</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 7</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-model-comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Model Comparison</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07b-stacking-and-regularization.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Stacking, Regularization, and Variable Selection</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 9</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-causal-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Causal Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08b-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Mediation</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 10â€“11</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09b-gibbs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Gibbs Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09c-hmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Hamiltonian Monte Carlo</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 12</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-glm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Generalized Linear Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10b-glm2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Generalized Linear Model (II)</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#stackingmodel-averaging" id="toc-stackingmodel-averaging" class="nav-link active" data-scroll-target="#stackingmodel-averaging"><span class="header-section-number">12.1</span> Stacking/Model Averaging</a>
  <ul class="collapse">
<li><a href="#model-weights" id="toc-model-weights" class="nav-link" data-scroll-target="#model-weights"><span class="header-section-number">12.1.1</span> Model Weights</a></li>
  <li><a href="#stacking" id="toc-stacking" class="nav-link" data-scroll-target="#stacking"><span class="header-section-number">12.1.2</span> Stacking</a></li>
  <li><a href="#prediction-example" id="toc-prediction-example" class="nav-link" data-scroll-target="#prediction-example"><span class="header-section-number">12.1.3</span> Prediction example</a></li>
  </ul>
</li>
  <li>
<a href="#shrinkage-priors" id="toc-shrinkage-priors" class="nav-link" data-scroll-target="#shrinkage-priors"><span class="header-section-number">12.2</span> Shrinkage Priors</a>
  <ul class="collapse">
<li><a href="#number-of-parameters" id="toc-number-of-parameters" class="nav-link" data-scroll-target="#number-of-parameters"><span class="header-section-number">12.2.1</span> Number of parameters</a></li>
  <li><a href="#sparsity-inducing-priors" id="toc-sparsity-inducing-priors" class="nav-link" data-scroll-target="#sparsity-inducing-priors"><span class="header-section-number">12.2.2</span> Sparsity-Inducing Priors</a></li>
  <li><a href="#regularized-horseshoehierarchical-shrinkage" id="toc-regularized-horseshoehierarchical-shrinkage" class="nav-link" data-scroll-target="#regularized-horseshoehierarchical-shrinkage"><span class="header-section-number">12.2.3</span> Regularized Horseshoe/Hierarchical Shrinkage</a></li>
  </ul>
</li>
  <li>
<a href="#variable-selection" id="toc-variable-selection" class="nav-link" data-scroll-target="#variable-selection"><span class="header-section-number">12.3</span> Variable Selection</a>
  <ul class="collapse">
<li><a href="#projection-based-method" id="toc-projection-based-method" class="nav-link" data-scroll-target="#projection-based-method"><span class="header-section-number">12.3.1</span> Projection-Based Method</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./07-model-comparison.html">Week 7</a></li><li class="breadcrumb-item"><a href="./07b-stacking-and-regularization.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Stacking, Regularization, and Variable Selection</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Stacking, Regularization, and Variable Selection</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="stackingmodel-averaging" class="level2" data-number="12.1"><h2 data-number="12.1" class="anchored" data-anchor-id="stackingmodel-averaging">
<span class="header-section-number">12.1</span> Stacking/Model Averaging</h2>
<p>Sometimes it may not be a good practice to only choose one model with low WAIC or LOO-IC, especially when several models have very imilar WAIC/LOO-IC, but they make somewhat different predictions. Instead, we can perform <em>stacking</em> or <em>model averaging</em> by weighting the <em>predictions</em> from multiple models, using weights that are based on their information criteria performance. Stacking approaches this by optimizing the leave-one-out mean squared error in the resulting prediction, whereas model averaging preserves the uncertainty and was not optimized for that task. The technical details can be found in <span class="citation" data-cites="yao2018">Yao et al. (<a href="references.html#ref-yao2018" role="doc-biblioref">2018</a>)</span>.</p>
<p>Note that the conventional Bayesian model averaging used the posterior model probability <span class="citation" data-cites="hoeting1999">(<a href="references.html#ref-hoeting1999" role="doc-biblioref">Hoeting et al., 1999</a>)</span>, which are approximated by the BIC. The discussion in this note is based on more recent discussion in, e.g., <span class="citation" data-cites="yao2018">Yao et al. (<a href="references.html#ref-yao2018" role="doc-biblioref">2018</a>)</span>.</p>
<p>Weâ€™ll use a data set <code>kidiq</code> that is used in the textbook by <span class="citation" data-cites="gelman2021">Gelman et al. (<a href="references.html#ref-gelman2021" role="doc-biblioref">2021</a>)</span>, which can be downloaded and imported with the direct link:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kidiq</span> <span class="op">&lt;-</span> <span class="fu">haven</span><span class="fu">::</span><span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta</a></span><span class="op">(</span><span class="st">"http://www.stat.columbia.edu/~gelman/arm/examples/child.iq/kidiq.dta"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">kidiq</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["kid_score"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["mom_hs"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["mom_iq"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["mom_work"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["mom_age"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"65","2":"1","3":"121.11753","4":"4","5":"27"},{"1":"98","2":"1","3":"89.36188","4":"4","5":"25"},{"1":"85","2":"1","3":"115.44316","4":"4","5":"27"},{"1":"83","2":"1","3":"99.44964","4":"3","5":"25"},{"1":"115","2":"1","3":"92.74571","4":"4","5":"27"},{"1":"98","2":"0","3":"107.90184","4":"1","5":"18"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Letâ€™s run four models. First rescale some of the variables:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kidiq100</span> <span class="op">&lt;-</span> <span class="va">kidiq</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mom_iq <span class="op">=</span> <span class="va">mom_iq</span> <span class="op">/</span> <span class="fl">100</span>,  <span class="co"># divid mom_iq by 100</span></span>
<span>         kid_score <span class="op">=</span> <span class="va">kid_score</span> <span class="op">/</span> <span class="fl">100</span>,   <span class="co"># divide kid_score by 100</span></span>
<span>         mom_iq_c <span class="op">=</span> <span class="va">mom_iq</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>         mom_hs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">mom_hs</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"no"</span>, <span class="st">"yes"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         mom_age_c <span class="op">=</span> <span class="op">(</span><span class="va">mom_age</span> <span class="op">-</span> <span class="fl">18</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I will run four models, which is from the last note</p>
<p><span class="math display">\[
\texttt{kidscore}_i \sim N(\mu_i, \sigma)
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
  \mu_i &amp; = \beta_0 + \beta_1 (\texttt{mom\_iq}_i)  \\
  \mu_i &amp; = \beta_0 + \beta_1 (\texttt{mom\_iq}_i) +
            \beta_2 (\texttt{mom\_hs}_i) \\
  \mu_i &amp; = \beta_0 + \beta_1 (\texttt{mom\_iq}_i) +
            \beta_2 (\texttt{mom\_hs}_i) + \beta_3 (\texttt{mom\_iq}_i \times
                                                    \texttt{mom\_hs}_i)  \\
  \mu_i &amp; = \beta_0 + \beta_1 (\texttt{mom\_iq}_i) +
            \beta_2 (\texttt{mom\_hs}_i) +
            \beta_3 (\texttt{mom\_iq}_i \times \texttt{mom\_hs}_i) +
            \beta_4 (\texttt{mom\_age}_i)
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">kid_score</span> <span class="op">~</span> <span class="va">mom_iq_c</span>,</span>
<span>    data <span class="op">=</span> <span class="va">kidiq100</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2302</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"07b_m1"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rstan</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: StanHeaders</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
rstan version 2.32.5 (Stan version 2.32.2)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores()).
To avoid recompilation of unchanged Stan programs, we recommend calling
rstan_options(auto_write = TRUE)
For within-chain threading using `reduce_sum()` or `map_rect()` Stan functions,
change `threads_per_chain` option:
rstan_options(threads_per_chain = 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'rstan'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:tidyr':

    extract</code></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">add_criterion</span><span class="op">(</span><span class="va">m1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Automatically saving the model object in '07b_m1.rds'</code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Use `update` will sometimes avoid recompiling</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">kid_score</span> <span class="op">~</span> <span class="va">mom_iq_c</span> <span class="op">+</span> <span class="va">mom_hs</span>,</span>
<span>    newdata <span class="op">=</span> <span class="va">kidiq100</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"07b_m2"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">add_criterion</span><span class="op">(</span><span class="va">m2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Automatically saving the model object in '07b_m2.rds'</code></pre>
</div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">m2</span>, <span class="va">kid_score</span> <span class="op">~</span> <span class="va">mom_iq_c</span> <span class="op">*</span> <span class="va">mom_hs</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>        class <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>        coef <span class="op">=</span> <span class="st">"mom_iq_c:mom_hsyes"</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"07b_m3"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The desired updates require recompiling the model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu">add_criterion</span><span class="op">(</span><span class="va">m3</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Automatically saving the model object in '07b_m3.rds'</code></pre>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">m3</span>, <span class="va">kid_score</span> <span class="op">~</span> <span class="va">mom_iq_c</span> <span class="op">*</span> <span class="va">mom_hs</span> <span class="op">+</span> <span class="va">mom_age_c</span>,</span>
<span>    newdata <span class="op">=</span> <span class="va">kidiq100</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"07b_m4"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The desired updates require recompiling the model
Start sampling</code></pre>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu">add_criterion</span><span class="op">(</span><span class="va">m4</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
1 (0.2%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Automatically saving the model object in '07b_m4.rds'</code></pre>
</div>
</div>
<section id="model-weights" class="level3" data-number="12.1.1"><h3 data-number="12.1.1" class="anchored" data-anchor-id="model-weights">
<span class="header-section-number">12.1.1</span> Model Weights</h3>
<p>We can see that <code>m3</code> and <code>m4</code> gave the best LOO-IC and WAIC:</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">loo_compare</span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, <span class="va">m3</span>, <span class="va">m4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   elpd_diff se_diff
m3  0.0       0.0   
m4 -0.6       1.1   
m2 -3.5       2.5   
m1 -6.0       3.9   </code></pre>
</div>
</div>
<p>So it makes sense that if weâ€™re to assign weights, <code>m4</code> should get most weights. Letâ€™s check the following:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Weights based on WAIC</span></span>
<span><span class="va">waic_wts</span> <span class="op">&lt;-</span> <span class="fu">model_weights</span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, <span class="va">m3</span>, <span class="va">m4</span>, weights <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span></span>
<span><span class="co"># Weights based on Stacking (based on the posterior predictive distribution)</span></span>
<span><span class="va">stack_wts</span> <span class="op">&lt;-</span> <span class="fu">loo_model_weights</span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, <span class="va">m3</span>, <span class="va">m4</span><span class="op">)</span></span>
<span><span class="co"># Print out the weights</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">waic_wts</span>, <span class="va">stack_wts</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   waic_wts stack_wts
m1    0.002     0.100
m2    0.019     0.000
m3    0.635     0.882
m4    0.344     0.018</code></pre>
</div>
</div>
<p>You can see <code>m3</code> would get the highest weight, but itâ€™s only 0.6352557 and thus less than half of the weights when all four models are considered together.</p>
<p>In Bayesian, we want to preserve all the uncertainty in our analyses. Therefore, if weâ€™re not certain which models to use and have tried multiple ones, it would make sense to use all of them to get the best information. So unlike what is commonly done in practice where a researcher would test multiple models and present the best model <em>as if</em> they intended only to test this model, Bayesian analysts should do the honest thing and use all models. The reward is usually better prediction!</p>
</section><section id="stacking" class="level3" data-number="12.1.2"><h3 data-number="12.1.2" class="anchored" data-anchor-id="stacking">
<span class="header-section-number">12.1.2</span> Stacking</h3>
<p>Stacking is one way to combine the predictions of different models. The technical details can be found in <span class="citation" data-cites="yao2018">Yao et al. (<a href="references.html#ref-yao2018" role="doc-biblioref">2018</a>)</span>, but you can obtain the predictions using the <code>pp_average</code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Prediction from stacking by Yao et al. (2018)</span></span>
<span><span class="va">pred_stacking</span> <span class="op">&lt;-</span> <span class="fu">pp_average</span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, <span class="va">m3</span>, <span class="va">m4</span><span class="op">)</span></span>
<span><span class="co"># Compare the weights</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pred_stacking</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="prediction-example" class="level3" data-number="12.1.3"><h3 data-number="12.1.3" class="anchored" data-anchor-id="prediction-example">
<span class="header-section-number">12.1.3</span> Prediction example</h3>
<p>Consider a kid whose motherâ€™s IQ is 120 (<code>mom_iq</code> = .2), motherâ€™s age is 40, (<code>mom_age_c</code> = 2.2), mother does not have a high school degree, and mother did not work in first three years of childâ€™s life (<code>mom_work</code> = 1). Then the prediction based on the various models are:</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">newkid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>mom_iq_c <span class="op">=</span> <span class="fl">.2</span>,</span>
<span>                     mom_age_c <span class="op">=</span> <span class="fl">2.2</span>,</span>
<span>                     mom_work <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     mom_hs <span class="op">=</span> <span class="st">"no"</span><span class="op">)</span></span>
<span><span class="co"># Visualize the prediction by different models</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>stacking <span class="op">=</span> <span class="fu">pp_average</span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, <span class="va">m3</span>, <span class="va">m4</span>, newdata <span class="op">=</span> <span class="va">newkid</span>,</span>
<span>                                 summary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>           m4 <span class="op">=</span> <span class="fu">posterior_predict</span><span class="op">(</span><span class="va">m4</span>, newdata <span class="op">=</span> <span class="va">newkid</span><span class="op">)</span>,</span>
<span>           m3 <span class="op">=</span> <span class="fu">posterior_predict</span><span class="op">(</span><span class="va">m3</span>, newdata <span class="op">=</span> <span class="va">newkid</span><span class="op">)</span>,</span>
<span>           m2 <span class="op">=</span> <span class="fu">posterior_predict</span><span class="op">(</span><span class="va">m2</span>, newdata <span class="op">=</span> <span class="va">newkid</span><span class="op">)</span>,</span>
<span>           m1 <span class="op">=</span> <span class="fu">posterior_predict</span><span class="op">(</span><span class="va">m1</span>, newdata <span class="op">=</span> <span class="va">newkid</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mcmc_intervals</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Check out this blog post https://mc-stan.org/loo/articles/loo2-weights.html for more information on stacking and Averaging.</p>
</section></section><section id="shrinkage-priors" class="level2" data-number="12.2"><h2 data-number="12.2" class="anchored" data-anchor-id="shrinkage-priors">
<span class="header-section-number">12.2</span> Shrinkage Priors</h2>
<p>When the number of parameters to be estimated is large relative to the amount of data available, ordinary least square (in frequentist) and estimation using non-informative or weakly informative priors tend to overfit. For example, fitting a 6th degree polynomial (with 8 parameters) on a data set with only 10 observations will severely overfit the data, making the results not generalizable. One way to avoid overfitting is to perform <em>regularization</em>, that is, to shrink some of the parameters to closer to zero. This makes the model fit less well to the existing data, but will be much more generalizable to an independent data set.</p>
<section id="number-of-parameters" class="level3" data-number="12.2.1"><h3 data-number="12.2.1" class="anchored" data-anchor-id="number-of-parameters">
<span class="header-section-number">12.2.1</span> Number of parameters</h3>
<p>In Bayesian analyses, the concept of number of parameters is a little vague. This is because the posterior distribution is a function of both the prior and the data. For non-informative priors, it would make sense to simply count the number of parameters. However, say one put a very strong prior on one of the regression coefficients, which has about 9 times the weights of the information contributed by the data:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>th <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">th</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dnorm</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">9</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"prior"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dnorm</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0.3</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"likelihood"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Density"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Then the posterior for the parameter only uses 1/10 of the information from the data! Therefore, it would make more sense to count this as 0.1 parameter, instead of 1 full parameter.</p>
<p>The concept of regularization is essentially to introduce a stronger prior so that the posterior is less likely to overfit the data, and the resulting model will have lower <em>effective number of parameters</em>, which, when done appropriately, would find a model that is more likely to generalize to external data sets.</p>
<p>In Bayesian methods, regularization can be done by choosing a prior on the coefficient that has a sharp peak at 0, but also has a heavy tail. One such prior is what is called the <em>horseshoe</em> prior. The discussion here is based on the blog pot by Michael Betancourt: <a href="https://betanalpha.github.io/assets/case_studies/bayes_sparse_regression.html" class="uri">https://betanalpha.github.io/assets/case_studies/bayes_sparse_regression.html</a></p>
<p>It should first be pointed out that these priors were based on the assumption that the predictors and the outcome has been scaled to have a standard deviation of one. So we will do this here:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># For variable selection, scale the predictor and outcome to have unit variance</span></span>
<span><span class="va">kidiq_std</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">kidiq</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">kidiq_std</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       kid_score    mom_hs     mom_iq    mom_work    mom_age
[1,] -1.06793237  0.521631  1.4078352  0.93422435  1.5602285
[2,]  0.54886757  0.521631 -0.7092079  0.93422435  0.8197811
[3,] -0.08805362  0.521631  1.0295443  0.93422435  1.5602285
[4,] -0.18604150  0.521631 -0.0366907  0.08776638  0.8197811
[5,]  1.38176451  0.521631 -0.4836193  0.93422435  1.5602285
[6,]  0.54886757 -1.912647  0.5267892 -1.60514956 -1.7717849</code></pre>
</div>
</div>
</section><section id="sparsity-inducing-priors" class="level3" data-number="12.2.2"><h3 data-number="12.2.2" class="anchored" data-anchor-id="sparsity-inducing-priors">
<span class="header-section-number">12.2.2</span> Sparsity-Inducing Priors</h3>
<p>The <em>horseshoe</em> prior <span class="citation" data-cites="carvalho2010">(<a href="references.html#ref-carvalho2010" role="doc-biblioref">Carvalho et al., 2010</a>)</span> is a type of hierarchical prior for regression models by introducing a global scale, <span class="math inline">\(\tau\)</span>, and local scale,<span class="math inline">\(\lambda_m\)</span>, parameters on the priors for the regression coefficients <span class="citation" data-cites="piironen2017">(<a href="references.html#ref-piironen2017" role="doc-biblioref">Piironen &amp; Vehtari, 2017</a>)</span>. Specifically, with <span class="math inline">\(p\)</span> predictors,</p>
<p><span class="math display">\[
\begin{aligned}
  Y_i &amp; \sim N(\mu_i, \sigma^2) \\
  \mu_i &amp; = \beta_0 + \sum_{m = 1}^p \beta_m X_m \\
  \beta_0 &amp; \sim N(0, 1) \\
  \beta_m &amp; \sim N(0, \tau \lambda_m) \\
  \lambda_m &amp; \sim \textrm{Cauchy}^+(0, 1)  \\
  \tau &amp; \sim \textrm{Cauchy}^+(0, \tau_0)
\end{aligned}
\]</span></p>
<p>The local scale, <span class="math inline">\(\lambda_m\)</span>, can flexibly shrink the coefficient to close to zero. Below is the implication of the prior on the shrinkage of <span class="math inline">\(\beta\)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>shrinkage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">shrinkage</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Cauchy.html">dcauchy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">x</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">x</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="va">x</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>    <span class="op">}</span>, n <span class="op">=</span> <span class="fl">501</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span></span>
<span>        axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.ticks.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_function()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The U-shape here means that, for coefficients that are weakly supported by the data, the horseshoe will shrink it to very close to zero, whereas for coefficients that are more strongly supported by the data, the horseshoe will not shrink it much.</p>
<p>The red curve in the following is one example for the resulting prior distribution on <span class="math inline">\(\beta\)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dhs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html">Vectorize</a></span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">df</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">ff</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lam</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">0</span>, sd <span class="op">=</span> <span class="va">lam</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">dt</a></span><span class="op">(</span><span class="va">lam</span>, <span class="va">df</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">y</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html">integrate</a></span><span class="op">(</span><span class="va">ff</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="cn">Inf</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dhs</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"HS"</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dnorm</span>, n <span class="op">=</span> <span class="fl">501</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"norm"</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_color_manual</span><span class="op">(</span><span class="st">""</span>,</span>
<span>        values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"black"</span><span class="op">)</span>,</span>
<span>        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"horseshoe(3)"</span>, <span class="st">"N(0, 1)"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylim</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.75</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Density for the regularized horseshoe prior with 3 degrees of freedom</figcaption></figure>
</div>
</div>
</div>
<p>Such a prior has more density at 0, but also more density for extreme values, as compared to a normal distribution. Thus, for coefficients with very weak evidence, the regularizing prior will shrink it to zero, whereas for coefficients with strong evidence, the shrinkage will be very small. This is called a horseshoe prior. In <code>brms</code>, one can specify it with <code>horseshoe()</code>, which is a stabilized version of the original horseshoe prior <span class="citation" data-cites="carvalho2010">(<a href="references.html#ref-carvalho2010" role="doc-biblioref">Carvalho et al., 2010</a>)</span>.</p>
</section><section id="regularized-horseshoehierarchical-shrinkage" class="level3" data-number="12.2.3"><h3 data-number="12.2.3" class="anchored" data-anchor-id="regularized-horseshoehierarchical-shrinkage">
<span class="header-section-number">12.2.3</span> Regularized Horseshoe/Hierarchical Shrinkage</h3>
<p>The regularized horseshoe (<a href="https://projecteuclid.org/euclid.ejs/1513306866" class="uri">https://projecteuclid.org/euclid.ejs/1513306866</a>) prior is</p>
<p><span class="math display">\[
\begin{aligned}
  \beta_m &amp; \sim N(0, \tau \tilde \lambda_m) \\
  \tilde \lambda_m &amp; = \frac{c \lambda_m}{\sqrt{c^2 + \tau^2 \lambda^2_m}} \\
  \lambda_m &amp; \sim \textrm{Cauchy}^+(0, 1)  \\
  c^2 &amp; \sim \textrm{Inv-Gamma}(\nu / 2, nu / 2 s^2) \\
  \tau &amp; \sim \textrm{Cauchy}^+(0, \tau_0)
\end{aligned}
\]</span></p>
<p>The additional parameters are chosen in the code below. First, fit a model without shrinkage:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># A model with all main and interaction effects</span></span>
<span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">kid_score</span> <span class="op">~</span> <span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>,</span>
<span>    data <span class="op">=</span> <span class="va">kidiq_std</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2217</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"07b_m5"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 1 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 1 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 1 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 1 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 1 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 1 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 1 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 1 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 1 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 1 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 1 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 1 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.1 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 2 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 2 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 2 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 2 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 2 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 2 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 2 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 2 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 2 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 2 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 2 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 2 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.1 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 3 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 3 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 3 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 3 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 3 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 3 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 3 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 3 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 3 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 3 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 3 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 3 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 0.1 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 4 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 4 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 4 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 4 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 4 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 4 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 4 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 4 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 4 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 4 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 4 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 4 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.6 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># A model with all main and interaction effects, and regularization</span></span>
<span><span class="va">m_hs</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">kid_score</span> <span class="op">~</span> <span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>,</span>
<span>    data <span class="op">=</span> <span class="va">kidiq_std</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>        <span class="co"># Prior guess of 20% of the terms are non-zero</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">horseshoe</span><span class="op">(</span>par_ratio <span class="op">=</span> <span class="fl">2</span> <span class="op">/</span> <span class="fl">8</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Need higher adapt_delta</span></span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">.995</span>, max_treedepth <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2217</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"07b_m_hs"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 1 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 1 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 1 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 1 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 1 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 1 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 1 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 1 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 1 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 1 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 1 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 1 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 2.7 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 2 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 2 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 2 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 2 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 2 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 2 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 2 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 2 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 2 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 2 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 2 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 2 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 1.8 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 3 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 3 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 3 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 3 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 3 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 3 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 3 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 3 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 3 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 3 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 3 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 3 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 2.4 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 4 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 4 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 4 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 4 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 4 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 4 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 4 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 4 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 4 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 4 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 4 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 4 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 3.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.5 seconds.
Total execution time: 10.2 seconds.</code></pre>
</div>
</div>
<p>We can plot the coefficients:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">m_hs</span>, variable <span class="op">=</span> <span class="st">"^b_"</span>,</span>
<span>          regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Show the shrinkage as orange, transparent dots</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="fu">posterior_summary</span><span class="op">(</span><span class="va">m5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"parameter"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">parameter</span> <span class="op">!=</span> <span class="st">"lp__"</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Estimate</span>, y <span class="op">=</span> <span class="va">parameter</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"orange"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.05</span>, <span class="fl">.05</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 3 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>An arbitrary cutoff is to select only coefficients with posterior means larger than .05, in which case only <code>mom_iq</code> and <code>mom_hs</code> and their interaction were supported by the data.</p>
<p>You can also double check that the regularized version has better LOO-IC:</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">loo</span><span class="op">(</span><span class="va">m5</span>, <span class="va">m_hs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Output of model 'm5':

Computed from 4000 by 434 log-likelihood matrix.

         Estimate   SE
elpd_loo   -567.3 14.4
p_loo        12.8  1.4
looic      1134.6 28.8
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.6, 2.0]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.

Output of model 'm_hs':

Computed from 4000 by 434 log-likelihood matrix.

         Estimate   SE
elpd_loo   -565.2 14.4
p_loo         8.5  0.9
looic      1130.5 28.9
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.5, 1.3]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.

Model comparisons:
     elpd_diff se_diff
m_hs  0.0       0.0   
m5   -2.1       2.3   </code></pre>
</div>
</div>
<p>And also that the effective number of parameters was smaller in <code>m_hs</code>.</p>
</section></section><section id="variable-selection" class="level2" data-number="12.3"><h2 data-number="12.3" class="anchored" data-anchor-id="variable-selection">
<span class="header-section-number">12.3</span> Variable Selection</h2>
<p>One way to identify variables that are relevant to predict a certain outcome is to use the projection-based method, as discussed in <a href="https://mc-stan.org/projpred/articles/projpred.html" class="uri">https://mc-stan.org/projpred/articles/projpred.html</a> and in <span class="citation" data-cites="piironen2020">Piironen et al. (<a href="references.html#ref-piironen2020" role="doc-biblioref">2020</a>)</span>.</p>
<p>Building from the full model with shrinkage priors, we first do a trial run to identify the importance of various variables in terms of their importance for prediction:</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get reference model</span></span>
<span><span class="va">refm_obj</span> <span class="op">&lt;-</span> <span class="fu">get_refmodel</span><span class="op">(</span><span class="va">m_hs</span><span class="op">)</span></span>
<span><span class="co"># Preliminary run to find `nterms_max`</span></span>
<span><span class="va">cvvs_fast</span> <span class="op">&lt;-</span> <span class="fu">cv_varsel</span><span class="op">(</span></span>
<span>    <span class="va">refm_obj</span>,</span>
<span>    validate_search <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-----
Running the search ...
10% of terms selected
20% of terms selected
30% of terms selected
40% of terms selected
50% of terms selected
60% of terms selected
70% of terms selected
80% of terms selected
90% of terms selected
100% of terms selected
-----
-----
Running the performance evaluation with `refit_prj = TRUE` ...
-----</code></pre>
</div>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># mlpd = mean log predictive density</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cvvs_fast</span>, stats <span class="op">=</span> <span class="st">"mlpd"</span>, ranking_nterms_max <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the plot, we find when the predictive performance starts to level off when we keep adding more terms to the model. In this case, it seems to be 4. Given that this is a trial run, weâ€™ll set <code>nterms_max</code> to 5, which is slightly higher.</p>
<p>We then set <code class="sourceCode r">validate_search <span class="ot">=</span> <span class="cn">FALSE</span></code> for a final run. For computational feasibility, weâ€™ll use 10-fold validation.</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># With 10-fold cross-validation</span></span>
<span><span class="va">cvvs</span> <span class="op">&lt;-</span> <span class="fu">cv_varsel</span><span class="op">(</span></span>
<span>    <span class="va">refm_obj</span>,</span>
<span>    validate_search <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    cv_method <span class="op">=</span> <span class="st">"kfold"</span>,</span>
<span>    K <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    nterms_max <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-----
Running the search using the full dataset ...
20% of terms selected
40% of terms selected
60% of terms selected
80% of terms selected
100% of terms selected
-----
-----
Refitting the reference model K = 10 times (using the fold-wise training data) ...
Running MCMC with 4 sequential chains...

Chain 1 finished in 2.2 seconds.
Chain 2 finished in 1.9 seconds.
Chain 3 finished in 2.2 seconds.
Chain 4 finished in 2.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.1 seconds.
Total execution time: 8.9 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 2.7 seconds.
Chain 2 finished in 2.5 seconds.
Chain 3 finished in 1.6 seconds.
Chain 4 finished in 2.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.3 seconds.
Total execution time: 9.7 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 1.4 seconds.
Chain 2 finished in 1.4 seconds.
Chain 3 finished in 3.4 seconds.
Chain 4 finished in 2.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.1 seconds.
Total execution time: 8.7 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 2.2 seconds.
Chain 2 finished in 1.6 seconds.
Chain 3 finished in 2.4 seconds.
Chain 4 finished in 1.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.0 seconds.
Total execution time: 8.4 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 1.7 seconds.
Chain 2 finished in 2.1 seconds.
Chain 3 finished in 3.3 seconds.
Chain 4 finished in 2.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.4 seconds.
Total execution time: 9.8 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 1.9 seconds.
Chain 2 finished in 2.0 seconds.
Chain 3 finished in 2.3 seconds.
Chain 4 finished in 2.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.2 seconds.
Total execution time: 9.1 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 2.0 seconds.
Chain 2 finished in 1.6 seconds.
Chain 3 finished in 2.2 seconds.
Chain 4 finished in 1.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.9 seconds.
Total execution time: 7.9 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 1.6 seconds.
Chain 2 finished in 1.5 seconds.
Chain 3 finished in 2.1 seconds.
Chain 4 finished in 2.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.8 seconds.
Total execution time: 7.5 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 1.7 seconds.
Chain 2 finished in 1.5 seconds.
Chain 3 finished in 2.2 seconds.
Chain 4 finished in 2.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.9 seconds.
Total execution time: 7.9 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 2.0 seconds.
Chain 2 finished in 2.0 seconds.
Chain 3 finished in 1.7 seconds.
Chain 4 finished in 2.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.0 seconds.
Total execution time: 8.6 seconds.

-----
-----
Running the search and the performance evaluation with `refit_prj = TRUE` for each of the K = 10 CV folds separately ...

  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |======================================================================| 100%
-----</code></pre>
</div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cvvs</span>, stats <span class="op">=</span> <span class="st">"mlpd"</span>, deltas <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># model size suggested by the program</span></span>
<span><span class="fu">suggest_size</span><span class="op">(</span><span class="va">cvvs</span>, stat <span class="op">=</span> <span class="st">"mlpd"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Same with RMSE</span></span>
<span><span class="fu">suggest_size</span><span class="op">(</span><span class="va">cvvs</span>, stat <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Summary of the variable selection results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">cvvs</span>,</span>
<span>    stats <span class="op">=</span> <span class="st">"mlpd"</span>, type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span><span class="op">)</span>,</span>
<span>    deltas <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula: kid_score ~ mom_hs + mom_iq + mom_work + mom_age + mom_hs:mom_iq + 
    mom_hs:mom_work + mom_hs:mom_age + mom_iq:mom_work + mom_iq:mom_age + 
    mom_work:mom_age
Observations: 434
Projection method: traditional
CV method: K-fold CV with K = 10 and search included (i.e., fold-wise searches)
Search method: forward
Maximum submodel size for the search: 5
Number of projected draws in the search: 20 (from clustered projection)
Number of projected draws in the performance evaluation: 400
Argument `refit_prj`: TRUE

Submodel performance evaluation summary with `deltas = TRUE` and `cumulate = FALSE`:
 size ranking_fulldata cv_proportions_diag    mlpd mlpd.lower mlpd.upper
    0      (Intercept)                  NA -0.1219   -0.14332    -0.1004
    1           mom_iq                 1.0 -0.0106   -0.01811    -0.0032
    2           mom_hs                 1.0 -0.0037   -0.00966     0.0023
    3    mom_hs:mom_iq                 1.0  0.0034    0.00062     0.0063
    4          mom_age                 0.9  0.0024   -0.00024     0.0050
    5   mom_hs:mom_age                 0.9  0.0030    0.00094     0.0051

Reference model performance evaluation summary with `deltas = TRUE`:
      mlpd mlpd.lower mlpd.upper 
         0          0          0 </code></pre>
</div>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Predictor ranking(s)</span></span>
<span><span class="va">rk</span> <span class="op">&lt;-</span> <span class="fu">ranking</span><span class="op">(</span><span class="va">cvvs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">cv_proportions</span><span class="op">(</span><span class="va">rk</span>, cumulate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here it suggests to either include only <code>mom_iq</code> and <code>mom_hs</code>, or to also include their interactions.</p>
<section id="projection-based-method" class="level3" data-number="12.3.1"><h3 data-number="12.3.1" class="anchored" data-anchor-id="projection-based-method">
<span class="header-section-number">12.3.1</span> Projection-Based Method</h3>
<p>The projection-based method will obtain the posterior distributions based on a projection from the full model on the simplified model. In other words, weâ€™re asking the question:</p>
<blockquote class="blockquote">
<p>If we want a model with only <code>mom_iq</code> and <code>mom_hs</code>, what coefficients should be obtained so that the resulting prediction accuracy is as closed to the full model as possible?</p>
</blockquote>
<p>Note that the coefficients will be different from if you were to directly estimate the model using the two predictors (i.e., <code>m2</code>). In this case, simulation results showed that the projection-based method will yield a model with better predictive performance.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fit m2 with the standardized data</span></span>
<span><span class="va">m2_std</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">kid_score</span> <span class="op">~</span> <span class="va">mom_hs</span> <span class="op">+</span> <span class="va">mom_iq</span>,</span>
<span>    data <span class="op">=</span> <span class="va">kidiq_std</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2302</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"07b_m2_std"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 1 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 1 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 1 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 1 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 1 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 1 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 1 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 1 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 1 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 1 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 1 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 1 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.0 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 2 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 2 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 2 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 2 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 2 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 2 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 2 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 2 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 2 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 2 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 2 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 2 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.0 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 3 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 3 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 3 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 3 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 3 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 3 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 3 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 3 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 3 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 3 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 3 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 3 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 0.0 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 4 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 4 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 4 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 4 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 4 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 4 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 4 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 4 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 4 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 4 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 4 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 4 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 0.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.0 seconds.
Total execution time: 0.6 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Visualise the projected three most relevant variables</span></span>
<span><span class="va">prj</span> <span class="op">&lt;-</span> <span class="fu">project</span><span class="op">(</span><span class="va">refm_obj</span>,</span>
<span>    predictor_terms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mom_iq"</span>, <span class="st">"mom_hs"</span><span class="op">)</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">mcmc_intervals</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">prj</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Show the non-projection version as black, transparent dots</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span></span>
<span>        data <span class="op">=</span></span>
<span>            <span class="fu">posterior_summary</span><span class="op">(</span><span class="va">m2_std</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu">as_tibble</span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"parameter"</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Estimate</span>, y <span class="op">=</span> <span class="va">parameter</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"orange"</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 3 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="07b-stacking-and-regularization_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-carvalho2010" class="csl-entry" role="listitem">
Carvalho, C. M., Polson, N. G., &amp; Scott, J. G. (2010). The horseshoe estimator for sparse signals. <em>Biometrika</em>, <em>97</em>(2), 465â€“480. <a href="https://doi.org/10.1093/biomet/asq017">https://doi.org/10.1093/biomet/asq017</a>
</div>
<div id="ref-gelman2021" class="csl-entry" role="listitem">
Gelman, A., Hill, J., &amp; Vehtari, A. (2021). <em>Regression and other stories</em>. Cambridge University Press.
</div>
<div id="ref-hoeting1999" class="csl-entry" role="listitem">
Hoeting, J. A., Madigan, D., Raftery, A. E., &amp; Volinsky, C. T. (1999). Bayesian model averaging: A tutorial. <em>Statistical Science</em>, <em>14</em>(4). <a href="https://doi.org/10.1214/ss/1009212519">https://doi.org/10.1214/ss/1009212519</a>
</div>
<div id="ref-piironen2020" class="csl-entry" role="listitem">
Piironen, J., Paasiniemi, M., &amp; Vehtari, A. (2020). Projective inference in high-dimensional problems: Prediction and feature selection. <em>Electronic Journal of Statistics</em>, <em>14</em>(1). <a href="https://doi.org/10.1214/20-EJS1711">https://doi.org/10.1214/20-EJS1711</a>
</div>
<div id="ref-piironen2017" class="csl-entry" role="listitem">
Piironen, J., &amp; Vehtari, A. (2017). Sparsity information and regularization in the horseshoe and other shrinkage priors. <em>Electronic Journal of Statistics</em>, <em>11</em>(2). <a href="https://doi.org/10.1214/17-EJS1337SI">https://doi.org/10.1214/17-EJS1337SI</a>
</div>
<div id="ref-yao2018" class="csl-entry" role="listitem">
Yao, Y., Vehtari, A., Simpson, D., &amp; Gelman, A. (2018). Using stacking to average Bayesian predictive distributions (with discussion). <em>Bayesian Analysis</em>, <em>13</em>(3). <a href="https://doi.org/10.1214/17-BA1091">https://doi.org/10.1214/17-BA1091</a>
</div>
</div>
</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./07-model-comparison.html" class="pagination-link" aria-label="Model Comparison">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Model Comparison</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./08-causal-inference.html" class="pagination-link" aria-label="Causal Inference">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Causal Inference</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb67" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Stacking, Regularization, and Variable Selection</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>comma <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">digits =</span> <span class="dv">2</span>L) <span class="fu">format</span>(x, <span class="at">digits =</span> digits, <span class="at">big.mark =</span> <span class="st">","</span>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"grey92"</span>)))</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend =</span> <span class="st">"cmdstanr"</span>)</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(projpred)</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stacking/Model Averaging</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>Sometimes it may not be a good practice to only choose one model with low WAIC or LOO-IC, especially when several models have very  imilar WAIC/LOO-IC, but they make somewhat different predictions. Instead, we can perform *stacking* or *model averaging* by weighting the *predictions* from multiple models, using weights that are based on their information criteria performance. Stacking approaches this by optimizing the leave-one-out mean squared error in the resulting prediction, whereas model averaging preserves the uncertainty and was</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>not optimized for that task. The technical details can be found in @yao2018.</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>Note that the conventional Bayesian model averaging used the posterior model probability <span class="co">[</span><span class="ot">@hoeting1999</span><span class="co">]</span>, which are approximated by the BIC. The discussion in this note is based on more recent discussion in, e.g., @yao2018.</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>We'll use a data set <span class="in">`kidiq`</span> that is used in the textbook by @gelman2021, which can be downloaded and imported with the direct link:</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>kidiq <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">read_dta</span>(<span class="st">"http://www.stat.columbia.edu/~gelman/arm/examples/child.iq/kidiq.dta"</span>)</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(kidiq)</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>Let's run four models. First rescale some of the variables:</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a>kidiq100 <span class="ot">&lt;-</span> kidiq <span class="sc">|&gt;</span></span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mom_iq =</span> mom_iq <span class="sc">/</span> <span class="dv">100</span>,  <span class="co"># divid mom_iq by 100</span></span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">kid_score =</span> kid_score <span class="sc">/</span> <span class="dv">100</span>,   <span class="co"># divide kid_score by 100</span></span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">mom_iq_c =</span> mom_iq <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">mom_hs =</span> <span class="fu">factor</span>(mom_hs, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"no"</span>, <span class="st">"yes"</span>)),</span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">mom_age_c =</span> (mom_age <span class="sc">-</span> <span class="dv">18</span>) <span class="sc">/</span> <span class="dv">10</span>)</span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a>I will run four models, which is from the last note</span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-49"><a href="#cb67-49" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb67-50"><a href="#cb67-50" aria-hidden="true" tabindex="-1"></a>\texttt{kidscore}_i \sim N(\mu_i, \sigma)</span>
<span id="cb67-51"><a href="#cb67-51" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb67-52"><a href="#cb67-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-53"><a href="#cb67-53" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb67-54"><a href="#cb67-54" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb67-55"><a href="#cb67-55" aria-hidden="true" tabindex="-1"></a>  \mu_i &amp; = \beta_0 + \beta_1 (\texttt{mom<span class="sc">\_</span>iq}_i)  <span class="sc">\\</span></span>
<span id="cb67-56"><a href="#cb67-56" aria-hidden="true" tabindex="-1"></a>  \mu_i &amp; = \beta_0 + \beta_1 (\texttt{mom<span class="sc">\_</span>iq}_i) +</span>
<span id="cb67-57"><a href="#cb67-57" aria-hidden="true" tabindex="-1"></a>            \beta_2 (\texttt{mom<span class="sc">\_</span>hs}_i) <span class="sc">\\</span></span>
<span id="cb67-58"><a href="#cb67-58" aria-hidden="true" tabindex="-1"></a>  \mu_i &amp; = \beta_0 + \beta_1 (\texttt{mom<span class="sc">\_</span>iq}_i) +</span>
<span id="cb67-59"><a href="#cb67-59" aria-hidden="true" tabindex="-1"></a>            \beta_2 (\texttt{mom<span class="sc">\_</span>hs}_i) + \beta_3 (\texttt{mom<span class="sc">\_</span>iq}_i \times</span>
<span id="cb67-60"><a href="#cb67-60" aria-hidden="true" tabindex="-1"></a>                                                    \texttt{mom<span class="sc">\_</span>hs}_i)  <span class="sc">\\</span></span>
<span id="cb67-61"><a href="#cb67-61" aria-hidden="true" tabindex="-1"></a>  \mu_i &amp; = \beta_0 + \beta_1 (\texttt{mom<span class="sc">\_</span>iq}_i) +</span>
<span id="cb67-62"><a href="#cb67-62" aria-hidden="true" tabindex="-1"></a>            \beta_2 (\texttt{mom<span class="sc">\_</span>hs}_i) +</span>
<span id="cb67-63"><a href="#cb67-63" aria-hidden="true" tabindex="-1"></a>            \beta_3 (\texttt{mom<span class="sc">\_</span>iq}_i \times \texttt{mom<span class="sc">\_</span>hs}_i) +</span>
<span id="cb67-64"><a href="#cb67-64" aria-hidden="true" tabindex="-1"></a>            \beta_4 (\texttt{mom<span class="sc">\_</span>age}_i)</span>
<span id="cb67-65"><a href="#cb67-65" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb67-66"><a href="#cb67-66" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb67-67"><a href="#cb67-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-70"><a href="#cb67-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-71"><a href="#cb67-71" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb67-72"><a href="#cb67-72" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(kid_score <span class="sc">~</span> mom_iq_c,</span>
<span id="cb67-73"><a href="#cb67-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> kidiq100,</span>
<span id="cb67-74"><a href="#cb67-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb67-75"><a href="#cb67-75" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb67-76"><a href="#cb67-76" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb67-77"><a href="#cb67-77" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb67-78"><a href="#cb67-78" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb67-79"><a href="#cb67-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2302</span>,</span>
<span id="cb67-80"><a href="#cb67-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"07b_m1"</span></span>
<span id="cb67-81"><a href="#cb67-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-82"><a href="#cb67-82" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(m1, <span class="fu">c</span>(<span class="st">"loo"</span>, <span class="st">"waic"</span>))</span>
<span id="cb67-83"><a href="#cb67-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `update` will sometimes avoid recompiling</span></span>
<span id="cb67-84"><a href="#cb67-84" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">update</span>(m1, kid_score <span class="sc">~</span> mom_iq_c <span class="sc">+</span> mom_hs,</span>
<span id="cb67-85"><a href="#cb67-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> kidiq100,</span>
<span id="cb67-86"><a href="#cb67-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"07b_m2"</span></span>
<span id="cb67-87"><a href="#cb67-87" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-88"><a href="#cb67-88" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(m2, <span class="fu">c</span>(<span class="st">"loo"</span>, <span class="st">"waic"</span>))</span>
<span id="cb67-89"><a href="#cb67-89" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">update</span>(m2, kid_score <span class="sc">~</span> mom_iq_c <span class="sc">*</span> mom_hs,</span>
<span id="cb67-90"><a href="#cb67-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>),</span>
<span id="cb67-91"><a href="#cb67-91" aria-hidden="true" tabindex="-1"></a>        <span class="at">class =</span> <span class="st">"b"</span>,</span>
<span id="cb67-92"><a href="#cb67-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">coef =</span> <span class="st">"mom_iq_c:mom_hsyes"</span></span>
<span id="cb67-93"><a href="#cb67-93" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb67-94"><a href="#cb67-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"07b_m3"</span></span>
<span id="cb67-95"><a href="#cb67-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-96"><a href="#cb67-96" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(m3, <span class="fu">c</span>(<span class="st">"loo"</span>, <span class="st">"waic"</span>))</span>
<span id="cb67-97"><a href="#cb67-97" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">update</span>(m3, kid_score <span class="sc">~</span> mom_iq_c <span class="sc">*</span> mom_hs <span class="sc">+</span> mom_age_c,</span>
<span id="cb67-98"><a href="#cb67-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> kidiq100,</span>
<span id="cb67-99"><a href="#cb67-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"07b_m4"</span></span>
<span id="cb67-100"><a href="#cb67-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-101"><a href="#cb67-101" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(m4, <span class="fu">c</span>(<span class="st">"loo"</span>, <span class="st">"waic"</span>))</span>
<span id="cb67-102"><a href="#cb67-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-103"><a href="#cb67-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-104"><a href="#cb67-104" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model Weights</span></span>
<span id="cb67-105"><a href="#cb67-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-106"><a href="#cb67-106" aria-hidden="true" tabindex="-1"></a>We can see that <span class="in">`m3`</span> and <span class="in">`m4`</span> gave the best LOO-IC and WAIC:</span>
<span id="cb67-107"><a href="#cb67-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-110"><a href="#cb67-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-111"><a href="#cb67-111" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(m1, m2, m3, m4)</span>
<span id="cb67-112"><a href="#cb67-112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-113"><a href="#cb67-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-114"><a href="#cb67-114" aria-hidden="true" tabindex="-1"></a>So it makes sense that if we're to assign weights, <span class="in">`m4`</span> should get most weights. Let's check the following:</span>
<span id="cb67-115"><a href="#cb67-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-118"><a href="#cb67-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-119"><a href="#cb67-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Weights based on WAIC</span></span>
<span id="cb67-120"><a href="#cb67-120" aria-hidden="true" tabindex="-1"></a>waic_wts <span class="ot">&lt;-</span> <span class="fu">model_weights</span>(m1, m2, m3, m4, <span class="at">weights =</span> <span class="st">"waic"</span>)</span>
<span id="cb67-121"><a href="#cb67-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Weights based on Stacking (based on the posterior predictive distribution)</span></span>
<span id="cb67-122"><a href="#cb67-122" aria-hidden="true" tabindex="-1"></a>stack_wts <span class="ot">&lt;-</span> <span class="fu">loo_model_weights</span>(m1, m2, m3, m4)</span>
<span id="cb67-123"><a href="#cb67-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out the weights</span></span>
<span id="cb67-124"><a href="#cb67-124" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">cbind</span>(waic_wts, stack_wts), <span class="dv">3</span>)</span>
<span id="cb67-125"><a href="#cb67-125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-126"><a href="#cb67-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-127"><a href="#cb67-127" aria-hidden="true" tabindex="-1"></a>You can see <span class="in">`m3`</span> would get the highest weight, but it's only <span class="in">`r waic_wts[3]`</span> and thus less than half of the weights when all four models are considered together.</span>
<span id="cb67-128"><a href="#cb67-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-129"><a href="#cb67-129" aria-hidden="true" tabindex="-1"></a>In Bayesian, we want to preserve all the uncertainty in our analyses. Therefore, if we're not certain which models to use and have tried multiple ones, it would make sense to use all of them to get the best information. So unlike what is commonly done in practice where a researcher would test multiple models and present the best model *as if* they intended only to test this model, Bayesian analysts should do the honest thing and use all models. The reward is usually better prediction!</span>
<span id="cb67-130"><a href="#cb67-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-131"><a href="#cb67-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### Stacking</span></span>
<span id="cb67-132"><a href="#cb67-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-133"><a href="#cb67-133" aria-hidden="true" tabindex="-1"></a>Stacking is one way to combine the predictions of different models. The technical details can be found in @yao2018, but you can obtain the predictions using the <span class="in">`pp_average`</span> function:</span>
<span id="cb67-134"><a href="#cb67-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-137"><a href="#cb67-137" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-138"><a href="#cb67-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction from stacking by Yao et al. (2018)</span></span>
<span id="cb67-139"><a href="#cb67-139" aria-hidden="true" tabindex="-1"></a>pred_stacking <span class="ot">&lt;-</span> <span class="fu">pp_average</span>(m1, m2, m3, m4)</span>
<span id="cb67-140"><a href="#cb67-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the weights</span></span>
<span id="cb67-141"><a href="#cb67-141" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_stacking)</span>
<span id="cb67-142"><a href="#cb67-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-143"><a href="#cb67-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-144"><a href="#cb67-144" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prediction example</span></span>
<span id="cb67-145"><a href="#cb67-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-146"><a href="#cb67-146" aria-hidden="true" tabindex="-1"></a>Consider a kid whose mother's IQ is 120 (<span class="in">`mom_iq`</span> = .2), mother's age is 40, (<span class="in">`mom_age_c`</span> = 2.2), mother does not have a high school degree, and mother did not work in first three years of child's life (<span class="in">`mom_work`</span> = 1). Then the prediction based on the various models are:</span>
<span id="cb67-147"><a href="#cb67-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-150"><a href="#cb67-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-151"><a href="#cb67-151" aria-hidden="true" tabindex="-1"></a>newkid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mom_iq_c =</span> .<span class="dv">2</span>,</span>
<span id="cb67-152"><a href="#cb67-152" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mom_age_c =</span> <span class="fl">2.2</span>,</span>
<span id="cb67-153"><a href="#cb67-153" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mom_work =</span> <span class="dv">1</span>,</span>
<span id="cb67-154"><a href="#cb67-154" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mom_hs =</span> <span class="st">"no"</span>)</span>
<span id="cb67-155"><a href="#cb67-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the prediction by different models</span></span>
<span id="cb67-156"><a href="#cb67-156" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">stacking =</span> <span class="fu">pp_average</span>(m1, m2, m3, m4, <span class="at">newdata =</span> newkid,</span>
<span id="cb67-157"><a href="#cb67-157" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">summary =</span> <span class="cn">FALSE</span>),</span>
<span id="cb67-158"><a href="#cb67-158" aria-hidden="true" tabindex="-1"></a>           <span class="at">m4 =</span> <span class="fu">posterior_predict</span>(m4, <span class="at">newdata =</span> newkid),</span>
<span id="cb67-159"><a href="#cb67-159" aria-hidden="true" tabindex="-1"></a>           <span class="at">m3 =</span> <span class="fu">posterior_predict</span>(m3, <span class="at">newdata =</span> newkid),</span>
<span id="cb67-160"><a href="#cb67-160" aria-hidden="true" tabindex="-1"></a>           <span class="at">m2 =</span> <span class="fu">posterior_predict</span>(m2, <span class="at">newdata =</span> newkid),</span>
<span id="cb67-161"><a href="#cb67-161" aria-hidden="true" tabindex="-1"></a>           <span class="at">m1 =</span> <span class="fu">posterior_predict</span>(m1, <span class="at">newdata =</span> newkid)) <span class="sc">|&gt;</span></span>
<span id="cb67-162"><a href="#cb67-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mcmc_intervals</span>()</span>
<span id="cb67-163"><a href="#cb67-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-164"><a href="#cb67-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-165"><a href="#cb67-165" aria-hidden="true" tabindex="-1"></a>Check out this blog post https://mc-stan.org/loo/articles/loo2-weights.html for more information on stacking and Averaging.</span>
<span id="cb67-166"><a href="#cb67-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-167"><a href="#cb67-167" aria-hidden="true" tabindex="-1"></a><span class="fu">## Shrinkage Priors</span></span>
<span id="cb67-168"><a href="#cb67-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-169"><a href="#cb67-169" aria-hidden="true" tabindex="-1"></a>When the number of parameters to be estimated is large relative to the amount of data available, ordinary least square (in frequentist) and estimation using non-informative or weakly informative priors tend to overfit. For example, fitting a 6th degree polynomial (with 8 parameters) on a data set with only 10 observations will severely overfit the data, making the results not generalizable. One way to avoid overfitting is to perform *regularization*, that is, to shrink some of the parameters to closer to zero. This makes the model fit less well to the existing data, but will be much more generalizable to an independent data set.</span>
<span id="cb67-170"><a href="#cb67-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-171"><a href="#cb67-171" aria-hidden="true" tabindex="-1"></a><span class="fu">### Number of parameters</span></span>
<span id="cb67-172"><a href="#cb67-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-173"><a href="#cb67-173" aria-hidden="true" tabindex="-1"></a>In Bayesian analyses, the concept of number of parameters is a little vague. This is because the posterior distribution is a function of both the prior and the data. For non-informative priors, it would make sense to simply count the number of parameters. However, say one put a very strong prior on one of the regression coefficients, which has about 9 times the weights of the information contributed by the data:</span>
<span id="cb67-174"><a href="#cb67-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-177"><a href="#cb67-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-178"><a href="#cb67-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb67-179"><a href="#cb67-179" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">th =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>)), <span class="fu">aes</span>(<span class="at">x =</span> th)) <span class="sc">+</span></span>
<span id="cb67-180"><a href="#cb67-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb67-181"><a href="#cb67-181" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dnorm, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">9</span>),</span>
<span id="cb67-182"><a href="#cb67-182" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"prior"</span>), <span class="at">n =</span> <span class="dv">501</span></span>
<span id="cb67-183"><a href="#cb67-183" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb67-184"><a href="#cb67-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb67-185"><a href="#cb67-185" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dnorm, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="fl">0.3</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb67-186"><a href="#cb67-186" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"likelihood"</span>), <span class="at">n =</span> <span class="dv">501</span></span>
<span id="cb67-187"><a href="#cb67-187" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb67-188"><a href="#cb67-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Density"</span>, <span class="at">x =</span> <span class="fu">expression</span>(theta), <span class="at">col =</span> <span class="st">""</span>)</span>
<span id="cb67-189"><a href="#cb67-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-190"><a href="#cb67-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-191"><a href="#cb67-191" aria-hidden="true" tabindex="-1"></a>Then the posterior for the parameter only uses 1/10 of the information from the data! Therefore, it would make more sense to count this as 0.1 parameter, instead of 1 full parameter.</span>
<span id="cb67-192"><a href="#cb67-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-193"><a href="#cb67-193" aria-hidden="true" tabindex="-1"></a>The concept of regularization is essentially to introduce a stronger prior so that the posterior is less likely to overfit the data, and the resulting model will have lower *effective number of parameters*, which, when done appropriately, would find a model that is more likely to generalize to external data sets.</span>
<span id="cb67-194"><a href="#cb67-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-195"><a href="#cb67-195" aria-hidden="true" tabindex="-1"></a>In Bayesian methods, regularization can be done by choosing a prior on the coefficient that has a sharp peak at 0, but also has a heavy tail. One such prior is what is called the *horseshoe* prior. The discussion here is based on the blog pot by Michael Betancourt: <span class="ot">&lt;https://betanalpha.github.io/assets/case_studies/bayes_sparse_regression.html&gt;</span></span>
<span id="cb67-196"><a href="#cb67-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-197"><a href="#cb67-197" aria-hidden="true" tabindex="-1"></a>It should first be pointed out that these priors were based on the assumption that the predictors and the outcome has been scaled to have a standard deviation of one. So we will do this here:</span>
<span id="cb67-198"><a href="#cb67-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-201"><a href="#cb67-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-202"><a href="#cb67-202" aria-hidden="true" tabindex="-1"></a><span class="co"># For variable selection, scale the predictor and outcome to have unit variance</span></span>
<span id="cb67-203"><a href="#cb67-203" aria-hidden="true" tabindex="-1"></a>kidiq_std <span class="ot">&lt;-</span> <span class="fu">scale</span>(kidiq)</span>
<span id="cb67-204"><a href="#cb67-204" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(kidiq_std)</span>
<span id="cb67-205"><a href="#cb67-205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-206"><a href="#cb67-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-207"><a href="#cb67-207" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sparsity-Inducing Priors</span></span>
<span id="cb67-208"><a href="#cb67-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-209"><a href="#cb67-209" aria-hidden="true" tabindex="-1"></a>The *horseshoe* prior <span class="co">[</span><span class="ot">@carvalho2010</span><span class="co">]</span> is a type of hierarchical prior for regression models by introducing a global scale, $\tau$, and local scale,$\lambda_m$, parameters on the priors for the regression coefficients <span class="co">[</span><span class="ot">@piironen2017</span><span class="co">]</span>. Specifically, with $p$ predictors,</span>
<span id="cb67-210"><a href="#cb67-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-211"><a href="#cb67-211" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb67-212"><a href="#cb67-212" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb67-213"><a href="#cb67-213" aria-hidden="true" tabindex="-1"></a>  Y_i &amp; \sim N(\mu_i, \sigma^2) <span class="sc">\\</span></span>
<span id="cb67-214"><a href="#cb67-214" aria-hidden="true" tabindex="-1"></a>  \mu_i &amp; = \beta_0 + \sum_{m = 1}^p \beta_m X_m <span class="sc">\\</span></span>
<span id="cb67-215"><a href="#cb67-215" aria-hidden="true" tabindex="-1"></a>  \beta_0 &amp; \sim N(0, 1) <span class="sc">\\</span></span>
<span id="cb67-216"><a href="#cb67-216" aria-hidden="true" tabindex="-1"></a>  \beta_m &amp; \sim N(0, \tau \lambda_m) <span class="sc">\\</span></span>
<span id="cb67-217"><a href="#cb67-217" aria-hidden="true" tabindex="-1"></a>  \lambda_m &amp; \sim \textrm{Cauchy}^+(0, 1)  <span class="sc">\\</span></span>
<span id="cb67-218"><a href="#cb67-218" aria-hidden="true" tabindex="-1"></a>  \tau &amp; \sim \textrm{Cauchy}^+(0, \tau_0)</span>
<span id="cb67-219"><a href="#cb67-219" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb67-220"><a href="#cb67-220" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb67-221"><a href="#cb67-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-222"><a href="#cb67-222" aria-hidden="true" tabindex="-1"></a>The local scale, $\lambda_m$, can flexibly shrink the coefficient to close to zero. Below is the implication of the prior on the shrinkage of $\beta$:</span>
<span id="cb67-223"><a href="#cb67-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-226"><a href="#cb67-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-227"><a href="#cb67-227" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">shrinkage =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)), <span class="fu">aes</span>(<span class="at">x =</span> shrinkage)) <span class="sc">+</span></span>
<span id="cb67-228"><a href="#cb67-228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> <span class="cf">function</span>(x) {</span>
<span id="cb67-229"><a href="#cb67-229" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dcauchy</span>(<span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">/</span> x <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> x <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> x<span class="sc">^</span>(<span class="sc">-</span><span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb67-230"><a href="#cb67-230" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">n =</span> <span class="dv">501</span>) <span class="sc">+</span></span>
<span id="cb67-231"><a href="#cb67-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb67-232"><a href="#cb67-232" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb67-233"><a href="#cb67-233" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb67-234"><a href="#cb67-234" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb67-235"><a href="#cb67-235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">""</span>)</span>
<span id="cb67-236"><a href="#cb67-236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-237"><a href="#cb67-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-238"><a href="#cb67-238" aria-hidden="true" tabindex="-1"></a>The U-shape here means that, for coefficients that are weakly supported by the data, the horseshoe will shrink it to very close to zero, whereas for coefficients that are more strongly supported by the data, the horseshoe will not shrink it much.</span>
<span id="cb67-239"><a href="#cb67-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-240"><a href="#cb67-240" aria-hidden="true" tabindex="-1"></a>The red curve in the following is one example for the resulting prior distribution on $\beta$:</span>
<span id="cb67-241"><a href="#cb67-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-244"><a href="#cb67-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-245"><a href="#cb67-245" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Density for the regularized horseshoe prior with 3 degrees of freedom</span></span>
<span id="cb67-246"><a href="#cb67-246" aria-hidden="true" tabindex="-1"></a>dhs <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(</span>
<span id="cb67-247"><a href="#cb67-247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(y, <span class="at">df =</span> <span class="dv">1</span>) {</span>
<span id="cb67-248"><a href="#cb67-248" aria-hidden="true" tabindex="-1"></a>        ff <span class="ot">&lt;-</span> <span class="cf">function</span>(lam) <span class="fu">dnorm</span>(y, <span class="dv">0</span>, <span class="at">sd =</span> lam) <span class="sc">*</span> <span class="fu">dt</span>(lam, df) <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb67-249"><a href="#cb67-249" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (y <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb67-250"><a href="#cb67-250" aria-hidden="true" tabindex="-1"></a>            <span class="fu">integrate</span>(ff, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="cn">Inf</span>)<span class="sc">$</span>value</span>
<span id="cb67-251"><a href="#cb67-251" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb67-252"><a href="#cb67-252" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Inf</span></span>
<span id="cb67-253"><a href="#cb67-253" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb67-254"><a href="#cb67-254" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb67-255"><a href="#cb67-255" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-256"><a href="#cb67-256" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>)), <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb67-257"><a href="#cb67-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb67-258"><a href="#cb67-258" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dhs, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">df =</span> <span class="dv">3</span>), <span class="at">n =</span> <span class="dv">501</span>,</span>
<span id="cb67-259"><a href="#cb67-259" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"HS"</span>), <span class="at">linetype =</span> <span class="dv">1</span></span>
<span id="cb67-260"><a href="#cb67-260" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb67-261"><a href="#cb67-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb67-262"><a href="#cb67-262" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dnorm, <span class="at">n =</span> <span class="dv">501</span>,</span>
<span id="cb67-263"><a href="#cb67-263" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"norm"</span>), <span class="at">linetype =</span> <span class="dv">2</span></span>
<span id="cb67-264"><a href="#cb67-264" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb67-265"><a href="#cb67-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="st">""</span>,</span>
<span id="cb67-266"><a href="#cb67-266" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"black"</span>),</span>
<span id="cb67-267"><a href="#cb67-267" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"horseshoe(3)"</span>, <span class="st">"N(0, 1)"</span>)</span>
<span id="cb67-268"><a href="#cb67-268" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb67-269"><a href="#cb67-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb67-270"><a href="#cb67-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"density"</span>) <span class="sc">+</span></span>
<span id="cb67-271"><a href="#cb67-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.75</span>)</span>
<span id="cb67-272"><a href="#cb67-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-273"><a href="#cb67-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-274"><a href="#cb67-274" aria-hidden="true" tabindex="-1"></a>Such a prior has more density at 0, but also more density for extreme values, as compared to a normal distribution. Thus, for coefficients with very weak evidence, the regularizing prior will shrink it to zero, whereas for coefficients with strong evidence, the shrinkage will be very small. This is called a horseshoe prior. In <span class="in">`brms`</span>, one can specify it with <span class="in">`horseshoe()`</span>, which is a stabilized version of the original horseshoe prior <span class="co">[</span><span class="ot">@carvalho2010</span><span class="co">]</span>.</span>
<span id="cb67-275"><a href="#cb67-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-276"><a href="#cb67-276" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regularized Horseshoe/Hierarchical Shrinkage</span></span>
<span id="cb67-277"><a href="#cb67-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-278"><a href="#cb67-278" aria-hidden="true" tabindex="-1"></a>The regularized horseshoe (<span class="ot">&lt;https://projecteuclid.org/euclid.ejs/1513306866&gt;</span>) prior is</span>
<span id="cb67-279"><a href="#cb67-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-280"><a href="#cb67-280" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb67-281"><a href="#cb67-281" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb67-282"><a href="#cb67-282" aria-hidden="true" tabindex="-1"></a>  \beta_m &amp; \sim N(0, \tau \tilde \lambda_m) <span class="sc">\\</span></span>
<span id="cb67-283"><a href="#cb67-283" aria-hidden="true" tabindex="-1"></a>  \tilde \lambda_m &amp; = \frac{c \lambda_m}{\sqrt{c^2 + \tau^2 \lambda^2_m}} <span class="sc">\\</span></span>
<span id="cb67-284"><a href="#cb67-284" aria-hidden="true" tabindex="-1"></a>  \lambda_m &amp; \sim \textrm{Cauchy}^+(0, 1)  <span class="sc">\\</span></span>
<span id="cb67-285"><a href="#cb67-285" aria-hidden="true" tabindex="-1"></a>  c^2 &amp; \sim \textrm{Inv-Gamma}(\nu / 2, nu / 2 s^2) <span class="sc">\\</span></span>
<span id="cb67-286"><a href="#cb67-286" aria-hidden="true" tabindex="-1"></a>  \tau &amp; \sim \textrm{Cauchy}^+(0, \tau_0)</span>
<span id="cb67-287"><a href="#cb67-287" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb67-288"><a href="#cb67-288" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb67-289"><a href="#cb67-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-290"><a href="#cb67-290" aria-hidden="true" tabindex="-1"></a>The additional parameters are chosen in the code below. First, fit a model</span>
<span id="cb67-291"><a href="#cb67-291" aria-hidden="true" tabindex="-1"></a>without shrinkage:</span>
<span id="cb67-292"><a href="#cb67-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-295"><a href="#cb67-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-296"><a href="#cb67-296" aria-hidden="true" tabindex="-1"></a><span class="co"># A model with all main and interaction effects</span></span>
<span id="cb67-297"><a href="#cb67-297" aria-hidden="true" tabindex="-1"></a>m5 <span class="ot">&lt;-</span> <span class="fu">brm</span>(kid_score <span class="sc">~</span> (.)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb67-298"><a href="#cb67-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> kidiq_std,</span>
<span id="cb67-299"><a href="#cb67-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb67-300"><a href="#cb67-300" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb67-301"><a href="#cb67-301" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb67-302"><a href="#cb67-302" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb67-303"><a href="#cb67-303" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb67-304"><a href="#cb67-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2217</span>,</span>
<span id="cb67-305"><a href="#cb67-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"07b_m5"</span></span>
<span id="cb67-306"><a href="#cb67-306" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-307"><a href="#cb67-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-308"><a href="#cb67-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-311"><a href="#cb67-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-312"><a href="#cb67-312" aria-hidden="true" tabindex="-1"></a><span class="co"># A model with all main and interaction effects, and regularization</span></span>
<span id="cb67-313"><a href="#cb67-313" aria-hidden="true" tabindex="-1"></a>m_hs <span class="ot">&lt;-</span> <span class="fu">brm</span>(kid_score <span class="sc">~</span> (.)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb67-314"><a href="#cb67-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> kidiq_std,</span>
<span id="cb67-315"><a href="#cb67-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb67-316"><a href="#cb67-316" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb67-317"><a href="#cb67-317" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prior guess of 20% of the terms are non-zero</span></span>
<span id="cb67-318"><a href="#cb67-318" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">horseshoe</span>(<span class="at">par_ratio =</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">8</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb67-319"><a href="#cb67-319" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb67-320"><a href="#cb67-320" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb67-321"><a href="#cb67-321" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need higher adapt_delta</span></span>
<span id="cb67-322"><a href="#cb67-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">995</span>, <span class="at">max_treedepth =</span> <span class="dv">12</span>),</span>
<span id="cb67-323"><a href="#cb67-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2217</span>,</span>
<span id="cb67-324"><a href="#cb67-324" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"07b_m_hs"</span></span>
<span id="cb67-325"><a href="#cb67-325" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-326"><a href="#cb67-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-327"><a href="#cb67-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-328"><a href="#cb67-328" aria-hidden="true" tabindex="-1"></a>We can plot the coefficients:</span>
<span id="cb67-329"><a href="#cb67-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-332"><a href="#cb67-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-333"><a href="#cb67-333" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-asp: 1</span></span>
<span id="cb67-334"><a href="#cb67-334" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(m_hs, <span class="at">variable =</span> <span class="st">"^b_"</span>,</span>
<span id="cb67-335"><a href="#cb67-335" aria-hidden="true" tabindex="-1"></a>          <span class="at">regex =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb67-336"><a href="#cb67-336" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show the shrinkage as orange, transparent dots</span></span>
<span id="cb67-337"><a href="#cb67-337" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb67-338"><a href="#cb67-338" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">posterior_summary</span>(m5) <span class="sc">|&gt;</span></span>
<span id="cb67-339"><a href="#cb67-339" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"parameter"</span>) <span class="sc">|&gt;</span></span>
<span id="cb67-340"><a href="#cb67-340" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(parameter <span class="sc">!=</span> <span class="st">"lp__"</span>),</span>
<span id="cb67-341"><a href="#cb67-341" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> Estimate, <span class="at">y =</span> parameter), <span class="at">alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb67-342"><a href="#cb67-342" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"orange"</span></span>
<span id="cb67-343"><a href="#cb67-343" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb67-344"><a href="#cb67-344" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">05</span>, .<span class="dv">05</span>), <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb67-345"><a href="#cb67-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-346"><a href="#cb67-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-347"><a href="#cb67-347" aria-hidden="true" tabindex="-1"></a>An arbitrary cutoff is to select only coefficients with posterior means larger than .05, in which case only <span class="in">`mom_iq`</span> and <span class="in">`mom_hs`</span> and their interaction were supported by the data.</span>
<span id="cb67-348"><a href="#cb67-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-349"><a href="#cb67-349" aria-hidden="true" tabindex="-1"></a>You can also double check that the regularized version has better LOO-IC:</span>
<span id="cb67-350"><a href="#cb67-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-353"><a href="#cb67-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-354"><a href="#cb67-354" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(m5, m_hs)</span>
<span id="cb67-355"><a href="#cb67-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-356"><a href="#cb67-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-357"><a href="#cb67-357" aria-hidden="true" tabindex="-1"></a>And also that the effective number of parameters was smaller in <span class="in">`m_hs`</span>.</span>
<span id="cb67-358"><a href="#cb67-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-359"><a href="#cb67-359" aria-hidden="true" tabindex="-1"></a><span class="fu">## Variable Selection</span></span>
<span id="cb67-360"><a href="#cb67-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-361"><a href="#cb67-361" aria-hidden="true" tabindex="-1"></a>One way to identify variables that are relevant to predict a certain outcome is to use the projection-based method, as discussed in <span class="ot">&lt;https://mc-stan.org/projpred/articles/projpred.html&gt;</span> and in @piironen2020.</span>
<span id="cb67-362"><a href="#cb67-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-363"><a href="#cb67-363" aria-hidden="true" tabindex="-1"></a>Building from the full model with shrinkage priors, we first do a trial run to identify the importance of various variables in terms of their importance for prediction:</span>
<span id="cb67-364"><a href="#cb67-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-367"><a href="#cb67-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-368"><a href="#cb67-368" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb67-369"><a href="#cb67-369" aria-hidden="true" tabindex="-1"></a><span class="co"># Get reference model</span></span>
<span id="cb67-370"><a href="#cb67-370" aria-hidden="true" tabindex="-1"></a>refm_obj <span class="ot">&lt;-</span> <span class="fu">get_refmodel</span>(m_hs)</span>
<span id="cb67-371"><a href="#cb67-371" aria-hidden="true" tabindex="-1"></a><span class="co"># Preliminary run to find `nterms_max`</span></span>
<span id="cb67-372"><a href="#cb67-372" aria-hidden="true" tabindex="-1"></a>cvvs_fast <span class="ot">&lt;-</span> <span class="fu">cv_varsel</span>(</span>
<span id="cb67-373"><a href="#cb67-373" aria-hidden="true" tabindex="-1"></a>    refm_obj,</span>
<span id="cb67-374"><a href="#cb67-374" aria-hidden="true" tabindex="-1"></a>    <span class="at">validate_search =</span> <span class="cn">FALSE</span></span>
<span id="cb67-375"><a href="#cb67-375" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-376"><a href="#cb67-376" aria-hidden="true" tabindex="-1"></a><span class="co"># mlpd = mean log predictive density</span></span>
<span id="cb67-377"><a href="#cb67-377" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cvvs_fast, <span class="at">stats =</span> <span class="st">"mlpd"</span>, <span class="at">ranking_nterms_max =</span> <span class="cn">NA</span>)</span>
<span id="cb67-378"><a href="#cb67-378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-379"><a href="#cb67-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-380"><a href="#cb67-380" aria-hidden="true" tabindex="-1"></a>From the plot, we find when the predictive performance starts to level off when we keep adding more terms to the model. In this case, it seems to be 4. Given that this is a trial run, we'll set <span class="in">`nterms_max`</span> to 5, which is slightly higher.</span>
<span id="cb67-381"><a href="#cb67-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-382"><a href="#cb67-382" aria-hidden="true" tabindex="-1"></a>We then set <span class="in">`validate_search = FALSE`</span>{.r} for a final run. For computational feasibility, we'll use 10-fold validation.</span>
<span id="cb67-383"><a href="#cb67-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-386"><a href="#cb67-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-387"><a href="#cb67-387" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb67-388"><a href="#cb67-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb67-389"><a href="#cb67-389" aria-hidden="true" tabindex="-1"></a><span class="co"># With 10-fold cross-validation</span></span>
<span id="cb67-390"><a href="#cb67-390" aria-hidden="true" tabindex="-1"></a>cvvs <span class="ot">&lt;-</span> <span class="fu">cv_varsel</span>(</span>
<span id="cb67-391"><a href="#cb67-391" aria-hidden="true" tabindex="-1"></a>    refm_obj,</span>
<span id="cb67-392"><a href="#cb67-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">validate_search =</span> <span class="cn">TRUE</span>,</span>
<span id="cb67-393"><a href="#cb67-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_method =</span> <span class="st">"kfold"</span>,</span>
<span id="cb67-394"><a href="#cb67-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">K =</span> <span class="dv">10</span>,</span>
<span id="cb67-395"><a href="#cb67-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">nterms_max =</span> <span class="dv">5</span></span>
<span id="cb67-396"><a href="#cb67-396" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-397"><a href="#cb67-397" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cvvs, <span class="at">stats =</span> <span class="st">"mlpd"</span>, <span class="at">deltas =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-398"><a href="#cb67-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-399"><a href="#cb67-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-402"><a href="#cb67-402" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-403"><a href="#cb67-403" aria-hidden="true" tabindex="-1"></a><span class="co"># model size suggested by the program</span></span>
<span id="cb67-404"><a href="#cb67-404" aria-hidden="true" tabindex="-1"></a><span class="fu">suggest_size</span>(cvvs, <span class="at">stat =</span> <span class="st">"mlpd"</span>)</span>
<span id="cb67-405"><a href="#cb67-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Same with RMSE</span></span>
<span id="cb67-406"><a href="#cb67-406" aria-hidden="true" tabindex="-1"></a><span class="fu">suggest_size</span>(cvvs, <span class="at">stat =</span> <span class="st">"rmse"</span>)</span>
<span id="cb67-407"><a href="#cb67-407" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the variable selection results</span></span>
<span id="cb67-408"><a href="#cb67-408" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cvvs,</span>
<span id="cb67-409"><a href="#cb67-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">stats =</span> <span class="st">"mlpd"</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>),</span>
<span id="cb67-410"><a href="#cb67-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">deltas =</span> <span class="cn">TRUE</span></span>
<span id="cb67-411"><a href="#cb67-411" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-412"><a href="#cb67-412" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictor ranking(s)</span></span>
<span id="cb67-413"><a href="#cb67-413" aria-hidden="true" tabindex="-1"></a>rk <span class="ot">&lt;-</span> <span class="fu">ranking</span>(cvvs)</span>
<span id="cb67-414"><a href="#cb67-414" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">cv_proportions</span>(rk, <span class="at">cumulate =</span> <span class="cn">TRUE</span>))</span>
<span id="cb67-415"><a href="#cb67-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-416"><a href="#cb67-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-417"><a href="#cb67-417" aria-hidden="true" tabindex="-1"></a>Here it suggests to either include only <span class="in">`mom_iq`</span> and <span class="in">`mom_hs`</span>, or to also include their interactions.</span>
<span id="cb67-418"><a href="#cb67-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-419"><a href="#cb67-419" aria-hidden="true" tabindex="-1"></a><span class="fu">### Projection-Based Method</span></span>
<span id="cb67-420"><a href="#cb67-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-421"><a href="#cb67-421" aria-hidden="true" tabindex="-1"></a>The projection-based method will obtain the posterior distributions based on a projection from the full model on the simplified model. In other words, we're asking the question:</span>
<span id="cb67-422"><a href="#cb67-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-423"><a href="#cb67-423" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; If we want a model with only </span><span class="in">`mom_iq`</span><span class="at"> and </span><span class="in">`mom_hs`</span><span class="at">, what coefficients should be obtained so that the resulting prediction accuracy is as closed to the full model as possible?</span></span>
<span id="cb67-424"><a href="#cb67-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-425"><a href="#cb67-425" aria-hidden="true" tabindex="-1"></a>Note that the coefficients will be different from if you were to directly estimate the model using the two predictors (i.e., <span class="in">`m2`</span>). In this case, simulation results showed that the projection-based method will yield a model with better predictive performance.</span>
<span id="cb67-426"><a href="#cb67-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-429"><a href="#cb67-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-430"><a href="#cb67-430" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit m2 with the standardized data</span></span>
<span id="cb67-431"><a href="#cb67-431" aria-hidden="true" tabindex="-1"></a>m2_std <span class="ot">&lt;-</span> <span class="fu">brm</span>(kid_score <span class="sc">~</span> mom_hs <span class="sc">+</span> mom_iq,</span>
<span id="cb67-432"><a href="#cb67-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> kidiq_std,</span>
<span id="cb67-433"><a href="#cb67-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb67-434"><a href="#cb67-434" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb67-435"><a href="#cb67-435" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb67-436"><a href="#cb67-436" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb67-437"><a href="#cb67-437" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb67-438"><a href="#cb67-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2302</span>,</span>
<span id="cb67-439"><a href="#cb67-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"07b_m2_std"</span></span>
<span id="cb67-440"><a href="#cb67-440" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-441"><a href="#cb67-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb67-442"><a href="#cb67-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-445"><a href="#cb67-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb67-446"><a href="#cb67-446" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualise the projected three most relevant variables</span></span>
<span id="cb67-447"><a href="#cb67-447" aria-hidden="true" tabindex="-1"></a>prj <span class="ot">&lt;-</span> <span class="fu">project</span>(refm_obj,</span>
<span id="cb67-448"><a href="#cb67-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_terms =</span> <span class="fu">c</span>(<span class="st">"mom_iq"</span>, <span class="st">"mom_hs"</span>),</span>
<span id="cb67-449"><a href="#cb67-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb67-450"><a href="#cb67-450" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-451"><a href="#cb67-451" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(<span class="fu">as.matrix</span>(prj)) <span class="sc">+</span></span>
<span id="cb67-452"><a href="#cb67-452" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show the non-projection version as black, transparent dots</span></span>
<span id="cb67-453"><a href="#cb67-453" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb67-454"><a href="#cb67-454" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span></span>
<span id="cb67-455"><a href="#cb67-455" aria-hidden="true" tabindex="-1"></a>            <span class="fu">posterior_summary</span>(m2_std) <span class="sc">|&gt;</span></span>
<span id="cb67-456"><a href="#cb67-456" aria-hidden="true" tabindex="-1"></a>                <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"parameter"</span>),</span>
<span id="cb67-457"><a href="#cb67-457" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> Estimate, <span class="at">y =</span> parameter), <span class="at">alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb67-458"><a href="#cb67-458" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"orange"</span></span>
<span id="cb67-459"><a href="#cb67-459" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb67-460"><a href="#cb67-460" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2024, Hok Chio (Mark) Lai</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>