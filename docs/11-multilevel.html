<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.36">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>20&nbsp; Multilevel Models – PSYC 573 Bayesian Data Analysis (2024 Fall): Course Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./10b-glm2.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-01c78b5cd655e4cd89133cf59d535862.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e4a87d4af550edcd74483d3193163bc4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-225295148', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">PSYC 573 Bayesian Data Analysis (2024 Fall): Course Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="./../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../modules.html"> 
<span class="menu-text">Modules</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../docs/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../exercises/index.html"> 
<span class="menu-text">Exercises</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../syllabus/index.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/marklhc/usc-psyc573-notes" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./PSYC-573-Bayesian-Data-Analysis--2024-Fall---Course-Notes.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./11-multilevel.html">Week 13</a></li><li class="breadcrumb-item"><a href="./11-multilevel.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Multilevel Models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-probability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Probability</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-bayes-theorem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayes’s Theorem</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 3</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-beta-bernoulli-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Beta-Bernoulli Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04b-beta-bernoulli-stan.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Beta-Bernoulli Model With Stan</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04c-poisson-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Poisson Model</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 4</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-hierarchical-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Hierarchical Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 5–6</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-linear-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Linear Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06b-multiple-predictors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Multiple Predictors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06c-regression-diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model Diagnostics</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 7</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-model-comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Model Comparison</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07b-stacking-and-regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Stacking, Regularization, and Variable Selection</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 9</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-causal-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Causal Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08b-mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Mediation</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 10–11</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09b-gibbs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Gibbs Sampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09c-hmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Hamiltonian Monte Carlo</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 12</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-glm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Generalized Linear Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10b-glm2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Generalized Linear Model (II)</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 13</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-multilevel.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Multilevel Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#examples-of-clustering" id="toc-examples-of-clustering" class="nav-link active" data-scroll-target="#examples-of-clustering"><span class="header-section-number">20.1</span> Examples of Clustering</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">20.2</span> Data</a></li>
  <li>
<a href="#analysis-1-time-as-nominal" id="toc-analysis-1-time-as-nominal" class="nav-link" data-scroll-target="#analysis-1-time-as-nominal"><span class="header-section-number">20.3</span> Analysis 1: Time as Nominal</a>
  <ul class="collapse">
<li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model"><span class="header-section-number">20.3.1</span> Model</a></li>
  </ul>
</li>
  <li>
<a href="#analysis-2-growth-curve" id="toc-analysis-2-growth-curve" class="nav-link" data-scroll-target="#analysis-2-growth-curve"><span class="header-section-number">20.4</span> Analysis 2: Growth Curve</a>
  <ul class="collapse">
<li><a href="#intraclass-correlation" id="toc-intraclass-correlation" class="nav-link" data-scroll-target="#intraclass-correlation"><span class="header-section-number">20.4.1</span> Intraclass correlation</a></li>
  </ul>
</li>
  <li>
<a href="#varying-coefficients" id="toc-varying-coefficients" class="nav-link" data-scroll-target="#varying-coefficients"><span class="header-section-number">20.5</span> Varying Coefficients</a>
  <ul class="collapse">
<li><a href="#varying-intercepts" id="toc-varying-intercepts" class="nav-link" data-scroll-target="#varying-intercepts"><span class="header-section-number">20.5.1</span> Varying Intercepts</a></li>
  <li><a href="#varying-slopes" id="toc-varying-slopes" class="nav-link" data-scroll-target="#varying-slopes"><span class="header-section-number">20.5.2</span> Varying Slopes</a></li>
  <li><a href="#varying-sigma" id="toc-varying-sigma" class="nav-link" data-scroll-target="#varying-sigma"><span class="header-section-number">20.5.3</span> Varying <span class="math inline">\(\sigma\)</span></a></li>
  </ul>
</li>
  <li><a href="#model-comparisons" id="toc-model-comparisons" class="nav-link" data-scroll-target="#model-comparisons"><span class="header-section-number">20.6</span> Model Comparisons</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./11-multilevel.html">Week 13</a></li><li class="breadcrumb-item"><a href="./11-multilevel.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Multilevel Models</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Multilevel Models</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>In this note, we’ll talk about multilevel models. To start, we have already seen a basic version of a multilevel—when discussing hierarchical models with partial pooling. There, we consider a binomial model with a parameter <span class="math inline">\(\theta_j\)</span> for each person, and consider a common distribution for all the <span class="math inline">\(\theta\)</span> parameters. A multilevel model is a model where we can have one or more cluster-specific parameters for each cluster (e.g., person, group, etc.), and these parameters are assumed to come from some common distributions.</p>
<p>We will use a within-subject example in this note, starting with a few data points to fit a model equivalent to a repeated-measure ANOVA, and then generalize to a multilevel regression model with varying intercepts and slopes. The latter is also called a growth curve model.</p>
<div class="callout callout-style-simple callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Naming of Multilevel Models
</div>
</div>
<div class="callout-body-container callout-body">
<p>Multilevel models are very general and have been used in many different areas of research. Depending on the field of study, they are also called by the following names (not an exhaustive list):</p>
<ul>
<li>Hierarchical linear models</li>
<li>Mixed-effects models</li>
<li>Random-coefficients models</li>
</ul>
</div>
</div>
<div class="callout callout-style-simple callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Special Cases of Multilevel Models
</div>
</div>
<div class="callout-body-container callout-body">
<p>The following are some special cases or specific applications of multilevel models:</p>
<ul>
<li>Dependent-sample <span class="math inline">\(t\)</span>-test</li>
<li>Random-effect ANOVA</li>
<li>Repeated-measure ANOVA</li>
<li>Variance components models</li>
<li>Growth curve models</li>
<li>Generalizability theory</li>
<li>Random-effect meta-analysis</li>
</ul>
</div>
</div>
<section id="examples-of-clustering" class="level2" data-number="20.1"><h2 data-number="20.1" class="anchored" data-anchor-id="examples-of-clustering">
<span class="header-section-number">20.1</span> Examples of Clustering</h2>
<p>There are many different forms of clustering in data across different disciplines, including</p>
<ul>
<li>Students in schools</li>
<li>Clients nested within therapists within clinics</li>
<li>Employees nested within organizations</li>
<li>Citizens nested within employees</li>
<li>Repeated measures nested within persons</li>
</ul>
<p>They can be represented in network graphs like <a href="#fig-nested" class="quarto-xref">Figure&nbsp;<span>20.1</span></a> (students within schools):</p>
<div id="fig-nested" class="quarto-float quarto-figure quarto-figure-center anchored" width="360px">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-nested-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/nested.png" id="fig-nested" class="img-fluid figure-img" width="360">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-nested-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.1
</figcaption></figure>
</div>
<p>Sometimes, there is more than one level of clustering, like students clustered by middle and high schools. This is called a <em>crossed</em> structure, as shown in <a href="#fig-crossed" class="quarto-xref">Figure&nbsp;<span>20.2</span></a>, where we say that students are cross-classified by both middle and high schools. Another typical example in psychological experiments is when participants see multiple stimuli, each as an item, so the observations are cross-classified by both persons and items.</p>
<div id="fig-crossed" class="quarto-float quarto-figure quarto-figure-center anchored" width="360px">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-crossed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/crossed.png" id="fig-crossed" class="img-fluid figure-img" width="360">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-crossed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.2
</figcaption></figure>
</div>
<p>The scenario of repeated measures nested within persons is particularly relevant, as essentially all longitudinal data are multilevel and should be modelled accordingly. It allows one to build individualized models to look at within-person changes, as well as between-person differences of those changes. Techniques such as dependent-sample <span class="math inline">\(t\)</span>-test, repeated-measures ANOVA, growth curve modeling, and time-series analyses, can all be represented in the multilevel modeling framework. Therefore, some authors, such as @ mcelreath2020, suggest that MLM should be the default model we use for analyses rather than regression.</p>
</section><section id="data" class="level2" data-number="20.2"><h2 data-number="20.2" class="anchored" data-anchor-id="data">
<span class="header-section-number">20.2</span> Data</h2>
<p>We will use the data set <code>sleepstudy</code> from the <code>lme4</code> package, a popular package for frequentist multilevel modeling. The data set contains 18 participants, each with 10 observations. It examines the change in average reaction time daily with increasing sleep deprivation. See <code><a href="https://rdrr.io/pkg/lme4/man/sleepstudy.html">?lme4::sleepstudy</a></code> for more of the description. Here is a plot of the the <code>Reaction</code> variable:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">sleepstudy</span>, package <span class="op">=</span> <span class="st">"lme4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">sleepstudy</span><span class="op">$</span><span class="va">Reaction</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Reaction" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Reaction-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-Reaction-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Reaction-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.3: Distribution of reaction times (ms)
</figcaption></figure>
</div>
</div>
</div>
<p>This data set has clustering because it is repeated measures nested within persons. For the initial example, we will only take the first three time points (Days 1-3).</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sleep3</span> <span class="op">&lt;-</span> <span class="va">sleepstudy</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Days</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sleep3</span><span class="op">)</span>  <span class="co"># first two people</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Reaction"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Days"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Subject"],"name":[3],"type":["fct"],"align":["left"]}],"data":[{"1":"258.7047","2":"1","3":"308","_rn_":"1"},{"1":"250.8006","2":"2","3":"308","_rn_":"2"},{"1":"321.4398","2":"3","3":"308","_rn_":"3"},{"1":"205.2658","2":"1","3":"309","_rn_":"4"},{"1":"202.9778","2":"2","3":"309","_rn_":"5"},{"1":"204.7070","2":"3","3":"309","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Long-Format Data
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that the data above is in <em>long format</em>, which is typically required for multilevel analysis. Here, each row of the data represents one observation, so there are multiple rows for each person. This is in contrast to <em>wide format</em>, where each row represents one person and has multiple columns for each observation.</p>
</div>
</div>
<p>Here is a <em>spaghetti plot</em> of each individual over the three days:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">sleep3</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Days</span>, y <span class="op">=</span> <span class="va">Reaction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">Subject</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Reaction Time (ms)"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-spaghetti" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-spaghetti-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-spaghetti-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spaghetti-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.4: Reaction time change over three days.
</figcaption></figure>
</div>
</div>
</div>
<p>The plot shows a general increasing trend of reaction time.</p>
</section><section id="analysis-1-time-as-nominal" class="level2" data-number="20.3"><h2 data-number="20.3" class="anchored" data-anchor-id="analysis-1-time-as-nominal">
<span class="header-section-number">20.3</span> Analysis 1: Time as Nominal</h2>
<p>This analysis is analogous to a repeated-measure ANOVA. Here, our interest is simply whether there are any differences across time, without any assumption on any linear or nonlinear trends. In other words, we treat time as a nominal variable.</p>
<section id="model" class="level3" data-number="20.3.1"><h3 data-number="20.3.1" class="anchored" data-anchor-id="model">
<span class="header-section-number">20.3.1</span> Model</h3>
<p>We use <span class="math inline">\(\text{Reaction}_{ij}\)</span> to represent the reaction time for the <span class="math inline">\(j\)</span>th person on the <span class="math inline">\(i\)</span>th day.</p>
<p><span class="math display">\[
\begin{aligned}
  \text{Reaction}_{ij} &amp; \sim N(\mu_{ij}, \sigma)  \\
  \mu_{ij} \sim N(\gamma_i, \tau)
\end{aligned}
\]</span></p>
<ul>
<li>
<span class="math inline">\(\mu_{ij}\)</span>: the expected reaction time for person <span class="math inline">\(j\)</span> on day <span class="math inline">\(i\)</span>.</li>
<li>
<span class="math inline">\(\sigma\)</span>: the within-person error.</li>
<li>
<span class="math inline">\(\gamma_i\)</span>: the mean reaction time across participants on day <span class="math inline">\(i\)</span>.</li>
<li>
<span class="math inline">\(\tau\)</span>: the between-person variance on a particular day.</li>
</ul>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Assumptions
</div>
</div>
<div class="callout-body-container callout-body">
<p>The above model assumes:</p>
<ul>
<li>Normality</li>
<li>Homogeneity of error variance across observations</li>
<li>Homogeneity of variance across persons</li>
</ul>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Treat Days as a nominal variable</span></span>
<span><span class="va">sleep3</span><span class="op">$</span><span class="va">Days_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">sleep3</span><span class="op">$</span><span class="va">Days</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">Reaction</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">Days_cat</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">sleep3</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2225</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"11_m1"</span><span class="op">)</span></span>
<span><span class="va">m1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Reaction ~ 0 + Days_cat + (1 | Subject) 
   Data: sleep3 (Number of observations: 54) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~Subject (Number of levels: 18) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)    31.56      6.16    21.58    45.07 1.00      869     1371

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Days_cat1   264.32      8.43   248.27   281.08 1.00      600      719
Days_cat2   265.21      8.37   248.87   282.11 1.00      632      640
Days_cat3   282.98      8.37   266.77   299.18 1.00      615      702

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma    16.70      2.17    13.28    21.77 1.00     2120     2344

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>The model estimates the mean reaction time on each day, as well as the between-person and within-person variances. One can visualize the means:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">conditional_effects</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-condeffects-m1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-condeffects-m1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-condeffects-m1-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-condeffects-m1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.5: Model predicted mean reaction times over three days.
</figcaption></figure>
</div>
</div>
</div>
<p>One can compare this model to one where the mean reaction time is assumed equal across days:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m0</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">Reaction</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">sleep3</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2225</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"11_m0"</span><span class="op">)</span></span>
<span><span class="fu">loo</span><span class="op">(</span><span class="va">m0</span>, <span class="va">m1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 2 observations with a pareto_k &gt; 0.7 in model 'm1'. We recommend
to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Output of model 'm0':

Computed from 4000 by 54 log-likelihood matrix.

         Estimate   SE
elpd_loo   -245.9  5.9
p_loo        15.4  2.8
looic       491.7 11.9
------
MCSE of elpd_loo is 0.2.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.6]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.

Output of model 'm1':

Computed from 4000 by 54 log-likelihood matrix.

         Estimate  SE
elpd_loo   -239.2 4.6
p_loo        17.4 2.4
looic       478.3 9.2
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.6]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     52    96.3%   115     
   (0.7, 1]   (bad)       2     3.7%   &lt;NA&gt;    
   (1, Inf)   (very bad)  0     0.0%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.

Model comparisons:
   elpd_diff se_diff
m1  0.0       0.0   
m0 -6.7       3.4   </code></pre>
</div>
</div>
<p>LOO indicates that allowing a different mean reaction time for each day fits the data better.</p>
</section></section><section id="analysis-2-growth-curve" class="level2" data-number="20.4"><h2 data-number="20.4" class="anchored" data-anchor-id="analysis-2-growth-curve">
<span class="header-section-number">20.4</span> Analysis 2: Growth Curve</h2>
<p>We will now use all 10 time points, and try to fit a line/curve to the time trend. <a href="#fig-curve" class="quarto-xref">Figure&nbsp;<span>20.6</span></a> shows the changes across participants.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">sleepstudy</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Days</span>, y <span class="op">=</span> <span class="va">Reaction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># presented by person</span></span>
<span>    <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Subject</span>, ncol <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-curve" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-curve-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.6: Individual trajectories across days.
</figcaption></figure>
</div>
</div>
</div>
<p>As you can see, most people experience increases in reaction time, although there are certainly differences across individuals, such that each person has a different trajectory.</p>
<section id="intraclass-correlation" class="level3" data-number="20.4.1"><h3 data-number="20.4.1" class="anchored" data-anchor-id="intraclass-correlation">
<span class="header-section-number">20.4.1</span> Intraclass correlation</h3>
<p>With multilevel data, the first question is how much variation in the outcome is at each level. This is quantified by the <em>intraclass correlation</em>, which, for a two-level model, is defined by <span class="math display">\[
\rho = \frac{\tau^2}{\tau^2 + \sigma^2}
\]</span> where <span class="math inline">\(\tau\)</span> is the between-level <em>SD</em>, which is the <em>SD</em> of the cluster means (i.e., the variability of mean response time across persons in this example), and <span class="math inline">\(\sigma\)</span> is the within-level <em>SD</em> (i.e., variability within a person, which is assumed constant across persons).</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How Things Look With Different ICCs
</div>
</div>
<div class="callout-body-container callout-body">
<blockquote class="blockquote">
<p>The ICC represents the proportion of variance of the outcome that is due to between-level (e.g., between-group, between-person) differences</p>
</blockquote>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">fake_dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    person <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">200</span>,</span>
<span>        mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">8</span>, mean <span class="op">=</span> <span class="fl">50</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>        sd <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbase</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">fake_dat1</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">person</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.1</span>, col <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_summary</span><span class="op">(</span></span>
<span>        geom <span class="op">=</span> <span class="st">"point"</span>, fun <span class="op">=</span> <span class="va">mean</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">4</span>, shape <span class="op">=</span> <span class="fl">24</span>, fill <span class="op">=</span> <span class="st">"red"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylim</span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pbase</span></span>
<span></span>
<span><span class="va">fake_dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    person <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">200</span>,</span>
<span>        mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">8</span>, mean <span class="op">=</span> <span class="fl">50</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">80</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pbase</span> <span class="op">%+%</span> <span class="va">fake_dat2</span></span>
<span></span>
<span><span class="va">fake_dat3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    person <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">200</span>,</span>
<span>        mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">8</span>, mean <span class="op">=</span> <span class="fl">50</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">95</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pbase</span> <span class="op">%+%</span> <span class="va">fake_dat3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="fig-icc-examples" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-icc-examples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-icc-examples" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-icc-examples-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-icc-examples-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-icc-examples-1.png" class="img-fluid figure-img" data-ref-parent="fig-icc-examples" width="288">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-icc-examples-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) ICC close to 0
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-icc-examples" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-icc-examples-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-icc-examples-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-icc-examples-2.png" class="img-fluid figure-img" data-ref-parent="fig-icc-examples" width="288">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-icc-examples-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) ICC = .2
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-icc-examples" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-icc-examples-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-icc-examples-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-icc-examples-3.png" class="img-fluid figure-img" data-ref-parent="fig-icc-examples" width="288">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-icc-examples-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) ICC = .95
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-icc-examples-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.7: ICC examples.
</figcaption></figure>
</div>
<p>As you can see, the higher the ICC, the higher the variations in the cluster means, relative to the within-cluster variations.</p>
</div>
</div>
<p><a href="#fig-icc-sleepstudy" class="quarto-xref">Figure&nbsp;<span>20.8</span></a> shows substantial between-person variation for the <code>sleepstudy</code> data.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">sleepstudy</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Subject</span>, y <span class="op">=</span> <span class="va">Reaction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.1</span>, col <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_summary</span><span class="op">(</span></span>
<span>        geom <span class="op">=</span> <span class="st">"point"</span>, fun <span class="op">=</span> <span class="va">mean</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">4</span>, shape <span class="op">=</span> <span class="fl">24</span>, fill <span class="op">=</span> <span class="st">"red"</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-icc-sleepstudy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-icc-sleepstudy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-icc-sleepstudy-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-icc-sleepstudy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.8: ICC for the <code>sleepstudy</code> data.
</figcaption></figure>
</div>
</div>
</div>
<section id="computing-icc-varying-intercept-model" class="level4" data-number="20.4.1.1"><h4 data-number="20.4.1.1" class="anchored" data-anchor-id="computing-icc-varying-intercept-model">
<span class="header-section-number">20.4.1.1</span> Computing ICC: Varying-intercept model</h4>
<p>To compute the ICC, we need first to fit a multilevel model, which in this case is the <em>varying intercept</em> model:</p>
<p><span class="math display">\[
\begin{aligned}
  \text{Reaction}_{ij} &amp; \sim N(\mu_j, \sigma)  \\
  \mu_j &amp; \sim N(\gamma, \tau)
\end{aligned}
\]</span> where <span class="math inline">\(\mu_j\)</span> is the mean reaction for the <span class="math inline">\(j\)</span>th person.</p>
<p>We’ll rescale <code>Reaction</code> by 10:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sleepstudy</span> <span class="op">&lt;-</span> <span class="va">sleepstudy</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>Reaction10 <span class="op">=</span> <span class="va">Reaction</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To use weakly informative priors, we will set</p>
<p><span class="math display">\[
\begin{aligned}
  \gamma &amp; \sim N(0, 50)  \\
  \sigma &amp; \sim t^+(4, 0, 5)  \\
  \tau &amp; \sim \mathrm{Gamma}(2, 1 / 5)
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">Reaction10</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sleepstudy</span>,</span>
<span>          prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="co"># for intercept</span></span>
<span>            <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>            <span class="co"># for tau</span></span>
<span>            <span class="fu">prior</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span>,</span>
<span>            <span class="co"># for sigma</span></span>
<span>            <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          <span class="co"># Higher adapt_delta is usually needed for MLM</span></span>
<span>          control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span>,</span>
<span>          seed <span class="op">=</span> <span class="fl">2107</span>,</span>
<span>          file <span class="op">=</span> <span class="st">"11_m2"</span><span class="op">)</span></span>
<span><span class="va">m2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Reaction10 ~ (1 | Subject) 
   Data: sleepstudy (Number of observations: 180) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~Subject (Number of levels: 18) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     3.94      0.87     2.61     6.05 1.01      959     1207

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    29.81      1.00    27.78    31.82 1.01      662     1199

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     4.45      0.25     3.98     4.96 1.00     3691     2506

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Now use the posterior draws of <span class="math inline">\(\tau\)</span> and <span class="math inline">\(\sigma\)</span> to compute the posterior for the ICC:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">icc_draws</span> <span class="op">&lt;-</span> <span class="fu">as_draws</span><span class="op">(</span><span class="va">m2</span>, variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sd_Subject__Intercept"</span>, <span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate_variables</span><span class="op">(</span></span>
<span>        icc <span class="op">=</span> <span class="va">sd_Subject__Intercept</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="va">sd_Subject__Intercept</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">icc_draws</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["variable"],"name":[1],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["median"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["sd"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["mad"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["q5"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["q95"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["rhat"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["ess_bulk"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["ess_tail"],"name":[10],"type":["dbl"],"align":["right"]}],"data":[{"1":"sd_Subject__Intercept","2":"3.940410","3":"3.8081750","4":"0.8731558","5":"0.7614930","6":"2.7726805","7":"5.5772395","8":"1.0065863","9":"958.9336","10":"1206.908"},{"1":"sigma","2":"4.446551","3":"4.4390200","4":"0.2513573","5":"0.2504408","6":"4.0495025","7":"4.8664715","8":"0.9999684","9":"3690.9812","10":"2506.435"},{"1":"icc","2":"0.432219","3":"0.4262701","4":"0.1041124","5":"0.1035807","6":"0.2712447","7":"0.6131154","8":"1.0069856","9":"946.8568","10":"1339.111"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">mcmc_dens</span><span class="op">(</span><span class="va">icc_draws</span>, pars <span class="op">=</span> <span class="st">"icc"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-post-icc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-post-icc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-post-icc-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-post-icc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.9: Posterior distribution of the ICC for reaction time.
</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretations
</div>
</div>
<div class="callout-body-container callout-body">
<p>The model suggested that the average reaction time across individuals and measurement occasions was 298ms, 90% CI [281ms, 314ms]. It was estimated that 43.22%, 90% CI [27.12%, 61.31%] of the variations in reaction time was attributed to between-person differences.</p>
</div>
</div>
<div class="callout callout-style-simple callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Is MLM Needed?
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is a commonly asked question. Based on <span class="citation" data-cites="lai2015">Lai &amp; Kwok (<a href="references.html#ref-lai2015" role="doc-biblioref">2015</a>)</span>, you can compute the design effect index, which shows the inflation in the variability of the estimates due to clustering. It is recommended to account for clustering if the design effect is larger than 1.1. It is defined as: <span class="math display">\[
\mathrm{Deff} = 1 + (n - 1) \rho
\]</span> where <span class="math inline">\(n\)</span> is the (average) number of observations in each cluster, and in our case it is 10. Therefore, the design effect in <code>sleepstudy</code> for <code>Reaction</code> is <span class="math display">\[
\mathrm{Deff} = 1 + (10 - 1) (0.432219)
\]</span> which is 4.889971, so we do need to account for the clustering.</p>
</div>
</div>
</section></section></section><section id="varying-coefficients" class="level2" data-number="20.5"><h2 data-number="20.5" class="anchored" data-anchor-id="varying-coefficients">
<span class="header-section-number">20.5</span> Varying Coefficients</h2>
<p>The strength of a multilevel model is that it can allow researchers to build models that allow for cluster-specific coefficients. In our example data, this is analogous to fitting separate models for each person, but instead of only using 10 data points for each model, MLM pools information from other people as it believes that we can learn something about one person by looking at data from other people.</p>
<p>For example, for each person, we’ll fit a regression model using <code>Days</code> to predict <code>Reaction10</code>. Using our previous notations,</p>
<p><span class="math display">\[
\begin{aligned}
  \text{Reaction10}_i &amp; \sim N(\mu_i, \sigma)  \\
  \mu_i &amp; = \beta_0 + \beta_1 \text{Days}_i
\end{aligned}
\]</span> However, because we have more than one person, we’ll use the subscript <span class="math inline">\(j\)</span> to denote the person, so that the model becomes <span class="math display">\[
\begin{aligned}
  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma_j)  \\
  \mu_{ij} &amp; = \beta_{0j} + \beta_{1j} \text{Days}_{ij}
\end{aligned}
\]</span> which suggests that all three of <span class="math inline">\(\beta_0\)</span>, <span class="math inline">\(\beta_1\)</span>, and <span class="math inline">\(\sigma\)</span> can be different across persons. We’ll first start with varying <span class="math inline">\(\beta_0\)</span>, or <em>varying intercepts</em>.</p>
<section id="varying-intercepts" class="level3" data-number="20.5.1"><h3 data-number="20.5.1" class="anchored" data-anchor-id="varying-intercepts">
<span class="header-section-number">20.5.1</span> Varying Intercepts</h3>
<p>With varying intercepts model, we assumed that only <span class="math inline">\(\beta_0\)</span> is different across persons, but <span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\sigma\)</span> are common parameters that do not change across persons. This is called a <em>random intercept model</em> in (frequentist) MLM literature. Specifically, the model and priors are:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Repeated-measure level:}  \\
  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma)  \\
  \mu_{ij} &amp; = \beta_{0j} + \beta_{1} \text{Days}_{ij}  \\
\text{Person level:}  \\
  \beta_{0j} &amp; \sim N(\mu^{[\beta_0]}, \tau^{[\beta_0]})  \\
\text{Priors:}  \\
  \mu^{[\beta_0]} &amp; \sim N(0, 50) \\
  \tau^{[\beta_0]} &amp; \sim \mathrm{Gamma}(2, 0.2) \\
  \beta_1 &amp; \sim N(0, 10) \\
  \sigma &amp; \sim t^+(4, 0, 5)
\end{aligned}
\]</span> where the <span class="math inline">\(\beta_{0j}\)</span>s follow a common normal distribution with hyperparameters <span class="math inline">\(\mu^{[\beta_0]}\)</span> and <span class="math inline">\(\tau^{[\beta_0]}\)</span>. Thus, <span class="math inline">\(\mu^{[\beta_0]}\)</span> is the <em>grand intercept</em>, or the average intercept across persons, and <span class="math inline">\(\tau^{[\beta_0]}\)</span> is the <em>SD</em> of those intercepts.</p>
<p>The model can be fitted in <code>brms</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">Reaction10</span> <span class="op">~</span> <span class="va">Days</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">sleepstudy</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="co"># for intercept</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for slope</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for tau</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for sigma</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2107</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"11_m3"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Reaction10 ~ Days + (1 | Subject) 
   Data: sleepstudy (Number of observations: 180) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~Subject (Number of levels: 18) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     4.11      0.82     2.85     6.04 1.00      765     1360

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    25.23      1.07    23.16    27.27 1.00      589      929
Days          1.05      0.08     0.89     1.21 1.00     2906     2862

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     3.12      0.17     2.81     3.49 1.00     2370     2541

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Let’s check the fit of the model to the data, first to the overall data and then to each individual.</p>
<section id="fit-of-overall-data" class="level4" data-number="20.5.1.1"><h4 data-number="20.5.1.1" class="anchored" data-anchor-id="fit-of-overall-data">
<span class="header-section-number">20.5.1.1</span> Fit of Overall data</h4>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pp_check</span><span class="op">(</span><span class="va">m3</span>, type <span class="op">=</span> <span class="st">"intervals"</span>, x <span class="op">=</span> <span class="st">"Days"</span>,</span>
<span>         re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_obs</span><span class="op">)</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using all posterior draws for ppc type 'intervals' by default.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The following aesthetics were dropped during statistical transformation: ymin,
ymax
ℹ This can happen when ggplot fails to infer the correct grouping structure in
  the data.
ℹ Did you forget to specify a `group` aesthetic or to convert a numerical
  variable into a factor?</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The following aesthetics were dropped during statistical transformation: ymin,
ymax
ℹ This can happen when ggplot fails to infer the correct grouping structure in
  the data.
ℹ Did you forget to specify a `group` aesthetic or to convert a numerical
  variable into a factor?</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-fit-m3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-fit-m3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-fit-m3-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fit-m3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.10: Marginal model plot of the overall data.
</figcaption></figure>
</div>
</div>
</div>
<p>As can be seen, the estimated coefficient for <code>Days</code>, which was assumed constant for everyone, fit the overall data. However, does it fit each individual?</p>
</section><section id="fit-of-individuals" class="level4" data-number="20.5.1.2"><h4 data-number="20.5.1.2" class="anchored" data-anchor-id="fit-of-individuals">
<span class="header-section-number">20.5.1.2</span> Fit of Individuals</h4>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ce_m3</span> <span class="op">&lt;-</span> <span class="fu">conditional_effects</span><span class="op">(</span><span class="va">m3</span>,</span>
<span>    re_formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Subject <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sleepstudy</span><span class="op">$</span><span class="va">Subject</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Add original outcome variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ce_m3</span>, points <span class="op">=</span> <span class="cn">TRUE</span>, ncol <span class="op">=</span> <span class="fl">6</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">ce_m3</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"points"</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Days</span>, y <span class="op">=</span> <span class="va">resp__</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>        linewidth <span class="op">=</span> <span class="fl">0.8</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>        inherit.aes <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-fit-individuals-m3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-fit-individuals-m3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-fit-individuals-m3-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fit-individuals-m3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.11: Marginal model plot by individuals, with only varying intercepts.
</figcaption></figure>
</div>
</div>
</div>
<p>Obviously, it only fits a few individuals, but not all. So let’s also allow <span class="math inline">\(\beta_1\)</span> to vary.</p>
</section></section><section id="varying-slopes" class="level3" data-number="20.5.2"><h3 data-number="20.5.2" class="anchored" data-anchor-id="varying-slopes">
<span class="header-section-number">20.5.2</span> Varying Slopes</h3>
<p>We’ll now also allow <span class="math inline">\(\beta_1\)</span> to vary across clusters, with the following model:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Repeated-measure level:}  \\
  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma)  \\
  \mu_{ij} &amp; = \beta_{0j} + \beta_{1j} \text{Days}_{ij}  \\
\text{Person level:}  \\
  \begin{bmatrix}
    \beta_{0j} \\
    \beta_{1j} \\
  \end{bmatrix} &amp; \sim N_2\left(
    \begin{bmatrix}
      \mu^{[\beta_0]} \\
      \mu^{[\beta_1]} \\
    \end{bmatrix}, \mathbf T
    \right)
\end{aligned}
\]</span> where <span class="math display">\[
\mathbf T = \begin{bmatrix}
      {\tau^{[\beta_0]}}^2 &amp; \\
      \tau^{\beta{10}} &amp; {\tau^{[\beta_1]}}^2 \\
    \end{bmatrix}
\]</span></p>
<p>Note that <span class="math inline">\(N_2\)</span> denotes a bivariate normal (i.e., 2-dimensional multivariate normal) distribution, because now we can talk about how <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span> are associated at the person level. Generally, I don’t interpret the covariance between them because it largely depends on how the variables were centered, but we should allow them to be correlated. The parameter <span class="math inline">\(\tau^{\beta{10}}\)</span> thus denotes their covariance.</p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Programs using Gibbs sampling, such as <code>MCMCglmm</code>, use an inverse-Wishart distribution as a prior for the covariance matrix <span class="math inline">\(\mathbf T\)</span>, but it has been shown to usually lead to biased and inefficient estimates.</p>
</div>
</div>
</div>
<p>To estimate <span class="math inline">\(\mathbf T\)</span>, recent recommendations, as implemented in <code>brms</code>, suggest decomposing <span class="math inline">\(\mathbf T\)</span> into a correlation matrix and the scaling matrices, and using an LKJ prior to the correlation matrix. We explain the LKJ prior in <a href="#imp-lkj-prior" class="quarto-xref">Important&nbsp;<span>20.1</span></a>. Let’s first do the decomposition:</p>
<p><span class="math display">\[
\mathbf T = \mathrm{diag}(\boldsymbol{\tau}) \boldsymbol{\Omega} \mathrm{diag}(\boldsymbol{\tau}),
\]</span> where <span class="math inline">\(\mathbf T\)</span> = <span class="math inline">\([\tau_1, \tau_2, \ldots]\)</span> is a vector containing the scale parameters (i.e., <em>SD</em>) of the varying coefficients, and <span class="math inline">\(\boldsymbol{\Omega}\)</span> is the correlation matrix of the varying coefficients.</p>
<div id="imp-lkj-prior" class="callout callout-style-simple callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important&nbsp;20.1: LKJ Prior
</div>
</div>
<div class="callout-body-container callout-body">
<p>The LKJ Prior is a probability distribution for correlation matrices. A correlation matrix has 1 on all the diagonal elements. For example, a 2 <span class="math inline">\(\times\)</span> 2 correlation matrix is <span class="math display">\[
\begin{bmatrix}
    1 &amp; \\
    0.35 &amp; 1
\end{bmatrix}
\]</span> where the correlation is 0.35. Therefore, with two variables, there is one correlation; with three or more variables, the number of correlations will be <span class="math inline">\(q (q - 1) / 2\)</span>, where <span class="math inline">\(q\)</span> is the number of variables.</p>
<p>For a correlation matrix of a given size, the LKJ prior has one shape parameter, <span class="math inline">\(\eta\)</span>, where <span class="math inline">\(\eta = 1\)</span> corresponds to a uniform distribution of the correlations such that any correlations are equally likely, <span class="math inline">\(\eta \geq 1\)</span> favors a matrix closer to an identity matrix so that the correlations are closer to zero, and <span class="math inline">\(\eta \leq 1\)</span> favors a matrix with larger correlations. For a 2 <span class="math inline">\(\times\)</span> 2 matrix, the distribution of the correlation, <span class="math inline">\(\rho\)</span>, with different <span class="math inline">\(\eta\)</span> values are shown in the graph below:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dlkjcorr2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">rho</span>, <span class="va">eta</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">log</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Function to compute the LKJ density given a correlation</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">eta</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">rho</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span></span>
<span>        <span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">pi</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">eta</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">log</span><span class="op">)</span> <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>    <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">rho</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dlkjcorr2</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"0.1"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dlkjcorr2</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"0.5"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dlkjcorr2</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dlkjcorr2</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"2"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dlkjcorr2</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"10"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">stat_function</span><span class="op">(</span></span>
<span>        fun <span class="op">=</span> <span class="va">dlkjcorr2</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"100"</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">501</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2 rows containing missing values (`geom_function()`).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="11-multilevel_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>LKJ prior on a correlation with different different <span class="math inline">\(\eta\)</span> values.</figcaption></figure>
</div>
</div>
</div>
<p>As you can see, when <span class="math inline">\(\eta\)</span> increases, the correlation is more concentrated to zero.</p>
<p>The default of <code>brms</code> is to use <span class="math inline">\(\eta\)</span> = 1, which is non-informative. If you have a weak but informative belief that the correlations shouldn’t be very large, using <span class="math inline">\(\eta\)</span> = 2 is reasonable.</p>
</div>
</div>
<p>The resulting model and priors are:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Repeated-measure level:}  \\
  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma)  \\
  \mu_{ij} &amp; = \beta_{0j} + \beta_{1j} \text{Days}_{ij}  \\
\text{Person level:}  \\
  \begin{bmatrix}
    \beta_{0j} \\
    \beta_{1j} \\
  \end{bmatrix} &amp; \sim N_2\left(
    \begin{bmatrix}
      \mu^{[\beta_0]} \\
      \mu^{[\beta_1]} \\
    \end{bmatrix}, \mathbf T
    \right)  \\
  \mathbf T &amp; = \mathrm{diag}(\boldsymbol{\tau}) \boldsymbol{\Omega} \mathrm{diag}(\boldsymbol{\tau}) \\
\text{Priors:}  \\
  \mu^{[\beta_0]} &amp; \sim N(0, 50) \\
  \mu^{[\beta_1]} &amp; \sim N(0, 10) \\
  \tau^{[\beta_m]} &amp; \sim \mathrm{Gamma}(2, 0.2), \; m = 0, 1 \\
  \boldsymbol{\Omega} &amp; \sim \mathrm{LKJ}(1) \\
  \sigma &amp; \sim t^+(4, 0, 5)
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">Reaction10</span> <span class="op">~</span> <span class="va">Days</span> <span class="op">+</span> <span class="op">(</span><span class="va">Days</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">sleepstudy</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="co"># for intercept</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for slope</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for tau_beta0 and tau_beta1</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span>, group <span class="op">=</span> <span class="st">"Subject"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for correlation</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">lkj</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"cor"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for sigma</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2107</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"11_m4"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Reaction10 ~ Days + (Days | Subject) 
   Data: sleepstudy (Number of observations: 180) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~Subject (Number of levels: 18) 
                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)           2.83      0.70     1.68     4.41 1.00     1637     2216
sd(Days)                0.69      0.16     0.44     1.09 1.00     1875     2371
cor(Intercept,Days)     0.06      0.31    -0.52     0.67 1.00     1108     1623

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    25.12      0.78    23.55    26.66 1.00     2342     2378
Days          1.04      0.18     0.70     1.41 1.00     1745     2239

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     2.59      0.16     2.29     2.92 1.00     3940     2874

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<section id="fit-of-individuals-1" class="level4" data-number="20.5.2.1"><h4 data-number="20.5.2.1" class="anchored" data-anchor-id="fit-of-individuals-1">
<span class="header-section-number">20.5.2.1</span> Fit of Individuals</h4>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ce_m4</span> <span class="op">&lt;-</span> <span class="fu">conditional_effects</span><span class="op">(</span><span class="va">m4</span>,</span>
<span>    re_formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Subject <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sleepstudy</span><span class="op">$</span><span class="va">Subject</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Add original outcome variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ce_m4</span>, points <span class="op">=</span> <span class="cn">TRUE</span>, ncol <span class="op">=</span> <span class="fl">6</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">ce_m4</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"points"</span><span class="op">)</span>,</span>
<span>        <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Days</span>, y <span class="op">=</span> <span class="va">resp__</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>        linewidth <span class="op">=</span> <span class="fl">0.8</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>        inherit.aes <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-fit-individuals-m4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-fit-individuals-m4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-fit-individuals-m4-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fit-individuals-m4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.12: Marginal model plot by individuals, with varying slopes.
</figcaption></figure>
</div>
</div>
</div>
<p>You can see that the fit is better. You can also visualize the varying regression lines:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>    <span class="fu">conditional_effects</span><span class="op">(</span><span class="va">m4</span>,</span>
<span>        effects <span class="op">=</span> <span class="st">"Days:Subject"</span>,</span>
<span>        re_formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>        <span class="co"># suppress credible band</span></span>
<span>        prob <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span>,</span>
<span>    points <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    point_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-varying-m4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-varying-m4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-multilevel_files/figure-html/fig-varying-m4-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-varying-m4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20.13: Varying regression lines on the same plot.
</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretations
</div>
</div>
<div class="callout-body-container callout-body">
<p>Based on the model, at Day 0, the average reaction time across individuals was 251ms, 90% CI [238ms, 264ms], and the <em>SD</em> at Day 0 was 28.3178086ms, 95% CI [18.060615ms, 40.863435ms].</p>
<p>The average rate of change per day in reaction time across individuals was 10ms, 90% CI [7.6ms, 13ms], and the <em>SD</em> of the rates of change at Day 0 was 6.9012462ms, 95% CI [4.6810815ms, 10.04862ms], as shown in <a href="#fig-varying-m4" class="quarto-xref">Figure&nbsp;<span>20.13</span></a>.</p>
</div>
</div>
<div class="callout callout-style-simple callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fixed-Effects Model
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can compare the previous model with one that has different slopes for different persons, which can be modelled by including an interaction with the categorical <code>Subject</code> predictor. This is referred to as the <em>fixed-effects</em> model, as opposed to the <em>random-effects</em> model used to describe hierarchical models with partial pooling. Below is an example:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m4_fixed</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span><span class="va">Reaction10</span> <span class="op">~</span> <span class="va">Days</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Subject</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">sleepstudy</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="co"># for intercept</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for slope</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for sigma</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2107</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"11_m4_fixed"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can compare the two models using LOO-IC:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">loo</span><span class="op">(</span><span class="va">m4</span>, <span class="va">m4_fixed</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 3 observations with a pareto_k &gt; 0.7 in model 'm4'. We recommend
to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 2 observations with a pareto_k &gt; 0.7 in model 'm4_fixed'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Output of model 'm4':

Computed from 4000 by 180 log-likelihood matrix.

         Estimate   SE
elpd_loo   -447.0 22.7
p_loo        34.9  8.8
looic       894.0 45.5
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.6]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     177   98.3%   593     
   (0.7, 1]   (bad)        1    0.6%   &lt;NA&gt;    
   (1, Inf)   (very bad)   2    1.1%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.

Output of model 'm4_fixed':

Computed from 4000 by 180 log-likelihood matrix.

         Estimate   SE
elpd_loo   -448.7 23.0
p_loo        38.7  9.1
looic       897.3 45.9
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.2, 1.6]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     178   98.9%   81      
   (0.7, 1]   (bad)        1    0.6%   &lt;NA&gt;    
   (1, Inf)   (very bad)   1    0.6%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.

Model comparisons:
         elpd_diff se_diff
m4        0.0       0.0   
m4_fixed -1.6       2.3   </code></pre>
</div>
</div>
<p>As you can see, in this case, the hierarchical approach yields a lower LOO (but there was a warning message, so be careful) and estimates fewer parameters. With more clusters and lower ICC, hierarchical models will have an even stronger advantage.</p>
</div>
</div>
<p>So far, we have yet to talk about including person-level predictors. If such predictors are available, such as gender, we can use those to predict individual differences in intercepts (main effect) and slopes (i.e., interaction with <code>Days</code>). Just add those predictors to the model by:</p>
<p><span class="math display">\[
\begin{aligned}
  \begin{bmatrix}
    \beta_{0j} \\
    \beta_{1j} \\
  \end{bmatrix} &amp; \sim N_2\left(
  \begin{bmatrix}
      \mu^{[\beta_0]}_j \\
      \mu^{[\beta_1]}_j \\
    \end{bmatrix}, \mathbf T
    \right)  \\
  \mathbf T &amp; = \mathrm{diag}(\boldsymbol{\tau}) \boldsymbol{\Omega} \mathrm{diag}(\boldsymbol{\tau}) \\
  \mu^{[\beta_0]}_j &amp; = \gamma_{00} + \gamma_{01} X_j \\
  \mu^{[\beta_1]}_j &amp; = \gamma_{10} + \gamma_{11} X_j
\end{aligned}
\]</span> where <span class="math inline">\(X_j\)</span> is a person-level predictor.</p>
</section></section><section id="varying-sigma" class="level3" data-number="20.5.3"><h3 data-number="20.5.3" class="anchored" data-anchor-id="varying-sigma">
<span class="header-section-number">20.5.3</span> Varying <span class="math inline">\(\sigma\)</span>
</h3>
<p>Finally, you can also allow <span class="math inline">\(\sigma\)</span> to differ across individuals. This is typically used to relax the homogeneity of variance assumption, but recently, there has also been some interest in treating varying <span class="math inline">\(\sigma\)</span> as an important outcome. Examples include fluctuations in mood, as two people with the same mean level of mood may fluctuate very differently, and mood swing can be an important outcome to assess. There have been some interesting applications in health research using ecological momentary assessment data. For an overview, see the paper by <span class="citation" data-cites="hedeker2008">Hedeker et al. (<a href="references.html#ref-hedeker2008" role="doc-biblioref">2008</a>)</span>.</p>
<p>Without going into the details, here is the model and the priors:</p>
<p><span class="math display">\[
\begin{aligned}
\text{Repeated-measure level:}  \\
  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma_j)  \\
  \mu_{ij} &amp; = \beta_{0j} + \beta_{1j} \text{Days}_{ij}  \\
\text{Person level:}  \\
  \begin{bmatrix}
    \beta_{0j} \\
    \beta_{1j} \\
    \log(\sigma_j)
  \end{bmatrix} &amp; \sim N_2\left(
    \begin{bmatrix}
      \mu^{[\beta_0]} \\
      \mu^{[\beta_1]} \\
      \mu^{[s]}
    \end{bmatrix}, \mathbf T
    \right)  \\
  \mathbf T &amp; = \mathrm{diag}(\boldsymbol{\tau}) \boldsymbol{\Omega} \mathrm{diag}(\boldsymbol{\tau}) \\
\text{Priors:}  \\
  \mu^{[\beta_0]} &amp; \sim N(0, 50) \\
  \mu^{[\beta_1]} &amp; \sim N(0, 10) \\
  \mu^{[s]} &amp; \sim t^+(4, 0, 1.6) \\
  \tau^{[\beta_m]} &amp; \sim \mathrm{Gamma}(2, 0.2), \; m = 0, 1 \\
  \tau^{[s]} &amp; \sim \mathrm{Gamma}(2, 0.625) \\
  \boldsymbol{\Omega} &amp; \sim \mathrm{LKJ}(1)
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Use |p| to estimate the covariance between the sigma and beta random effects</span></span>
<span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu">brm</span><span class="op">(</span></span>
<span>    <span class="fu">bf</span><span class="op">(</span></span>
<span>        <span class="va">Reaction10</span> <span class="op">~</span> <span class="va">Days</span> <span class="op">+</span> <span class="op">(</span><span class="va">Days</span> <span class="op">|</span> <span class="va">p</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>,</span>
<span>        <span class="va">sigma</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">p</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">sleepstudy</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="co"># for intercept</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for slope</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for tau_beta0</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>            class <span class="op">=</span> <span class="st">"sd"</span>, coef <span class="op">=</span> <span class="st">"Intercept"</span>,</span>
<span>            group <span class="op">=</span> <span class="st">"Subject"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="co"># for tau_beta1</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>            class <span class="op">=</span> <span class="st">"sd"</span>, coef <span class="op">=</span> <span class="st">"Days"</span>,</span>
<span>            group <span class="op">=</span> <span class="st">"Subject"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="co"># for correlation</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">lkj</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"cor"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for sigma</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">1.6</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span>, dpar <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span>,</span>
<span>        <span class="co"># for tau_sigma</span></span>
<span>        <span class="fu">prior</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html">gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.625</span><span class="op">)</span>,</span>
<span>            class <span class="op">=</span> <span class="st">"sd"</span>, coef <span class="op">=</span> <span class="st">"Intercept"</span>,</span>
<span>            group <span class="op">=</span> <span class="st">"Subject"</span>, dpar <span class="op">=</span> <span class="st">"sigma"</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2107</span>,</span>
<span>    file <span class="op">=</span> <span class="st">"11_m5"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = log 
Formula: Reaction10 ~ Days + (Days | p | Subject) 
         sigma ~ (1 | p | Subject)
   Data: sleepstudy (Number of observations: 180) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~Subject (Number of levels: 18) 
                               Estimate Est.Error l-95% CI u-95% CI Rhat
sd(Intercept)                      3.16      0.71     2.06     4.87 1.00
sd(Days)                           0.70      0.16     0.46     1.07 1.00
sd(sigma_Intercept)                0.51      0.12     0.31     0.79 1.00
cor(Intercept,Days)               -0.01      0.27    -0.50     0.52 1.00
cor(Intercept,sigma_Intercept)     0.22      0.29    -0.39     0.73 1.00
cor(Days,sigma_Intercept)          0.45      0.26    -0.13     0.85 1.00
                               Bulk_ESS Tail_ESS
sd(Intercept)                      1766     2385
sd(Days)                           1574     2486
sd(sigma_Intercept)                1693     2606
cor(Intercept,Days)                1086     1634
cor(Intercept,sigma_Intercept)     1580     2292
cor(Days,sigma_Intercept)          1581     2217

Regression Coefficients:
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept          25.11      0.83    23.52    26.77 1.00     1353     1760
sigma_Intercept     0.73      0.14     0.44     1.02 1.00     1592     1767
Days                1.05      0.18     0.70     1.40 1.00     1186     1879

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Here is the posterior predictive check:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pp_check</span><span class="op">(</span><span class="va">m5</span>, type <span class="op">=</span> <span class="st">"ribbon_grouped"</span>, group <span class="op">=</span> <span class="st">"Subject"</span>, x <span class="op">=</span> <span class="st">"Days"</span>,</span>
<span>         facet_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">6</span>, scales <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using all posterior draws for ppc type 'ribbon_grouped' by default.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-multilevel_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="model-comparisons" class="level2" data-number="20.6"><h2 data-number="20.6" class="anchored" data-anchor-id="model-comparisons">
<span class="header-section-number">20.6</span> Model Comparisons</h2>
<p>We can compare the previous models from <code>m3</code> to <code>m5</code>, with <code>m3</code> being the least complex and <code>m5</code> being the most complex. However, it should be noted that, because of the way how STAN computes LOOIC and WAIC,</p>
<blockquote class="blockquote">
<p>The LOOIC and WAIC computed in STAN (including <code>brms</code>) generally cannot be used to compare models with different level-2 predictors.</p>
</blockquote>
<p>The problem is illustrated in this blog post: <a href="https://deepthoughtsandsilliness.blogspot.com/2007/12/focus-on-dic.html" class="uri">https://deepthoughtsandsilliness.blogspot.com/2007/12/focus-on-dic.html</a> in the context of DIC.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">msummary</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        `Varying Intercepts` <span class="op">=</span> <span class="va">m3</span>,</span>
<span>        `Varying Intercepts and Slopes` <span class="op">=</span> <span class="va">m4</span>,</span>
<span>        `Varying Intercepts, Slopes, and Variances` <span class="op">=</span> <span class="va">m5</span></span>
<span>    <span class="op">)</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"WAIC"</span>, <span class="st">"LOOIC"</span><span class="op">)</span>,</span>
<span>    estimate <span class="op">=</span> <span class="st">"{estimate} [{conf.low}, {conf.high}]"</span>,</span>
<span>    shape <span class="op">=</span> <span class="va">effect</span> <span class="op">+</span> <span class="va">term</span> <span class="op">~</span> <span class="va">model</span>,</span>
<span>    fmt <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">effect</th>
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: center;" data-quarto-table-cell-role="th">&nbsp;Varying Intercepts</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">&nbsp;Varying Intercepts and Slopes</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">&nbsp;Varying Intercepts, Slopes, and Variances</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;">b_Intercept</td>
<td style="text-align: center;">25.23 [23.16, 27.27]</td>
<td style="text-align: center;">25.12 [23.55, 26.66]</td>
<td style="text-align: center;">25.11 [23.52, 26.77]</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">b_Days</td>
<td style="text-align: center;">1.05 [0.89, 1.21]</td>
<td style="text-align: center;">1.04 [0.70, 1.41]</td>
<td style="text-align: center;">1.04 [0.70, 1.40]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">sigma</td>
<td style="text-align: center;">3.11 [2.81, 3.49]</td>
<td style="text-align: center;">2.58 [2.29, 2.92]</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">b_sigma_Intercept</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.73 [0.44, 1.02]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">random</td>
<td style="text-align: left;">sd_Subject__Intercept</td>
<td style="text-align: center;">3.98 [2.85, 6.04]</td>
<td style="text-align: center;">2.75 [1.68, 4.41]</td>
<td style="text-align: center;">3.06 [2.06, 4.87]</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">sd_Subject__Days</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.67 [0.44, 1.09]</td>
<td style="text-align: center;">0.68 [0.46, 1.07]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">cor_Subject__Intercept__Days</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.06 [−0.52, 0.67]</td>
<td style="text-align: center;">−0.02 [−0.50, 0.52]</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">sd_Subject__sigma_Intercept</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.49 [0.31, 0.79]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">cor_Subject__Intercept__sigma_Intercept</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.25 [−0.39, 0.73]</td>
</tr>
<tr class="even">
<td style="text-align: left; box-shadow: 0px 1.5px;"></td>
<td style="text-align: left; box-shadow: 0px 1.5px;">cor_Subject__Days__sigma_Intercept</td>
<td style="text-align: center; box-shadow: 0px 1.5px;"></td>
<td style="text-align: center; box-shadow: 0px 1.5px;"></td>
<td style="text-align: center; box-shadow: 0px 1.5px;">0.48 [−0.13, 0.85]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">Num.Obs.</td>
<td style="text-align: center;">180</td>
<td style="text-align: center;">180</td>
<td style="text-align: center;">180</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">ELPD</td>
<td style="text-align: center;">−470.0</td>
<td style="text-align: center;">−447.0</td>
<td style="text-align: center;">−418.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">ELPD s.e.</td>
<td style="text-align: center;">14.3</td>
<td style="text-align: center;">22.7</td>
<td style="text-align: center;">13.4</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">LOOIC</td>
<td style="text-align: center;">940.0</td>
<td style="text-align: center;">894.0</td>
<td style="text-align: center;">837.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">LOOIC s.e.</td>
<td style="text-align: center;">28.6</td>
<td style="text-align: center;">45.5</td>
<td style="text-align: center;">26.8</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">WAIC</td>
<td style="text-align: center;">939.5</td>
<td style="text-align: center;">891.0</td>
<td style="text-align: center;">827.6</td>
</tr>
</tbody>
</table>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-hedeker2008" class="csl-entry" role="listitem">
Hedeker, D., Mermelstein, R. J., &amp; Demirtas, H. (2008). An application of a mixed‐effects location scale model for analysis of ecological momentary assessment (EMA) data. <em>Biometrics</em>, <em>64</em>(2), 627–634. <a href="https://doi.org/10.1111/j.1541-0420.2007.00924.x">https://doi.org/10.1111/j.1541-0420.2007.00924.x</a>
</div>
<div id="ref-lai2015" class="csl-entry" role="listitem">
Lai, M. H. C., &amp; Kwok, O. (2015). Examining the rule of thumb of not using multilevel modeling: The <span>“design effect smaller than two”</span> rule. <em>The Journal of Experimental Education</em>, <em>83</em>(3), 423–438. <a href="https://doi.org/10.1080/00220973.2014.907229">https://doi.org/10.1080/00220973.2014.907229</a>
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./10b-glm2.html" class="pagination-link" aria-label="Generalized Linear Model (II)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Generalized Linear Model (II)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb49" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Multilevel Models</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>comma <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">digits =</span> <span class="dv">2</span>L) <span class="fu">format</span>(x, <span class="at">digits =</span> digits, <span class="at">big.mark =</span> <span class="st">","</span>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"grey92"</span>)))</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(psych, <span class="at">include.only =</span> <span class="st">"pairs.panels"</span>)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend =</span> <span class="st">"cmdstanr"</span>, <span class="at">mc.cores =</span> <span class="dv">2</span>)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>In this note, we'll talk about multilevel models. To start, we have already seen a basic version of a multilevel---when discussing hierarchical models with partial pooling. There, we consider a binomial model with a parameter $\theta_j$ for each person, and consider a common distribution for all the $\theta$ parameters. A multilevel model is a model where we can have one or more cluster-specific parameters for each cluster (e.g., person, group, etc.), and these parameters are assumed to come from some common distributions.</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>We will use a within-subject example in this note, starting with a few data points to fit a model equivalent to a repeated-measure ANOVA, and then generalize to a multilevel regression model with varying intercepts and slopes. The latter is also called a growth curve model.</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="fu">## Naming of Multilevel Models</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>Multilevel models are very general and have been used in many different areas of research. Depending on the field of study, they are also called by the following names (not an exhaustive list):</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Hierarchical linear models</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Mixed-effects models</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Random-coefficients models</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a><span class="fu">## Special Cases of Multilevel Models</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>The following are some special cases or specific applications of multilevel models:</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Dependent-sample $t$-test</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Random-effect ANOVA</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Repeated-measure ANOVA</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Variance components models</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Growth curve models</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Generalizability theory</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Random-effect meta-analysis</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a><span class="fu">## Examples of Clustering</span></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>There are many different forms of clustering in data across different disciplines, including</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Students in schools</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Clients nested within therapists within clinics</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Employees nested within organizations</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Citizens nested within employees</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Repeated measures nested within persons</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>They can be represented in network graphs like @fig-nested (students within schools):</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/nested.png)</span>{#fig-nested width=360px}</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>Sometimes, there is more than one level of clustering, like students clustered by middle and high schools. This is called a *crossed* structure, as shown in @fig-crossed, where we say that students are cross-classified by both middle and high schools. Another typical example in psychological experiments is when participants see multiple stimuli, each as an item, so the observations are cross-classified by both persons and items.</span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/crossed.png)</span>{#fig-crossed width=360px}</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a>The scenario of repeated measures nested within persons is particularly relevant, as essentially all longitudinal data are multilevel and should be modelled accordingly. It allows one to build individualized models to look at within-person changes, as well as between-person differences of those changes. Techniques such as dependent-sample $t$-test, repeated-measures ANOVA, growth curve modeling, and time-series analyses, can all be represented in the multilevel modeling framework. Therefore, some authors, such as @ mcelreath2020, suggest that MLM should be the default model we use for analyses rather than regression.</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>We will use the data set <span class="in">`sleepstudy`</span> from the <span class="in">`lme4`</span> package, a popular package for frequentist multilevel modeling. The data set contains 18 participants, each with 10 observations. It examines the change in average reaction time daily with increasing sleep deprivation. See <span class="in">`?lme4::sleepstudy`</span> for more of the description. Here is a plot of the the <span class="in">`Reaction`</span> variable:</span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-Reaction</span></span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of reaction times (ms)"</span></span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(sleepstudy, <span class="at">package =</span> <span class="st">"lme4"</span>)</span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(sleepstudy<span class="sc">$</span>Reaction)</span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>This data set has clustering because it is repeated measures nested within persons. For the initial example, we will only take the first three time points (Days 1-3).</span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a>sleep3 <span class="ot">&lt;-</span> sleepstudy <span class="sc">|&gt;</span></span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Days <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sleep3)  <span class="co"># first two people</span></span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a><span class="fu">## Long-Format Data</span></span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a>Note that the data above is in *long format*, which is typically required for multilevel analysis. Here, each row of the data represents one observation, so there are multiple rows for each person. This is in contrast to *wide format*, where each row represents one person and has multiple columns for each observation.</span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a>Here is a *spaghetti plot* of each individual over the three days:</span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-spaghetti</span></span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Reaction time change over three days."</span></span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sleep3, <span class="fu">aes</span>(<span class="at">x =</span> Days, <span class="at">y =</span> Reaction)) <span class="sc">+</span></span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> Subject)) <span class="sc">+</span></span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Reaction Time (ms)"</span>)</span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a>The plot shows a general increasing trend of reaction time.</span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis 1: Time as Nominal</span></span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a>This analysis is analogous to a repeated-measure ANOVA. Here, our interest is simply whether there are any differences across time, without any assumption on any linear or nonlinear trends. In other words, we treat time as a nominal variable.</span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model</span></span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a>We use $\text{Reaction}_{ij}$ to represent the reaction time for the $j$th person on the $i$th day.</span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a>  \text{Reaction}_{ij} &amp; \sim N(\mu_{ij}, \sigma)  <span class="sc">\\</span></span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a>  \mu_{ij} \sim N(\gamma_i, \tau)</span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\mu_{ij}$: the expected reaction time for person $j$ on day $i$.</span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\sigma$: the within-person error.</span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\gamma_i$: the mean reaction time across participants on day $i$.</span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\tau$: the between-person variance on a particular day.</span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a><span class="fu">## Assumptions</span></span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a>The above model assumes:</span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-146"><a href="#cb49-146" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Normality</span>
<span id="cb49-147"><a href="#cb49-147" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Homogeneity of error variance across observations</span>
<span id="cb49-148"><a href="#cb49-148" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Homogeneity of variance across persons</span>
<span id="cb49-149"><a href="#cb49-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-150"><a href="#cb49-150" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-151"><a href="#cb49-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-154"><a href="#cb49-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-155"><a href="#cb49-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Treat Days as a nominal variable</span></span>
<span id="cb49-156"><a href="#cb49-156" aria-hidden="true" tabindex="-1"></a>sleep3<span class="sc">$</span>Days_cat <span class="ot">&lt;-</span> <span class="fu">factor</span>(sleep3<span class="sc">$</span>Days)</span>
<span id="cb49-157"><a href="#cb49-157" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(Reaction <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Days_cat <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Subject),</span>
<span id="cb49-158"><a href="#cb49-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sleep3,</span>
<span id="cb49-159"><a href="#cb49-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2225</span>,</span>
<span id="cb49-160"><a href="#cb49-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"11_m1"</span>)</span>
<span id="cb49-161"><a href="#cb49-161" aria-hidden="true" tabindex="-1"></a>m1</span>
<span id="cb49-162"><a href="#cb49-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-163"><a href="#cb49-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-164"><a href="#cb49-164" aria-hidden="true" tabindex="-1"></a>The model estimates the mean reaction time on each day, as well as the between-person and within-person variances. One can visualize the means:</span>
<span id="cb49-165"><a href="#cb49-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-168"><a href="#cb49-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-169"><a href="#cb49-169" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-condeffects-m1</span></span>
<span id="cb49-170"><a href="#cb49-170" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Model predicted mean reaction times over three days."</span></span>
<span id="cb49-171"><a href="#cb49-171" aria-hidden="true" tabindex="-1"></a><span class="fu">conditional_effects</span>(m1)</span>
<span id="cb49-172"><a href="#cb49-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-173"><a href="#cb49-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-174"><a href="#cb49-174" aria-hidden="true" tabindex="-1"></a>One can compare this model to one where the mean reaction time is assumed equal across days:</span>
<span id="cb49-175"><a href="#cb49-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-178"><a href="#cb49-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-179"><a href="#cb49-179" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">brm</span>(Reaction <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Subject),</span>
<span id="cb49-180"><a href="#cb49-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sleep3,</span>
<span id="cb49-181"><a href="#cb49-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2225</span>,</span>
<span id="cb49-182"><a href="#cb49-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"11_m0"</span>)</span>
<span id="cb49-183"><a href="#cb49-183" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(m0, m1)</span>
<span id="cb49-184"><a href="#cb49-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-185"><a href="#cb49-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-186"><a href="#cb49-186" aria-hidden="true" tabindex="-1"></a>LOO indicates that allowing a different mean reaction time for each day fits the data better.</span>
<span id="cb49-187"><a href="#cb49-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-188"><a href="#cb49-188" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis 2: Growth Curve</span></span>
<span id="cb49-189"><a href="#cb49-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-190"><a href="#cb49-190" aria-hidden="true" tabindex="-1"></a>We will now use all 10 time points, and try to fit a line/curve to the time trend. @fig-curve shows the changes across participants.</span>
<span id="cb49-191"><a href="#cb49-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-194"><a href="#cb49-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-195"><a href="#cb49-195" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-curve</span></span>
<span id="cb49-196"><a href="#cb49-196" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Individual trajectories across days."</span></span>
<span id="cb49-197"><a href="#cb49-197" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sleepstudy, <span class="fu">aes</span>(<span class="at">x =</span> Days, <span class="at">y =</span> Reaction)) <span class="sc">+</span></span>
<span id="cb49-198"><a href="#cb49-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb49-199"><a href="#cb49-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb49-200"><a href="#cb49-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># presented by person</span></span>
<span id="cb49-201"><a href="#cb49-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subject, <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb49-202"><a href="#cb49-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-203"><a href="#cb49-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-204"><a href="#cb49-204" aria-hidden="true" tabindex="-1"></a>As you can see, most people experience increases in reaction time, although there are certainly differences across individuals, such that each person has a different trajectory.</span>
<span id="cb49-205"><a href="#cb49-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-206"><a href="#cb49-206" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intraclass correlation</span></span>
<span id="cb49-207"><a href="#cb49-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-208"><a href="#cb49-208" aria-hidden="true" tabindex="-1"></a>With multilevel data, the first question is how much variation in the outcome is at each level. This is quantified by the *intraclass correlation*, which, for a two-level model, is defined by</span>
<span id="cb49-209"><a href="#cb49-209" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-210"><a href="#cb49-210" aria-hidden="true" tabindex="-1"></a>\rho = \frac{\tau^2}{\tau^2 + \sigma^2}</span>
<span id="cb49-211"><a href="#cb49-211" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-212"><a href="#cb49-212" aria-hidden="true" tabindex="-1"></a>where $\tau$ is the between-level *SD*, which is the *SD* of the cluster means (i.e., the variability of mean response time across persons in this example), and $\sigma$ is the within-level *SD* (i.e., variability within a person, which is assumed constant across persons).</span>
<span id="cb49-213"><a href="#cb49-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-214"><a href="#cb49-214" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb49-215"><a href="#cb49-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-216"><a href="#cb49-216" aria-hidden="true" tabindex="-1"></a><span class="fu">## How Things Look With Different ICCs</span></span>
<span id="cb49-217"><a href="#cb49-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-218"><a href="#cb49-218" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The ICC represents the proportion of variance of the outcome that is due to between-level (e.g., between-group, between-person) differences</span></span>
<span id="cb49-219"><a href="#cb49-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-222"><a href="#cb49-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-223"><a href="#cb49-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb49-224"><a href="#cb49-224" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-icc-examples</span></span>
<span id="cb49-225"><a href="#cb49-225" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "ICC examples."</span></span>
<span id="cb49-226"><a href="#cb49-226" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 3</span></span>
<span id="cb49-227"><a href="#cb49-227" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 3</span></span>
<span id="cb49-228"><a href="#cb49-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap:</span></span>
<span id="cb49-229"><a href="#cb49-229" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "ICC close to 0"</span></span>
<span id="cb49-230"><a href="#cb49-230" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "ICC = .2"</span></span>
<span id="cb49-231"><a href="#cb49-231" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "ICC = .95"</span></span>
<span id="cb49-232"><a href="#cb49-232" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb49-233"><a href="#cb49-233" aria-hidden="true" tabindex="-1"></a>fake_dat1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb49-234"><a href="#cb49-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">person =</span> <span class="fu">as.character</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">25</span>)),</span>
<span id="cb49-235"><a href="#cb49-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">200</span>,</span>
<span id="cb49-236"><a href="#cb49-236" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">rnorm</span>(<span class="dv">8</span>, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb49-237"><a href="#cb49-237" aria-hidden="true" tabindex="-1"></a>        <span class="at">sd =</span> <span class="dv">10</span></span>
<span id="cb49-238"><a href="#cb49-238" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-239"><a href="#cb49-239" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-240"><a href="#cb49-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-241"><a href="#cb49-241" aria-hidden="true" tabindex="-1"></a>pbase <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fake_dat1, <span class="fu">aes</span>(<span class="at">x =</span> person, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb49-242"><a href="#cb49-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>, <span class="at">col =</span> <span class="st">"darkgrey"</span>) <span class="sc">+</span></span>
<span id="cb49-243"><a href="#cb49-243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(</span>
<span id="cb49-244"><a href="#cb49-244" aria-hidden="true" tabindex="-1"></a>        <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">fun =</span> mean,</span>
<span id="cb49-245"><a href="#cb49-245" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">4</span>, <span class="at">shape =</span> <span class="dv">24</span>, <span class="at">fill =</span> <span class="st">"red"</span></span>
<span id="cb49-246"><a href="#cb49-246" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-247"><a href="#cb49-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">20</span>, <span class="dv">80</span>) <span class="sc">+</span></span>
<span id="cb49-248"><a href="#cb49-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_blank</span>())</span>
<span id="cb49-249"><a href="#cb49-249" aria-hidden="true" tabindex="-1"></a>pbase</span>
<span id="cb49-250"><a href="#cb49-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-251"><a href="#cb49-251" aria-hidden="true" tabindex="-1"></a>fake_dat2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb49-252"><a href="#cb49-252" aria-hidden="true" tabindex="-1"></a>    <span class="at">person =</span> <span class="fu">as.character</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">25</span>)),</span>
<span id="cb49-253"><a href="#cb49-253" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">200</span>,</span>
<span id="cb49-254"><a href="#cb49-254" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">rnorm</span>(<span class="dv">8</span>, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">20</span>)),</span>
<span id="cb49-255"><a href="#cb49-255" aria-hidden="true" tabindex="-1"></a>        <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">80</span>)</span>
<span id="cb49-256"><a href="#cb49-256" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-257"><a href="#cb49-257" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-258"><a href="#cb49-258" aria-hidden="true" tabindex="-1"></a>pbase <span class="sc">%+%</span> fake_dat2</span>
<span id="cb49-259"><a href="#cb49-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-260"><a href="#cb49-260" aria-hidden="true" tabindex="-1"></a>fake_dat3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb49-261"><a href="#cb49-261" aria-hidden="true" tabindex="-1"></a>    <span class="at">person =</span> <span class="fu">as.character</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">25</span>)),</span>
<span id="cb49-262"><a href="#cb49-262" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">200</span>,</span>
<span id="cb49-263"><a href="#cb49-263" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">rnorm</span>(<span class="dv">8</span>, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">95</span>)),</span>
<span id="cb49-264"><a href="#cb49-264" aria-hidden="true" tabindex="-1"></a>        <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">5</span>)</span>
<span id="cb49-265"><a href="#cb49-265" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-266"><a href="#cb49-266" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-267"><a href="#cb49-267" aria-hidden="true" tabindex="-1"></a>pbase <span class="sc">%+%</span> fake_dat3</span>
<span id="cb49-268"><a href="#cb49-268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-269"><a href="#cb49-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-270"><a href="#cb49-270" aria-hidden="true" tabindex="-1"></a>As you can see, the higher the ICC, the higher the variations in the cluster means, relative to the within-cluster variations.</span>
<span id="cb49-271"><a href="#cb49-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-272"><a href="#cb49-272" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-273"><a href="#cb49-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-274"><a href="#cb49-274" aria-hidden="true" tabindex="-1"></a>@fig-icc-sleepstudy shows substantial between-person variation for the <span class="in">`sleepstudy`</span> data.</span>
<span id="cb49-275"><a href="#cb49-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-278"><a href="#cb49-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-279"><a href="#cb49-279" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-icc-sleepstudy</span></span>
<span id="cb49-280"><a href="#cb49-280" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "ICC for the `sleepstudy` data."</span></span>
<span id="cb49-281"><a href="#cb49-281" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sleepstudy, <span class="fu">aes</span>(<span class="at">x =</span> Subject, <span class="at">y =</span> Reaction)) <span class="sc">+</span></span>
<span id="cb49-282"><a href="#cb49-282" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>, <span class="at">col =</span> <span class="st">"darkgrey"</span>) <span class="sc">+</span></span>
<span id="cb49-283"><a href="#cb49-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(</span>
<span id="cb49-284"><a href="#cb49-284" aria-hidden="true" tabindex="-1"></a>        <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">fun =</span> mean,</span>
<span id="cb49-285"><a href="#cb49-285" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">4</span>, <span class="at">shape =</span> <span class="dv">24</span>, <span class="at">fill =</span> <span class="st">"red"</span></span>
<span id="cb49-286"><a href="#cb49-286" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-287"><a href="#cb49-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-288"><a href="#cb49-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-289"><a href="#cb49-289" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Computing ICC: Varying-intercept model</span></span>
<span id="cb49-290"><a href="#cb49-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-291"><a href="#cb49-291" aria-hidden="true" tabindex="-1"></a>To compute the ICC, we need first to fit a multilevel model, which in this case is the *varying intercept* model:</span>
<span id="cb49-292"><a href="#cb49-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-293"><a href="#cb49-293" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-294"><a href="#cb49-294" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-295"><a href="#cb49-295" aria-hidden="true" tabindex="-1"></a>  \text{Reaction}_{ij} &amp; \sim N(\mu_j, \sigma)  <span class="sc">\\</span></span>
<span id="cb49-296"><a href="#cb49-296" aria-hidden="true" tabindex="-1"></a>  \mu_j &amp; \sim N(\gamma, \tau)</span>
<span id="cb49-297"><a href="#cb49-297" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-298"><a href="#cb49-298" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-299"><a href="#cb49-299" aria-hidden="true" tabindex="-1"></a>where $\mu_j$ is the mean reaction for the $j$th person.</span>
<span id="cb49-300"><a href="#cb49-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-301"><a href="#cb49-301" aria-hidden="true" tabindex="-1"></a>We'll rescale <span class="in">`Reaction`</span> by 10:</span>
<span id="cb49-302"><a href="#cb49-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-305"><a href="#cb49-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-306"><a href="#cb49-306" aria-hidden="true" tabindex="-1"></a>sleepstudy <span class="ot">&lt;-</span> sleepstudy <span class="sc">|&gt;</span></span>
<span id="cb49-307"><a href="#cb49-307" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Reaction10 =</span> Reaction <span class="sc">/</span> <span class="dv">10</span>)</span>
<span id="cb49-308"><a href="#cb49-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-309"><a href="#cb49-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-310"><a href="#cb49-310" aria-hidden="true" tabindex="-1"></a>To use weakly informative priors, we will set</span>
<span id="cb49-311"><a href="#cb49-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-312"><a href="#cb49-312" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-313"><a href="#cb49-313" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-314"><a href="#cb49-314" aria-hidden="true" tabindex="-1"></a>  \gamma &amp; \sim N(0, 50)  <span class="sc">\\</span></span>
<span id="cb49-315"><a href="#cb49-315" aria-hidden="true" tabindex="-1"></a>  \sigma &amp; \sim t^+(4, 0, 5)  <span class="sc">\\</span></span>
<span id="cb49-316"><a href="#cb49-316" aria-hidden="true" tabindex="-1"></a>  \tau &amp; \sim \mathrm{Gamma}(2, 1 / 5)</span>
<span id="cb49-317"><a href="#cb49-317" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-318"><a href="#cb49-318" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-319"><a href="#cb49-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-322"><a href="#cb49-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-323"><a href="#cb49-323" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(Reaction10 <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">|</span> Subject), <span class="at">data =</span> sleepstudy,</span>
<span id="cb49-324"><a href="#cb49-324" aria-hidden="true" tabindex="-1"></a>          <span class="at">prior =</span> <span class="fu">c</span>(<span class="co"># for intercept</span></span>
<span id="cb49-325"><a href="#cb49-325" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb49-326"><a href="#cb49-326" aria-hidden="true" tabindex="-1"></a>            <span class="co"># for tau</span></span>
<span id="cb49-327"><a href="#cb49-327" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.2</span>), <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb49-328"><a href="#cb49-328" aria-hidden="true" tabindex="-1"></a>            <span class="co"># for sigma</span></span>
<span id="cb49-329"><a href="#cb49-329" aria-hidden="true" tabindex="-1"></a>            <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)),</span>
<span id="cb49-330"><a href="#cb49-330" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Higher adapt_delta is usually needed for MLM</span></span>
<span id="cb49-331"><a href="#cb49-331" aria-hidden="true" tabindex="-1"></a>          <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">95</span>),</span>
<span id="cb49-332"><a href="#cb49-332" aria-hidden="true" tabindex="-1"></a>          <span class="at">seed =</span> <span class="dv">2107</span>,</span>
<span id="cb49-333"><a href="#cb49-333" aria-hidden="true" tabindex="-1"></a>          <span class="at">file =</span> <span class="st">"11_m2"</span>)</span>
<span id="cb49-334"><a href="#cb49-334" aria-hidden="true" tabindex="-1"></a>m2</span>
<span id="cb49-335"><a href="#cb49-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-336"><a href="#cb49-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-337"><a href="#cb49-337" aria-hidden="true" tabindex="-1"></a>Now use the posterior draws of $\tau$ and $\sigma$ to compute the posterior for the ICC:</span>
<span id="cb49-338"><a href="#cb49-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-341"><a href="#cb49-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-342"><a href="#cb49-342" aria-hidden="true" tabindex="-1"></a>icc_draws <span class="ot">&lt;-</span> <span class="fu">as_draws</span>(m2, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"sd_Subject__Intercept"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb49-343"><a href="#cb49-343" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_variables</span>(</span>
<span id="cb49-344"><a href="#cb49-344" aria-hidden="true" tabindex="-1"></a>        <span class="at">icc =</span> sd_Subject__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (sd_Subject__Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> sigma<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb49-345"><a href="#cb49-345" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-346"><a href="#cb49-346" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(icc_draws)</span>
<span id="cb49-347"><a href="#cb49-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-348"><a href="#cb49-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-351"><a href="#cb49-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-352"><a href="#cb49-352" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-post-icc</span></span>
<span id="cb49-353"><a href="#cb49-353" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Posterior distribution of the ICC for reaction time."</span></span>
<span id="cb49-354"><a href="#cb49-354" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens</span>(icc_draws, <span class="at">pars =</span> <span class="st">"icc"</span>)</span>
<span id="cb49-355"><a href="#cb49-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-356"><a href="#cb49-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-357"><a href="#cb49-357" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb49-358"><a href="#cb49-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-359"><a href="#cb49-359" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpretations</span></span>
<span id="cb49-360"><a href="#cb49-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-363"><a href="#cb49-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-364"><a href="#cb49-364" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb49-365"><a href="#cb49-365" aria-hidden="true" tabindex="-1"></a>icc_summ <span class="ot">&lt;-</span> <span class="fu">summarize_draws</span>(icc_draws)</span>
<span id="cb49-366"><a href="#cb49-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-367"><a href="#cb49-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-370"><a href="#cb49-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-371"><a href="#cb49-371" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb49-372"><a href="#cb49-372" aria-hidden="true" tabindex="-1"></a>get_mean_ci <span class="ot">&lt;-</span> <span class="cf">function</span>(i, summ, <span class="at">scale =</span> <span class="dv">1</span>, <span class="at">unit =</span> <span class="st">""</span>, <span class="at">unit_ci =</span> unit) {</span>
<span id="cb49-373"><a href="#cb49-373" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(</span>
<span id="cb49-374"><a href="#cb49-374" aria-hidden="true" tabindex="-1"></a>        <span class="fu">comma</span>(summ[i, <span class="st">"Estimate"</span>] <span class="sc">*</span> scale, <span class="dv">2</span>), unit,</span>
<span id="cb49-375"><a href="#cb49-375" aria-hidden="true" tabindex="-1"></a>        <span class="st">", 90% CI ["</span>,</span>
<span id="cb49-376"><a href="#cb49-376" aria-hidden="true" tabindex="-1"></a>        <span class="fu">comma</span>(summ[i, <span class="st">"Q5"</span>] <span class="sc">*</span> scale, <span class="dv">2</span>), unit_ci, <span class="st">", "</span>,</span>
<span id="cb49-377"><a href="#cb49-377" aria-hidden="true" tabindex="-1"></a>        <span class="fu">comma</span>(summ[i, <span class="st">"Q95"</span>] <span class="sc">*</span> scale, <span class="dv">2</span>), unit_ci, <span class="st">"]"</span></span>
<span id="cb49-378"><a href="#cb49-378" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-379"><a href="#cb49-379" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-380"><a href="#cb49-380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-381"><a href="#cb49-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-382"><a href="#cb49-382" aria-hidden="true" tabindex="-1"></a>The model suggested that the average reaction time across individuals and measurement occasions was <span class="in">`r get_mean_ci(1, fixef(m2, prob = c(.05, .95)), scale = 10, unit = "ms")`</span>. It was estimated that <span class="in">`r round(icc_summ[["mean"]][3] * 100, 2)`</span>%, 90% CI <span class="co">[</span><span class="ot">`r round(icc_summ[["q5"]</span><span class="co">][3]</span> * 100, 2)<span class="in">`%, `</span>r round(icc_summ[<span class="co">[</span><span class="ot">"q95"</span><span class="co">]</span>]<span class="co">[</span><span class="ot">3</span><span class="co">]</span> * 100, 2)`%] of the variations in reaction time was attributed to between-person differences.</span>
<span id="cb49-383"><a href="#cb49-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-384"><a href="#cb49-384" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-385"><a href="#cb49-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-386"><a href="#cb49-386" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb49-387"><a href="#cb49-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-388"><a href="#cb49-388" aria-hidden="true" tabindex="-1"></a><span class="fu">## Is MLM Needed?</span></span>
<span id="cb49-389"><a href="#cb49-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-390"><a href="#cb49-390" aria-hidden="true" tabindex="-1"></a>This is a commonly asked question. Based on @lai2015, you can compute the design effect index, which shows the inflation in the variability of the estimates due to clustering. It is recommended to account for clustering if the design effect is larger than 1.1. It is defined as:</span>
<span id="cb49-391"><a href="#cb49-391" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-392"><a href="#cb49-392" aria-hidden="true" tabindex="-1"></a>\mathrm{Deff} = 1 + (n - 1) \rho</span>
<span id="cb49-393"><a href="#cb49-393" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-394"><a href="#cb49-394" aria-hidden="true" tabindex="-1"></a>where $n$ is the (average) number of observations in each cluster, and in our case it is 10. Therefore, the design effect in <span class="in">`sleepstudy`</span> for <span class="in">`Reaction`</span> is</span>
<span id="cb49-395"><a href="#cb49-395" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-396"><a href="#cb49-396" aria-hidden="true" tabindex="-1"></a>\mathrm{Deff} = 1 + (10 - 1) (<span class="in">`r icc_summ[["mean"]][3]`</span>)</span>
<span id="cb49-397"><a href="#cb49-397" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-398"><a href="#cb49-398" aria-hidden="true" tabindex="-1"></a>which is <span class="in">`r 1 + 9 * icc_summ[["mean"]][3]`</span>, so we do need to account for the clustering.</span>
<span id="cb49-399"><a href="#cb49-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-400"><a href="#cb49-400" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-401"><a href="#cb49-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-402"><a href="#cb49-402" aria-hidden="true" tabindex="-1"></a><span class="fu">## Varying Coefficients</span></span>
<span id="cb49-403"><a href="#cb49-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-404"><a href="#cb49-404" aria-hidden="true" tabindex="-1"></a>The strength of a multilevel model is that it can allow researchers to build models that allow for cluster-specific coefficients. In our example data, this is analogous to fitting separate models for each person, but instead of only using 10 data points for each model, MLM pools information from other people as it believes that we can learn something about one person by looking at data from other people.</span>
<span id="cb49-405"><a href="#cb49-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-406"><a href="#cb49-406" aria-hidden="true" tabindex="-1"></a>For example, for each person, we'll fit a regression model using <span class="in">`Days`</span> to predict <span class="in">`Reaction10`</span>. Using our previous notations,</span>
<span id="cb49-407"><a href="#cb49-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-408"><a href="#cb49-408" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-409"><a href="#cb49-409" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-410"><a href="#cb49-410" aria-hidden="true" tabindex="-1"></a>  \text{Reaction10}_i &amp; \sim N(\mu_i, \sigma)  <span class="sc">\\</span></span>
<span id="cb49-411"><a href="#cb49-411" aria-hidden="true" tabindex="-1"></a>  \mu_i &amp; = \beta_0 + \beta_1 \text{Days}_i</span>
<span id="cb49-412"><a href="#cb49-412" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-413"><a href="#cb49-413" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-414"><a href="#cb49-414" aria-hidden="true" tabindex="-1"></a>However, because we have more than one person, we'll use the subscript $j$ to denote the person, so that the model becomes</span>
<span id="cb49-415"><a href="#cb49-415" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-416"><a href="#cb49-416" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-417"><a href="#cb49-417" aria-hidden="true" tabindex="-1"></a>  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma_j)  <span class="sc">\\</span></span>
<span id="cb49-418"><a href="#cb49-418" aria-hidden="true" tabindex="-1"></a>  \mu_{ij} &amp; = \beta_{0j} + \beta_{1j} \text{Days}_{ij}</span>
<span id="cb49-419"><a href="#cb49-419" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-420"><a href="#cb49-420" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-421"><a href="#cb49-421" aria-hidden="true" tabindex="-1"></a>which suggests that all three of $\beta_0$, $\beta_1$, and $\sigma$ can be different across persons. We'll first start with varying $\beta_0$, or *varying intercepts*.</span>
<span id="cb49-422"><a href="#cb49-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-423"><a href="#cb49-423" aria-hidden="true" tabindex="-1"></a><span class="fu">### Varying Intercepts</span></span>
<span id="cb49-424"><a href="#cb49-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-425"><a href="#cb49-425" aria-hidden="true" tabindex="-1"></a>With varying intercepts model, we assumed that only $\beta_0$ is different across persons, but $\beta_1$ and $\sigma$ are common parameters that do not change across persons. This is called a *random intercept model* in (frequentist) MLM literature. Specifically, the model and priors are:</span>
<span id="cb49-426"><a href="#cb49-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-427"><a href="#cb49-427" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-428"><a href="#cb49-428" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-429"><a href="#cb49-429" aria-hidden="true" tabindex="-1"></a>\text{Repeated-measure level:}  <span class="sc">\\</span></span>
<span id="cb49-430"><a href="#cb49-430" aria-hidden="true" tabindex="-1"></a>  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma)  <span class="sc">\\</span></span>
<span id="cb49-431"><a href="#cb49-431" aria-hidden="true" tabindex="-1"></a>  \mu_{ij} &amp; = \beta_{0j} + \beta_{1} \text{Days}_{ij}  <span class="sc">\\</span></span>
<span id="cb49-432"><a href="#cb49-432" aria-hidden="true" tabindex="-1"></a>\text{Person level:}  <span class="sc">\\</span></span>
<span id="cb49-433"><a href="#cb49-433" aria-hidden="true" tabindex="-1"></a>  \beta_{0j} &amp; \sim N(\mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>}, \tau^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>})  <span class="sc">\\</span></span>
<span id="cb49-434"><a href="#cb49-434" aria-hidden="true" tabindex="-1"></a>\text{Priors:}  <span class="sc">\\</span></span>
<span id="cb49-435"><a href="#cb49-435" aria-hidden="true" tabindex="-1"></a>  \mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>} &amp; \sim N(0, 50) <span class="sc">\\</span></span>
<span id="cb49-436"><a href="#cb49-436" aria-hidden="true" tabindex="-1"></a>  \tau^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>} &amp; \sim \mathrm{Gamma}(2, 0.2) <span class="sc">\\</span></span>
<span id="cb49-437"><a href="#cb49-437" aria-hidden="true" tabindex="-1"></a>  \beta_1 &amp; \sim N(0, 10) <span class="sc">\\</span></span>
<span id="cb49-438"><a href="#cb49-438" aria-hidden="true" tabindex="-1"></a>  \sigma &amp; \sim t^+(4, 0, 5)</span>
<span id="cb49-439"><a href="#cb49-439" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-440"><a href="#cb49-440" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-441"><a href="#cb49-441" aria-hidden="true" tabindex="-1"></a>where the $\beta_{0j}$s follow a common normal distribution with hyperparameters $\mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>}$ and $\tau^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>}$. Thus, $\mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>}$ is the *grand intercept*, or the average intercept across persons, and $\tau^{[\beta_0]}$ is the *SD* of those intercepts.</span>
<span id="cb49-442"><a href="#cb49-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-443"><a href="#cb49-443" aria-hidden="true" tabindex="-1"></a>The model can be fitted in <span class="in">`brms`</span>:</span>
<span id="cb49-444"><a href="#cb49-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-447"><a href="#cb49-447" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-448"><a href="#cb49-448" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(Reaction10 <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Subject),</span>
<span id="cb49-449"><a href="#cb49-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sleepstudy,</span>
<span id="cb49-450"><a href="#cb49-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>( <span class="co"># for intercept</span></span>
<span id="cb49-451"><a href="#cb49-451" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb49-452"><a href="#cb49-452" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for slope</span></span>
<span id="cb49-453"><a href="#cb49-453" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb49-454"><a href="#cb49-454" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for tau</span></span>
<span id="cb49-455"><a href="#cb49-455" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.2</span>), <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb49-456"><a href="#cb49-456" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for sigma</span></span>
<span id="cb49-457"><a href="#cb49-457" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb49-458"><a href="#cb49-458" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-459"><a href="#cb49-459" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">95</span>),</span>
<span id="cb49-460"><a href="#cb49-460" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2107</span>,</span>
<span id="cb49-461"><a href="#cb49-461" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"11_m3"</span></span>
<span id="cb49-462"><a href="#cb49-462" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-463"><a href="#cb49-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-464"><a href="#cb49-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-467"><a href="#cb49-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-468"><a href="#cb49-468" aria-hidden="true" tabindex="-1"></a>m3</span>
<span id="cb49-469"><a href="#cb49-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-470"><a href="#cb49-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-471"><a href="#cb49-471" aria-hidden="true" tabindex="-1"></a>Let's check the fit of the model to the data, first to the overall data and then to each individual.</span>
<span id="cb49-472"><a href="#cb49-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-473"><a href="#cb49-473" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fit of Overall data</span></span>
<span id="cb49-474"><a href="#cb49-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-477"><a href="#cb49-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-478"><a href="#cb49-478" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fit-m3</span></span>
<span id="cb49-479"><a href="#cb49-479" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Marginal model plot of the overall data."</span></span>
<span id="cb49-480"><a href="#cb49-480" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(m3, <span class="at">type =</span> <span class="st">"intervals"</span>, <span class="at">x =</span> <span class="st">"Days"</span>,</span>
<span id="cb49-481"><a href="#cb49-481" aria-hidden="true" tabindex="-1"></a>         <span class="at">re_formula =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb49-482"><a href="#cb49-482" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb49-483"><a href="#cb49-483" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_obs), <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span>
<span id="cb49-484"><a href="#cb49-484" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-485"><a href="#cb49-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-486"><a href="#cb49-486" aria-hidden="true" tabindex="-1"></a>As can be seen, the estimated coefficient for <span class="in">`Days`</span>, which was assumed constant for everyone, fit the overall data. However, does it fit each individual?</span>
<span id="cb49-487"><a href="#cb49-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-488"><a href="#cb49-488" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fit of Individuals</span></span>
<span id="cb49-489"><a href="#cb49-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-492"><a href="#cb49-492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-493"><a href="#cb49-493" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fit-individuals-m3</span></span>
<span id="cb49-494"><a href="#cb49-494" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Marginal model plot by individuals, with only varying intercepts."</span></span>
<span id="cb49-495"><a href="#cb49-495" aria-hidden="true" tabindex="-1"></a>ce_m3 <span class="ot">&lt;-</span> <span class="fu">conditional_effects</span>(m3,</span>
<span id="cb49-496"><a href="#cb49-496" aria-hidden="true" tabindex="-1"></a>    <span class="at">re_formula =</span> <span class="cn">NULL</span>,</span>
<span id="cb49-497"><a href="#cb49-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">conditions =</span> <span class="fu">data.frame</span>(<span class="at">Subject =</span> <span class="fu">unique</span>(sleepstudy<span class="sc">$</span>Subject))</span>
<span id="cb49-498"><a href="#cb49-498" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-499"><a href="#cb49-499" aria-hidden="true" tabindex="-1"></a><span class="co"># Add original outcome variable</span></span>
<span id="cb49-500"><a href="#cb49-500" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ce_m3, <span class="at">points =</span> <span class="cn">TRUE</span>, <span class="at">ncol =</span> <span class="dv">6</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]] <span class="sc">+</span></span>
<span id="cb49-501"><a href="#cb49-501" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb49-502"><a href="#cb49-502" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">attr</span>(ce_m3[[<span class="dv">1</span>]], <span class="st">"points"</span>),</span>
<span id="cb49-503"><a href="#cb49-503" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> Days, <span class="at">y =</span> resp__),</span>
<span id="cb49-504"><a href="#cb49-504" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">col =</span> <span class="st">"red"</span>,</span>
<span id="cb49-505"><a href="#cb49-505" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb49-506"><a href="#cb49-506" aria-hidden="true" tabindex="-1"></a>        <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb49-507"><a href="#cb49-507" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-508"><a href="#cb49-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-509"><a href="#cb49-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-510"><a href="#cb49-510" aria-hidden="true" tabindex="-1"></a>Obviously, it only fits a few individuals, but not all. So let's also allow $\beta_1$ to vary.</span>
<span id="cb49-511"><a href="#cb49-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-512"><a href="#cb49-512" aria-hidden="true" tabindex="-1"></a><span class="fu">### Varying Slopes</span></span>
<span id="cb49-513"><a href="#cb49-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-514"><a href="#cb49-514" aria-hidden="true" tabindex="-1"></a>We'll now also allow $\beta_1$ to vary across clusters, with the following model:</span>
<span id="cb49-515"><a href="#cb49-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-516"><a href="#cb49-516" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-517"><a href="#cb49-517" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-518"><a href="#cb49-518" aria-hidden="true" tabindex="-1"></a>\text{Repeated-measure level:}  <span class="sc">\\</span></span>
<span id="cb49-519"><a href="#cb49-519" aria-hidden="true" tabindex="-1"></a>  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma)  <span class="sc">\\</span></span>
<span id="cb49-520"><a href="#cb49-520" aria-hidden="true" tabindex="-1"></a>  \mu_{ij} &amp; = \beta_{0j} + \beta_{1j} \text{Days}_{ij}  <span class="sc">\\</span></span>
<span id="cb49-521"><a href="#cb49-521" aria-hidden="true" tabindex="-1"></a>\text{Person level:}  <span class="sc">\\</span></span>
<span id="cb49-522"><a href="#cb49-522" aria-hidden="true" tabindex="-1"></a>  \begin{bmatrix}</span>
<span id="cb49-523"><a href="#cb49-523" aria-hidden="true" tabindex="-1"></a>    \beta_{0j} <span class="sc">\\</span></span>
<span id="cb49-524"><a href="#cb49-524" aria-hidden="true" tabindex="-1"></a>    \beta_{1j} <span class="sc">\\</span></span>
<span id="cb49-525"><a href="#cb49-525" aria-hidden="true" tabindex="-1"></a>  \end{bmatrix} &amp; \sim N_2\left(</span>
<span id="cb49-526"><a href="#cb49-526" aria-hidden="true" tabindex="-1"></a>    \begin{bmatrix}</span>
<span id="cb49-527"><a href="#cb49-527" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>} <span class="sc">\\</span></span>
<span id="cb49-528"><a href="#cb49-528" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">\beta_1</span><span class="co">]</span>} <span class="sc">\\</span></span>
<span id="cb49-529"><a href="#cb49-529" aria-hidden="true" tabindex="-1"></a>    \end{bmatrix}, \mathbf T</span>
<span id="cb49-530"><a href="#cb49-530" aria-hidden="true" tabindex="-1"></a>    \right)</span>
<span id="cb49-531"><a href="#cb49-531" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-532"><a href="#cb49-532" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-533"><a href="#cb49-533" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb49-534"><a href="#cb49-534" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-535"><a href="#cb49-535" aria-hidden="true" tabindex="-1"></a>\mathbf T = \begin{bmatrix}</span>
<span id="cb49-536"><a href="#cb49-536" aria-hidden="true" tabindex="-1"></a>      {\tau^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>}}^2 &amp; <span class="sc">\\</span></span>
<span id="cb49-537"><a href="#cb49-537" aria-hidden="true" tabindex="-1"></a>      \tau^{\beta{10}} &amp; {\tau^{<span class="co">[</span><span class="ot">\beta_1</span><span class="co">]</span>}}^2 <span class="sc">\\</span></span>
<span id="cb49-538"><a href="#cb49-538" aria-hidden="true" tabindex="-1"></a>    \end{bmatrix}</span>
<span id="cb49-539"><a href="#cb49-539" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-540"><a href="#cb49-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-541"><a href="#cb49-541" aria-hidden="true" tabindex="-1"></a>Note that $N_2$ denotes a bivariate normal (i.e., 2-dimensional multivariate normal) distribution, because now we can talk about how $\beta_0$ and $\beta_1$ are associated at the person level. Generally, I don't interpret the covariance between them because it largely depends on how the variables were centered, but we should allow them to be correlated. The parameter $\tau^{\beta{10}}$ thus denotes their covariance.</span>
<span id="cb49-542"><a href="#cb49-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-543"><a href="#cb49-543" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb49-544"><a href="#cb49-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-545"><a href="#cb49-545" aria-hidden="true" tabindex="-1"></a>Programs using Gibbs sampling, such as <span class="in">`MCMCglmm`</span>, use an inverse-Wishart distribution as a prior for the covariance matrix $\mathbf T$, but it has been shown to usually lead to biased and inefficient estimates.</span>
<span id="cb49-546"><a href="#cb49-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-547"><a href="#cb49-547" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-548"><a href="#cb49-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-549"><a href="#cb49-549" aria-hidden="true" tabindex="-1"></a>To estimate $\mathbf T$, recent recommendations, as implemented in <span class="in">`brms`</span>, suggest decomposing $\mathbf T$ into a correlation matrix and the scaling matrices, and using an LKJ prior to the correlation matrix. We explain the LKJ prior in @imp-lkj-prior. Let's first do the decomposition:</span>
<span id="cb49-550"><a href="#cb49-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-551"><a href="#cb49-551" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-552"><a href="#cb49-552" aria-hidden="true" tabindex="-1"></a>\mathbf T = \mathrm{diag}(\boldsymbol{\tau}) \boldsymbol{\Omega} \mathrm{diag}(\boldsymbol{\tau}),</span>
<span id="cb49-553"><a href="#cb49-553" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-554"><a href="#cb49-554" aria-hidden="true" tabindex="-1"></a>where $\mathbf T$ = $<span class="co">[</span><span class="ot">\tau_1, \tau_2, \ldots</span><span class="co">]</span>$ is a vector containing the scale parameters (i.e., *SD*) of the varying coefficients, and $\boldsymbol{\Omega}$ is the correlation matrix of the varying coefficients.</span>
<span id="cb49-555"><a href="#cb49-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-556"><a href="#cb49-556" aria-hidden="true" tabindex="-1"></a>::: {#imp-lkj-prior .callout-important}</span>
<span id="cb49-557"><a href="#cb49-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-558"><a href="#cb49-558" aria-hidden="true" tabindex="-1"></a><span class="fu">## LKJ Prior</span></span>
<span id="cb49-559"><a href="#cb49-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-560"><a href="#cb49-560" aria-hidden="true" tabindex="-1"></a>The LKJ Prior is a probability distribution for correlation matrices. A correlation matrix has 1 on all the diagonal elements. For example, a 2 $\times$ 2 correlation matrix is</span>
<span id="cb49-561"><a href="#cb49-561" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-562"><a href="#cb49-562" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb49-563"><a href="#cb49-563" aria-hidden="true" tabindex="-1"></a>    1 &amp; <span class="sc">\\</span></span>
<span id="cb49-564"><a href="#cb49-564" aria-hidden="true" tabindex="-1"></a>    0.35 &amp; 1</span>
<span id="cb49-565"><a href="#cb49-565" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}</span>
<span id="cb49-566"><a href="#cb49-566" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-567"><a href="#cb49-567" aria-hidden="true" tabindex="-1"></a>where the correlation is 0.35. Therefore, with two variables, there is one correlation; with three or more variables, the number of correlations will be $q (q - 1) / 2$, where $q$ is the number of variables.</span>
<span id="cb49-568"><a href="#cb49-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-569"><a href="#cb49-569" aria-hidden="true" tabindex="-1"></a>For a correlation matrix of a given size, the LKJ prior has one shape parameter, $\eta$, where $\eta = 1$ corresponds to a uniform distribution of the correlations such that any correlations are equally likely, $\eta \geq 1$ favors a matrix closer to an identity matrix so that the correlations are closer to zero, and $\eta \leq 1$ favors a matrix with larger correlations. For a 2 $\times$ 2 matrix, the distribution of the correlation, $\rho$, with different $\eta$ values are shown in the graph below:</span>
<span id="cb49-570"><a href="#cb49-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-573"><a href="#cb49-573" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-574"><a href="#cb49-574" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb49-575"><a href="#cb49-575" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "LKJ prior on a correlation with different different $\\eta$ values."</span></span>
<span id="cb49-576"><a href="#cb49-576" aria-hidden="true" tabindex="-1"></a>dlkjcorr2 <span class="ot">&lt;-</span> <span class="cf">function</span>(rho, <span class="at">eta =</span> <span class="dv">1</span>, <span class="at">log =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb49-577"><a href="#cb49-577" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Function to compute the LKJ density given a correlation</span></span>
<span id="cb49-578"><a href="#cb49-578" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> (eta <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> rho<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span></span>
<span id="cb49-579"><a href="#cb49-579" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">log</span>(pi) <span class="sc">-</span> <span class="fu">lgamma</span>(eta) <span class="sc">+</span> <span class="fu">lgamma</span>(eta <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb49-580"><a href="#cb49-580" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>log) out <span class="ot">&lt;-</span> <span class="fu">exp</span>(out)</span>
<span id="cb49-581"><a href="#cb49-581" aria-hidden="true" tabindex="-1"></a>    out</span>
<span id="cb49-582"><a href="#cb49-582" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-583"><a href="#cb49-583" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">rho =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)), <span class="fu">aes</span>(<span class="at">x =</span> rho)) <span class="sc">+</span></span>
<span id="cb49-584"><a href="#cb49-584" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb49-585"><a href="#cb49-585" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dlkjcorr2, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">eta =</span> <span class="fl">0.1</span>),</span>
<span id="cb49-586"><a href="#cb49-586" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"0.1"</span>), <span class="at">n =</span> <span class="dv">501</span></span>
<span id="cb49-587"><a href="#cb49-587" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-588"><a href="#cb49-588" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb49-589"><a href="#cb49-589" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dlkjcorr2, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">eta =</span> <span class="fl">0.5</span>),</span>
<span id="cb49-590"><a href="#cb49-590" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"0.5"</span>), <span class="at">n =</span> <span class="dv">501</span></span>
<span id="cb49-591"><a href="#cb49-591" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-592"><a href="#cb49-592" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb49-593"><a href="#cb49-593" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dlkjcorr2, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">eta =</span> <span class="dv">1</span>),</span>
<span id="cb49-594"><a href="#cb49-594" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"1"</span>), <span class="at">n =</span> <span class="dv">501</span></span>
<span id="cb49-595"><a href="#cb49-595" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-596"><a href="#cb49-596" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb49-597"><a href="#cb49-597" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dlkjcorr2, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">eta =</span> <span class="dv">2</span>),</span>
<span id="cb49-598"><a href="#cb49-598" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"2"</span>), <span class="at">n =</span> <span class="dv">501</span></span>
<span id="cb49-599"><a href="#cb49-599" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-600"><a href="#cb49-600" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb49-601"><a href="#cb49-601" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dlkjcorr2, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">eta =</span> <span class="dv">10</span>),</span>
<span id="cb49-602"><a href="#cb49-602" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"10"</span>), <span class="at">n =</span> <span class="dv">501</span></span>
<span id="cb49-603"><a href="#cb49-603" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-604"><a href="#cb49-604" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(</span>
<span id="cb49-605"><a href="#cb49-605" aria-hidden="true" tabindex="-1"></a>        <span class="at">fun =</span> dlkjcorr2, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">eta =</span> <span class="dv">100</span>),</span>
<span id="cb49-606"><a href="#cb49-606" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">col =</span> <span class="st">"100"</span>), <span class="at">n =</span> <span class="dv">501</span></span>
<span id="cb49-607"><a href="#cb49-607" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-608"><a href="#cb49-608" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">col =</span> <span class="fu">expression</span>(eta), <span class="at">x =</span> <span class="fu">expression</span>(rho), <span class="at">y =</span> <span class="st">"Density"</span>)</span>
<span id="cb49-609"><a href="#cb49-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-610"><a href="#cb49-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-611"><a href="#cb49-611" aria-hidden="true" tabindex="-1"></a>As you can see, when $\eta$ increases, the correlation is more concentrated to zero.</span>
<span id="cb49-612"><a href="#cb49-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-613"><a href="#cb49-613" aria-hidden="true" tabindex="-1"></a>The default of <span class="in">`brms`</span> is to use $\eta$ = 1, which is non-informative. If you have a weak but informative belief that the correlations shouldn't be very large, using $\eta$ = 2 is reasonable.</span>
<span id="cb49-614"><a href="#cb49-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-615"><a href="#cb49-615" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-616"><a href="#cb49-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-617"><a href="#cb49-617" aria-hidden="true" tabindex="-1"></a>The resulting model and priors are:</span>
<span id="cb49-618"><a href="#cb49-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-619"><a href="#cb49-619" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-620"><a href="#cb49-620" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-621"><a href="#cb49-621" aria-hidden="true" tabindex="-1"></a>\text{Repeated-measure level:}  <span class="sc">\\</span></span>
<span id="cb49-622"><a href="#cb49-622" aria-hidden="true" tabindex="-1"></a>  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma)  <span class="sc">\\</span></span>
<span id="cb49-623"><a href="#cb49-623" aria-hidden="true" tabindex="-1"></a>  \mu_{ij} &amp; = \beta_{0j} + \beta_{1j} \text{Days}_{ij}  <span class="sc">\\</span></span>
<span id="cb49-624"><a href="#cb49-624" aria-hidden="true" tabindex="-1"></a>\text{Person level:}  <span class="sc">\\</span></span>
<span id="cb49-625"><a href="#cb49-625" aria-hidden="true" tabindex="-1"></a>  \begin{bmatrix}</span>
<span id="cb49-626"><a href="#cb49-626" aria-hidden="true" tabindex="-1"></a>    \beta_{0j} <span class="sc">\\</span></span>
<span id="cb49-627"><a href="#cb49-627" aria-hidden="true" tabindex="-1"></a>    \beta_{1j} <span class="sc">\\</span></span>
<span id="cb49-628"><a href="#cb49-628" aria-hidden="true" tabindex="-1"></a>  \end{bmatrix} &amp; \sim N_2\left(</span>
<span id="cb49-629"><a href="#cb49-629" aria-hidden="true" tabindex="-1"></a>    \begin{bmatrix}</span>
<span id="cb49-630"><a href="#cb49-630" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>} <span class="sc">\\</span></span>
<span id="cb49-631"><a href="#cb49-631" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">\beta_1</span><span class="co">]</span>} <span class="sc">\\</span></span>
<span id="cb49-632"><a href="#cb49-632" aria-hidden="true" tabindex="-1"></a>    \end{bmatrix}, \mathbf T</span>
<span id="cb49-633"><a href="#cb49-633" aria-hidden="true" tabindex="-1"></a>    \right)  <span class="sc">\\</span></span>
<span id="cb49-634"><a href="#cb49-634" aria-hidden="true" tabindex="-1"></a>  \mathbf T &amp; = \mathrm{diag}(\boldsymbol{\tau}) \boldsymbol{\Omega} \mathrm{diag}(\boldsymbol{\tau}) <span class="sc">\\</span></span>
<span id="cb49-635"><a href="#cb49-635" aria-hidden="true" tabindex="-1"></a>\text{Priors:}  <span class="sc">\\</span></span>
<span id="cb49-636"><a href="#cb49-636" aria-hidden="true" tabindex="-1"></a>  \mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>} &amp; \sim N(0, 50) <span class="sc">\\</span></span>
<span id="cb49-637"><a href="#cb49-637" aria-hidden="true" tabindex="-1"></a>  \mu^{<span class="co">[</span><span class="ot">\beta_1</span><span class="co">]</span>} &amp; \sim N(0, 10) <span class="sc">\\</span></span>
<span id="cb49-638"><a href="#cb49-638" aria-hidden="true" tabindex="-1"></a>  \tau^{<span class="co">[</span><span class="ot">\beta_m</span><span class="co">]</span>} &amp; \sim \mathrm{Gamma}(2, 0.2), \; m = 0, 1 <span class="sc">\\</span></span>
<span id="cb49-639"><a href="#cb49-639" aria-hidden="true" tabindex="-1"></a>  \boldsymbol{\Omega} &amp; \sim \mathrm{LKJ}(1) <span class="sc">\\</span></span>
<span id="cb49-640"><a href="#cb49-640" aria-hidden="true" tabindex="-1"></a>  \sigma &amp; \sim t^+(4, 0, 5)</span>
<span id="cb49-641"><a href="#cb49-641" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-642"><a href="#cb49-642" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-643"><a href="#cb49-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-646"><a href="#cb49-646" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-647"><a href="#cb49-647" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">brm</span>(Reaction10 <span class="sc">~</span> Days <span class="sc">+</span> (Days <span class="sc">|</span> Subject),</span>
<span id="cb49-648"><a href="#cb49-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sleepstudy,</span>
<span id="cb49-649"><a href="#cb49-649" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>( <span class="co"># for intercept</span></span>
<span id="cb49-650"><a href="#cb49-650" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb49-651"><a href="#cb49-651" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for slope</span></span>
<span id="cb49-652"><a href="#cb49-652" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb49-653"><a href="#cb49-653" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for tau_beta0 and tau_beta1</span></span>
<span id="cb49-654"><a href="#cb49-654" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.2</span>), <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">group =</span> <span class="st">"Subject"</span>),</span>
<span id="cb49-655"><a href="#cb49-655" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for correlation</span></span>
<span id="cb49-656"><a href="#cb49-656" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"cor"</span>),</span>
<span id="cb49-657"><a href="#cb49-657" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for sigma</span></span>
<span id="cb49-658"><a href="#cb49-658" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb49-659"><a href="#cb49-659" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-660"><a href="#cb49-660" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">95</span>),</span>
<span id="cb49-661"><a href="#cb49-661" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2107</span>,</span>
<span id="cb49-662"><a href="#cb49-662" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"11_m4"</span></span>
<span id="cb49-663"><a href="#cb49-663" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-664"><a href="#cb49-664" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-665"><a href="#cb49-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-668"><a href="#cb49-668" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-669"><a href="#cb49-669" aria-hidden="true" tabindex="-1"></a>m4</span>
<span id="cb49-670"><a href="#cb49-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-671"><a href="#cb49-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-672"><a href="#cb49-672" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fit of Individuals</span></span>
<span id="cb49-673"><a href="#cb49-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-676"><a href="#cb49-676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-677"><a href="#cb49-677" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb49-678"><a href="#cb49-678" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fit-individuals-m4</span></span>
<span id="cb49-679"><a href="#cb49-679" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Marginal model plot by individuals, with varying slopes."</span></span>
<span id="cb49-680"><a href="#cb49-680" aria-hidden="true" tabindex="-1"></a>ce_m4 <span class="ot">&lt;-</span> <span class="fu">conditional_effects</span>(m4,</span>
<span id="cb49-681"><a href="#cb49-681" aria-hidden="true" tabindex="-1"></a>    <span class="at">re_formula =</span> <span class="cn">NULL</span>,</span>
<span id="cb49-682"><a href="#cb49-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">conditions =</span> <span class="fu">data.frame</span>(<span class="at">Subject =</span> <span class="fu">unique</span>(sleepstudy<span class="sc">$</span>Subject))</span>
<span id="cb49-683"><a href="#cb49-683" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-684"><a href="#cb49-684" aria-hidden="true" tabindex="-1"></a><span class="co"># Add original outcome variable</span></span>
<span id="cb49-685"><a href="#cb49-685" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ce_m4, <span class="at">points =</span> <span class="cn">TRUE</span>, <span class="at">ncol =</span> <span class="dv">6</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]] <span class="sc">+</span></span>
<span id="cb49-686"><a href="#cb49-686" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb49-687"><a href="#cb49-687" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">attr</span>(ce_m4[[<span class="dv">1</span>]], <span class="st">"points"</span>),</span>
<span id="cb49-688"><a href="#cb49-688" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> Days, <span class="at">y =</span> resp__),</span>
<span id="cb49-689"><a href="#cb49-689" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">col =</span> <span class="st">"red"</span>,</span>
<span id="cb49-690"><a href="#cb49-690" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb49-691"><a href="#cb49-691" aria-hidden="true" tabindex="-1"></a>        <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb49-692"><a href="#cb49-692" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-693"><a href="#cb49-693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-694"><a href="#cb49-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-695"><a href="#cb49-695" aria-hidden="true" tabindex="-1"></a>You can see that the fit is better. You can also visualize the varying regression lines:</span>
<span id="cb49-696"><a href="#cb49-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-699"><a href="#cb49-699" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-700"><a href="#cb49-700" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-varying-m4</span></span>
<span id="cb49-701"><a href="#cb49-701" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Varying regression lines on the same plot."</span></span>
<span id="cb49-702"><a href="#cb49-702" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb49-703"><a href="#cb49-703" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conditional_effects</span>(m4,</span>
<span id="cb49-704"><a href="#cb49-704" aria-hidden="true" tabindex="-1"></a>        <span class="at">effects =</span> <span class="st">"Days:Subject"</span>,</span>
<span id="cb49-705"><a href="#cb49-705" aria-hidden="true" tabindex="-1"></a>        <span class="at">re_formula =</span> <span class="cn">NULL</span>,</span>
<span id="cb49-706"><a href="#cb49-706" aria-hidden="true" tabindex="-1"></a>        <span class="co"># suppress credible band</span></span>
<span id="cb49-707"><a href="#cb49-707" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="dv">0</span></span>
<span id="cb49-708"><a href="#cb49-708" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-709"><a href="#cb49-709" aria-hidden="true" tabindex="-1"></a>    <span class="at">points =</span> <span class="cn">TRUE</span>,</span>
<span id="cb49-710"><a href="#cb49-710" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="fl">0.5</span>),</span>
<span id="cb49-711"><a href="#cb49-711" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-712"><a href="#cb49-712" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-713"><a href="#cb49-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-714"><a href="#cb49-714" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb49-715"><a href="#cb49-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-716"><a href="#cb49-716" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpretations</span></span>
<span id="cb49-717"><a href="#cb49-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-720"><a href="#cb49-720" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-721"><a href="#cb49-721" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb49-722"><a href="#cb49-722" aria-hidden="true" tabindex="-1"></a>tau_m4 <span class="ot">&lt;-</span> <span class="fu">VarCorr</span>(m4, <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">05</span>, .<span class="dv">95</span>))<span class="sc">$</span>Subject<span class="sc">$</span>sd</span>
<span id="cb49-723"><a href="#cb49-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-724"><a href="#cb49-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-725"><a href="#cb49-725" aria-hidden="true" tabindex="-1"></a>Based on the model, at Day 0, the average reaction time across individuals was <span class="in">`r get_mean_ci(1, fixef(m4, probs = c(.05, .95)), scale = 10, unit = "ms")`</span>, and the *SD* at Day 0 was <span class="in">`r tau_m4["Intercept", "Estimate"] * 10`</span>ms, 95% CI <span class="co">[</span><span class="ot">`r tau_m4["Intercept", "Q5"] * 10`ms, `r tau_m4["Intercept", "Q95"] * 10`ms</span><span class="co">]</span>.</span>
<span id="cb49-726"><a href="#cb49-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-727"><a href="#cb49-727" aria-hidden="true" tabindex="-1"></a>The average rate of change per day in reaction time across individuals was <span class="in">`r get_mean_ci(2, fixef(m4, probs = c(.05, .95)), scale = 10, unit = "ms")`</span>, and the *SD* of the rates of change at Day 0 was <span class="in">`r tau_m4["Days", "Estimate"] * 10`</span>ms, 95% CI <span class="co">[</span><span class="ot">`r tau_m4["Days", "Q5"] * 10`ms, `r tau_m4["Days", "Q95"] * 10`ms</span><span class="co">]</span>, as shown in @fig-varying-m4.</span>
<span id="cb49-728"><a href="#cb49-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-729"><a href="#cb49-729" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-730"><a href="#cb49-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-731"><a href="#cb49-731" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb49-732"><a href="#cb49-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-733"><a href="#cb49-733" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fixed-Effects Model</span></span>
<span id="cb49-734"><a href="#cb49-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-735"><a href="#cb49-735" aria-hidden="true" tabindex="-1"></a>You can compare the previous model with one that has different slopes for different persons, which can be modelled by including an interaction with the categorical <span class="in">`Subject`</span> predictor. This is referred to as the *fixed-effects* model, as opposed to the *random-effects* model used to describe hierarchical models with partial pooling. Below is an example:</span>
<span id="cb49-736"><a href="#cb49-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-739"><a href="#cb49-739" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-740"><a href="#cb49-740" aria-hidden="true" tabindex="-1"></a>m4_fixed <span class="ot">&lt;-</span> <span class="fu">brm</span>(Reaction10 <span class="sc">~</span> Days <span class="sc">*</span> <span class="fu">I</span>(<span class="fu">factor</span>(Subject)),</span>
<span id="cb49-741"><a href="#cb49-741" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sleepstudy,</span>
<span id="cb49-742"><a href="#cb49-742" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>( <span class="co"># for intercept</span></span>
<span id="cb49-743"><a href="#cb49-743" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb49-744"><a href="#cb49-744" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for slope</span></span>
<span id="cb49-745"><a href="#cb49-745" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb49-746"><a href="#cb49-746" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for sigma</span></span>
<span id="cb49-747"><a href="#cb49-747" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb49-748"><a href="#cb49-748" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-749"><a href="#cb49-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">95</span>),</span>
<span id="cb49-750"><a href="#cb49-750" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2107</span>,</span>
<span id="cb49-751"><a href="#cb49-751" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"11_m4_fixed"</span></span>
<span id="cb49-752"><a href="#cb49-752" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-753"><a href="#cb49-753" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-754"><a href="#cb49-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-755"><a href="#cb49-755" aria-hidden="true" tabindex="-1"></a>You can compare the two models using LOO-IC:</span>
<span id="cb49-756"><a href="#cb49-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-759"><a href="#cb49-759" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-760"><a href="#cb49-760" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(m4, m4_fixed)</span>
<span id="cb49-761"><a href="#cb49-761" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-762"><a href="#cb49-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-763"><a href="#cb49-763" aria-hidden="true" tabindex="-1"></a>As you can see, in this case, the hierarchical approach yields a lower LOO (but there was a warning message, so be careful) and estimates fewer parameters. With more clusters and lower ICC, hierarchical models will have an even stronger advantage.</span>
<span id="cb49-764"><a href="#cb49-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-765"><a href="#cb49-765" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-766"><a href="#cb49-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-767"><a href="#cb49-767" aria-hidden="true" tabindex="-1"></a>So far, we have yet to talk about including person-level predictors. If such predictors are available, such as gender, we can use those to predict individual differences in intercepts (main effect) and slopes (i.e., interaction with <span class="in">`Days`</span>). Just add those predictors to the model by:</span>
<span id="cb49-768"><a href="#cb49-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-769"><a href="#cb49-769" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-770"><a href="#cb49-770" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-771"><a href="#cb49-771" aria-hidden="true" tabindex="-1"></a>  \begin{bmatrix}</span>
<span id="cb49-772"><a href="#cb49-772" aria-hidden="true" tabindex="-1"></a>    \beta_{0j} <span class="sc">\\</span></span>
<span id="cb49-773"><a href="#cb49-773" aria-hidden="true" tabindex="-1"></a>    \beta_{1j} <span class="sc">\\</span></span>
<span id="cb49-774"><a href="#cb49-774" aria-hidden="true" tabindex="-1"></a>  \end{bmatrix} &amp; \sim N_2\left(</span>
<span id="cb49-775"><a href="#cb49-775" aria-hidden="true" tabindex="-1"></a>  \begin{bmatrix}</span>
<span id="cb49-776"><a href="#cb49-776" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>}_j <span class="sc">\\</span></span>
<span id="cb49-777"><a href="#cb49-777" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">\beta_1</span><span class="co">]</span>}_j <span class="sc">\\</span></span>
<span id="cb49-778"><a href="#cb49-778" aria-hidden="true" tabindex="-1"></a>    \end{bmatrix}, \mathbf T</span>
<span id="cb49-779"><a href="#cb49-779" aria-hidden="true" tabindex="-1"></a>    \right)  <span class="sc">\\</span></span>
<span id="cb49-780"><a href="#cb49-780" aria-hidden="true" tabindex="-1"></a>  \mathbf T &amp; = \mathrm{diag}(\boldsymbol{\tau}) \boldsymbol{\Omega} \mathrm{diag}(\boldsymbol{\tau}) <span class="sc">\\</span></span>
<span id="cb49-781"><a href="#cb49-781" aria-hidden="true" tabindex="-1"></a>  \mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>}_j &amp; = \gamma_{00} + \gamma_{01} X_j <span class="sc">\\</span></span>
<span id="cb49-782"><a href="#cb49-782" aria-hidden="true" tabindex="-1"></a>  \mu^{<span class="co">[</span><span class="ot">\beta_1</span><span class="co">]</span>}_j &amp; = \gamma_{10} + \gamma_{11} X_j</span>
<span id="cb49-783"><a href="#cb49-783" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-784"><a href="#cb49-784" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-785"><a href="#cb49-785" aria-hidden="true" tabindex="-1"></a>where $X_j$ is a person-level predictor.</span>
<span id="cb49-786"><a href="#cb49-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-787"><a href="#cb49-787" aria-hidden="true" tabindex="-1"></a><span class="fu">### Varying $\sigma$</span></span>
<span id="cb49-788"><a href="#cb49-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-789"><a href="#cb49-789" aria-hidden="true" tabindex="-1"></a>Finally, you can also allow $\sigma$ to differ across individuals. This is typically used to relax the homogeneity of variance assumption, but recently, there has also been some interest in treating varying $\sigma$ as an important outcome. Examples include fluctuations in mood, as two people with the same mean level of mood may fluctuate very differently, and mood swing can be an important outcome to assess. There have been some interesting applications in health research using ecological momentary assessment data. For an overview, see the paper by @hedeker2008.</span>
<span id="cb49-790"><a href="#cb49-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-791"><a href="#cb49-791" aria-hidden="true" tabindex="-1"></a>Without going into the details, here is the model and the priors:</span>
<span id="cb49-792"><a href="#cb49-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-793"><a href="#cb49-793" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-794"><a href="#cb49-794" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb49-795"><a href="#cb49-795" aria-hidden="true" tabindex="-1"></a>\text{Repeated-measure level:}  <span class="sc">\\</span></span>
<span id="cb49-796"><a href="#cb49-796" aria-hidden="true" tabindex="-1"></a>  \text{Reaction10}_{ij} &amp; \sim N(\mu_{ij}, \sigma_j)  <span class="sc">\\</span></span>
<span id="cb49-797"><a href="#cb49-797" aria-hidden="true" tabindex="-1"></a>  \mu_{ij} &amp; = \beta_{0j} + \beta_{1j} \text{Days}_{ij}  <span class="sc">\\</span></span>
<span id="cb49-798"><a href="#cb49-798" aria-hidden="true" tabindex="-1"></a>\text{Person level:}  <span class="sc">\\</span></span>
<span id="cb49-799"><a href="#cb49-799" aria-hidden="true" tabindex="-1"></a>  \begin{bmatrix}</span>
<span id="cb49-800"><a href="#cb49-800" aria-hidden="true" tabindex="-1"></a>    \beta_{0j} <span class="sc">\\</span></span>
<span id="cb49-801"><a href="#cb49-801" aria-hidden="true" tabindex="-1"></a>    \beta_{1j} <span class="sc">\\</span></span>
<span id="cb49-802"><a href="#cb49-802" aria-hidden="true" tabindex="-1"></a>    \log(\sigma_j)</span>
<span id="cb49-803"><a href="#cb49-803" aria-hidden="true" tabindex="-1"></a>  \end{bmatrix} &amp; \sim N_2\left(</span>
<span id="cb49-804"><a href="#cb49-804" aria-hidden="true" tabindex="-1"></a>    \begin{bmatrix}</span>
<span id="cb49-805"><a href="#cb49-805" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>} <span class="sc">\\</span></span>
<span id="cb49-806"><a href="#cb49-806" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">\beta_1</span><span class="co">]</span>} <span class="sc">\\</span></span>
<span id="cb49-807"><a href="#cb49-807" aria-hidden="true" tabindex="-1"></a>      \mu^{<span class="co">[</span><span class="ot">s</span><span class="co">]</span>}</span>
<span id="cb49-808"><a href="#cb49-808" aria-hidden="true" tabindex="-1"></a>    \end{bmatrix}, \mathbf T</span>
<span id="cb49-809"><a href="#cb49-809" aria-hidden="true" tabindex="-1"></a>    \right)  <span class="sc">\\</span></span>
<span id="cb49-810"><a href="#cb49-810" aria-hidden="true" tabindex="-1"></a>  \mathbf T &amp; = \mathrm{diag}(\boldsymbol{\tau}) \boldsymbol{\Omega} \mathrm{diag}(\boldsymbol{\tau}) <span class="sc">\\</span></span>
<span id="cb49-811"><a href="#cb49-811" aria-hidden="true" tabindex="-1"></a>\text{Priors:}  <span class="sc">\\</span></span>
<span id="cb49-812"><a href="#cb49-812" aria-hidden="true" tabindex="-1"></a>  \mu^{<span class="co">[</span><span class="ot">\beta_0</span><span class="co">]</span>} &amp; \sim N(0, 50) <span class="sc">\\</span></span>
<span id="cb49-813"><a href="#cb49-813" aria-hidden="true" tabindex="-1"></a>  \mu^{<span class="co">[</span><span class="ot">\beta_1</span><span class="co">]</span>} &amp; \sim N(0, 10) <span class="sc">\\</span></span>
<span id="cb49-814"><a href="#cb49-814" aria-hidden="true" tabindex="-1"></a>  \mu^{<span class="co">[</span><span class="ot">s</span><span class="co">]</span>} &amp; \sim t^+(4, 0, 1.6) <span class="sc">\\</span></span>
<span id="cb49-815"><a href="#cb49-815" aria-hidden="true" tabindex="-1"></a>  \tau^{<span class="co">[</span><span class="ot">\beta_m</span><span class="co">]</span>} &amp; \sim \mathrm{Gamma}(2, 0.2), \; m = 0, 1 <span class="sc">\\</span></span>
<span id="cb49-816"><a href="#cb49-816" aria-hidden="true" tabindex="-1"></a>  \tau^{<span class="co">[</span><span class="ot">s</span><span class="co">]</span>} &amp; \sim \mathrm{Gamma}(2, 0.625) <span class="sc">\\</span></span>
<span id="cb49-817"><a href="#cb49-817" aria-hidden="true" tabindex="-1"></a>  \boldsymbol{\Omega} &amp; \sim \mathrm{LKJ}(1)</span>
<span id="cb49-818"><a href="#cb49-818" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb49-819"><a href="#cb49-819" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-820"><a href="#cb49-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-823"><a href="#cb49-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-824"><a href="#cb49-824" aria-hidden="true" tabindex="-1"></a><span class="co"># Use |p| to estimate the covariance between the sigma and beta random effects</span></span>
<span id="cb49-825"><a href="#cb49-825" aria-hidden="true" tabindex="-1"></a>m5 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb49-826"><a href="#cb49-826" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bf</span>(</span>
<span id="cb49-827"><a href="#cb49-827" aria-hidden="true" tabindex="-1"></a>        Reaction10 <span class="sc">~</span> Days <span class="sc">+</span> (Days <span class="sc">|</span> p <span class="sc">|</span> Subject),</span>
<span id="cb49-828"><a href="#cb49-828" aria-hidden="true" tabindex="-1"></a>        sigma <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">|</span> p <span class="sc">|</span> Subject)</span>
<span id="cb49-829"><a href="#cb49-829" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-830"><a href="#cb49-830" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sleepstudy,</span>
<span id="cb49-831"><a href="#cb49-831" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>( <span class="co"># for intercept</span></span>
<span id="cb49-832"><a href="#cb49-832" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb49-833"><a href="#cb49-833" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for slope</span></span>
<span id="cb49-834"><a href="#cb49-834" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb49-835"><a href="#cb49-835" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for tau_beta0</span></span>
<span id="cb49-836"><a href="#cb49-836" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.2</span>),</span>
<span id="cb49-837"><a href="#cb49-837" aria-hidden="true" tabindex="-1"></a>            <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>,</span>
<span id="cb49-838"><a href="#cb49-838" aria-hidden="true" tabindex="-1"></a>            <span class="at">group =</span> <span class="st">"Subject"</span></span>
<span id="cb49-839"><a href="#cb49-839" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb49-840"><a href="#cb49-840" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for tau_beta1</span></span>
<span id="cb49-841"><a href="#cb49-841" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.2</span>),</span>
<span id="cb49-842"><a href="#cb49-842" aria-hidden="true" tabindex="-1"></a>            <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">coef =</span> <span class="st">"Days"</span>,</span>
<span id="cb49-843"><a href="#cb49-843" aria-hidden="true" tabindex="-1"></a>            <span class="at">group =</span> <span class="st">"Subject"</span></span>
<span id="cb49-844"><a href="#cb49-844" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb49-845"><a href="#cb49-845" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for correlation</span></span>
<span id="cb49-846"><a href="#cb49-846" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"cor"</span>),</span>
<span id="cb49-847"><a href="#cb49-847" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for sigma</span></span>
<span id="cb49-848"><a href="#cb49-848" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="fl">1.6</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="at">dpar =</span> <span class="st">"sigma"</span>),</span>
<span id="cb49-849"><a href="#cb49-849" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for tau_sigma</span></span>
<span id="cb49-850"><a href="#cb49-850" aria-hidden="true" tabindex="-1"></a>        <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">2</span>, <span class="fl">0.625</span>),</span>
<span id="cb49-851"><a href="#cb49-851" aria-hidden="true" tabindex="-1"></a>            <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>,</span>
<span id="cb49-852"><a href="#cb49-852" aria-hidden="true" tabindex="-1"></a>            <span class="at">group =</span> <span class="st">"Subject"</span>, <span class="at">dpar =</span> <span class="st">"sigma"</span></span>
<span id="cb49-853"><a href="#cb49-853" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-854"><a href="#cb49-854" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-855"><a href="#cb49-855" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">95</span>),</span>
<span id="cb49-856"><a href="#cb49-856" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2107</span>,</span>
<span id="cb49-857"><a href="#cb49-857" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"11_m5"</span></span>
<span id="cb49-858"><a href="#cb49-858" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-859"><a href="#cb49-859" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-860"><a href="#cb49-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-863"><a href="#cb49-863" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-864"><a href="#cb49-864" aria-hidden="true" tabindex="-1"></a>m5</span>
<span id="cb49-865"><a href="#cb49-865" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-866"><a href="#cb49-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-867"><a href="#cb49-867" aria-hidden="true" tabindex="-1"></a>Here is the posterior predictive check:</span>
<span id="cb49-868"><a href="#cb49-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-871"><a href="#cb49-871" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-872"><a href="#cb49-872" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(m5, <span class="at">type =</span> <span class="st">"ribbon_grouped"</span>, <span class="at">group =</span> <span class="st">"Subject"</span>, <span class="at">x =</span> <span class="st">"Days"</span>,</span>
<span id="cb49-873"><a href="#cb49-873" aria-hidden="true" tabindex="-1"></a>         <span class="at">facet_args =</span> <span class="fu">list</span>(<span class="at">ncol =</span> <span class="dv">6</span>, <span class="at">scales =</span> <span class="st">"fixed"</span>))</span>
<span id="cb49-874"><a href="#cb49-874" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-875"><a href="#cb49-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-876"><a href="#cb49-876" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Comparisons</span></span>
<span id="cb49-877"><a href="#cb49-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-878"><a href="#cb49-878" aria-hidden="true" tabindex="-1"></a>We can compare the previous models from <span class="in">`m3`</span> to <span class="in">`m5`</span>, with <span class="in">`m3`</span> being the least complex and <span class="in">`m5`</span> being the most complex. However, it should be noted that, because of the way how STAN computes LOOIC and WAIC,</span>
<span id="cb49-879"><a href="#cb49-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-880"><a href="#cb49-880" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The LOOIC and WAIC computed in STAN (including </span><span class="in">`brms`</span><span class="at">) generally cannot be used to compare models with different level-2 predictors.</span></span>
<span id="cb49-881"><a href="#cb49-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-882"><a href="#cb49-882" aria-hidden="true" tabindex="-1"></a>The problem is illustrated in this blog post: <span class="ot">&lt;https://deepthoughtsandsilliness.blogspot.com/2007/12/focus-on-dic.html&gt;</span> in the context of DIC.</span>
<span id="cb49-883"><a href="#cb49-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-886"><a href="#cb49-886" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-887"><a href="#cb49-887" aria-hidden="true" tabindex="-1"></a><span class="fu">msummary</span>(</span>
<span id="cb49-888"><a href="#cb49-888" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb49-889"><a href="#cb49-889" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">Varying Intercepts</span><span class="st">`</span> <span class="ot">=</span> m3,</span>
<span id="cb49-890"><a href="#cb49-890" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">Varying Intercepts and Slopes</span><span class="st">`</span> <span class="ot">=</span> m4,</span>
<span id="cb49-891"><a href="#cb49-891" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">Varying Intercepts, Slopes, and Variances</span><span class="st">`</span> <span class="ot">=</span> m5</span>
<span id="cb49-892"><a href="#cb49-892" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-893"><a href="#cb49-893" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"WAIC"</span>, <span class="st">"LOOIC"</span>),</span>
<span id="cb49-894"><a href="#cb49-894" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="st">"{estimate} [{conf.low}, {conf.high}]"</span>,</span>
<span id="cb49-895"><a href="#cb49-895" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> effect <span class="sc">+</span> term <span class="sc">~</span> model,</span>
<span id="cb49-896"><a href="#cb49-896" aria-hidden="true" tabindex="-1"></a>    <span class="at">fmt =</span> <span class="dv">2</span></span>
<span id="cb49-897"><a href="#cb49-897" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-898"><a href="#cb49-898" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2024, Hok Chio (Mark) Lai</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>